<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitive Analysis - Locality</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Source+Sans+Pro:wght@400;600&family=Montserrat:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); min-height: 100vh; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; }

        /* Header */
        .header { text-align: center; margin-bottom: 30px; background: transparent; padding: 0; }
        .logo { height: 240px; width: auto; max-width: 800px; display: block; margin: 0 auto; }

        /* Back Button */
        .btn { background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; }

        /* Form Styles */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; }
        .required { color: #dc3545; }

        /* Analysis Form */
        .analysis-form { max-width: 600px; margin: 0 auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* Loading Styles */
        .loading-container { text-align: center; padding: 60px 20px; }
        .spinner { width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #0e192b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-text { color: #666; font-size: 1.1rem; margin-bottom: 10px; }
        .progress-subtext { color: #888; font-size: 0.9rem; }

        /* Results Table */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .results-title { color: #0e192b; font-size: 2rem; font-weight: 700; margin: 0; }
        .results-summary { color: #666; font-size: 1rem; }

        .competitive-table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .competitive-table th { background: #f8f9fa; padding: 15px 12px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; font-size: 0.9rem; }
        .competitive-table td { padding: 12px; border-bottom: 1px solid #f8f9fa; vertical-align: middle; font-size: 0.9rem; }
        .competitive-table tr:hover { background: #f8f9fa; }

        /* Business Info Column */
        .business-info { min-width: 250px; }
        .business-name { font-weight: 600; color: #0e192b; font-size: 1rem; margin-bottom: 4px; }
        .business-address { color: #666; font-size: 0.85rem; margin-bottom: 2px; }
        .business-phone { color: #666; font-size: 0.85rem; }

        /* Ranking Position */
        .rank-position { text-align: center; font-size: 1.5rem; font-weight: 700; color: #0e192b; min-width: 60px; }
        .rank-1 { color: #f39c12; }
        .rank-2 { color: #95a5a6; }
        .rank-3 { color: #cd7f32; }

        /* Score Display */
        .score-cell { text-align: center; min-width: 80px; }
        .score-badge { display: inline-block; padding: 8px 12px; border-radius: 6px; font-weight: 600; font-size: 0.9rem; min-width: 50px; text-align: center; }
        .score-excellent { background: #d4edda; color: #155724; }
        .score-good { background: #d1ecf1; color: #0c5460; }
        .score-fair { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }

        /* Opportunity Indicators */
        .opportunity-cell { text-align: center; min-width: 100px; }
        .opportunity-high { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .opportunity-medium { background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .opportunity-low { background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .opportunity-none { background: #e9ecef; color: #6c757d; padding: 6px 12px; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }

        /* Missing Factors */
        .missing-factors { font-size: 0.8rem; color: #666; max-width: 200px; }
        .factor-tag { display: inline-block; background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; margin: 1px; font-size: 0.7rem; }

        /* Reviews & Ratings */
        .review-info { text-align: center; min-width: 100px; }
        .rating-stars { color: #ffc107; margin-bottom: 2px; }
        .review-count { color: #666; font-size: 0.8rem; }

        /* Action Buttons */
        .action-cell { text-align: center; min-width: 120px; }
        .action-btn { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; margin: 2px; }
        .action-btn:hover { transform: translateY(-1px); }

        /* Filters */
        .filters-bar { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.85rem; font-weight: 600; color: #495057; margin-bottom: 5px; }
        .filter-group select { padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 0.9rem; }

        /* Legend */
        .legend { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .legend-title { font-weight: 600; color: #0e192b; margin-bottom: 15px; }
        .legend-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .legend-item { display: flex; align-items: center; gap: 10px; }
        .legend-sample { padding: 4px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 600; min-width: 80px; text-align: center; }

        /* Responsive */
        @media (max-width: 1200px) {
            .competitive-table { font-size: 0.8rem; }
            .competitive-table th, .competitive-table td { padding: 10px 8px; }
            .form-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .results-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .filters-bar { flex-direction: column; align-items: stretch; }
            .competitive-table { font-size: 0.75rem; }
            .business-info { min-width: 200px; }
        }

        /* Hidden class */
        .hidden { display: none; }

        /* Toast notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-warning { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="locality-logo.png" alt="Locality" class="logo">
        </div>

        <!-- Analysis Setup Form -->
        <div id="setupSection" class="card">
            <button class="btn btn-secondary" onclick="goBack()" style="width: auto; margin-bottom: 20px; padding: 8px 20px;">‚Üê BACK TO DASHBOARD</button>

            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Fast Competitive Analysis</h2>
            <p style="text-align: center; color: #666; margin-bottom: 40px; font-size: 1.1rem;">
                Quickly analyze up to 25 local businesses in your industry to identify ranking opportunities
            </p>

            <form id="analysisForm" class="analysis-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="industry">Industry/Service <span class="required">*</span></label>
                        <input type="text" id="industry" required placeholder="e.g., Carpet Cleaners, Plumbers, Dentists">
                    </div>
                    <div class="form-group">
                        <label for="location">Location <span class="required">*</span></label>
                        <input type="text" id="location" required placeholder="e.g., Las Vegas, NV">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="count">Number of Businesses</label>
                        <select id="count">
                            <option value="5">5 (5 Credits)</option>
                            <option value="10" selected>10 (10 Credits)</option>
                            <option value="15">15 (15 Credits)</option>
                            <option value="20">20 (20 Credits)</option>
                            <option value="25">25 (25 Credits)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="startFrom">Starting Position</label>
                        <select id="startFrom">
                            <option value="1">From #1</option>
                            <option value="6">From #6</option>
                            <option value="11">From #11</option>
                            <option value="16">From #16</option>
                            <option value="21">From #21</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn" style="font-size: 1.2rem; padding: 15px 40px;" id="submitBtn">
                         START FAST ANALYSIS (<span id="creditCost">10</span> Credits)
                    </button>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                        Fast mode: 3-5 minutes to complete (skips AI suggestions for speed)
                    </p>
                </div>
            </form>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="card hidden">
            <div class="loading-container">
                <div class="spinner"></div>
                <div class="progress-text" id="progressText">Initializing fast competitive analysis...</div>
                <div class="progress-subtext" id="progressSubtext">Analyzing businesses for ranking opportunities</div>

                <div style="margin-top: 30px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
                    <h4 style="color: #0e192b; margin-bottom: 15px;">Fast scan includes:</h4>
                    <ul style="color: #666; line-height: 1.6;">
                        <li>‚úì Google Business Profile data</li>
                        <li>‚úì Review quantity and ratings</li>
                        <li>‚úì Photo counts and categories</li>
                        <li>‚úì Citation checking (top 5 directories)</li>
                        <li>‚úì Social media presence</li>
                        <li>‚úì Q&As, posts, and engagement</li>
                        <li> Optimized for speed (no AI analysis)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="card hidden">
            <button class="btn btn-secondary" onclick="goBack()" style="width: auto; margin-bottom: 20px; padding: 8px 20px;">‚Üê BACK TO DASHBOARD</button>

            <div class="results-header">
                <div>
                    <h2 class="results-title" id="resultsTitle">Fast Competitive Analysis Results</h2>
                    <div class="results-summary" id="resultsSummary">Analysis completed</div>
                </div>
                <div>
                    <button class="btn" onclick="exportResults()"> Export to CSV</button>
                </div>
            </div>

            <!-- Legend -->
            <div class="legend">
                <div class="legend-title">Understanding Your Opportunities</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-sample opportunity-high">HIGH</div>
                        <span>Easy wins - significant ranking gaps with quick fixes</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-sample opportunity-medium">MEDIUM</div>
                        <span>Good potential - moderate effort, solid results</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-sample opportunity-low">LOW</div>
                        <span>Limited gains - strong competitors, minor improvements</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-sample opportunity-none">NONE</div>
                        <span>Well-optimized or extremely competitive</span>
                    </div>
                </div>
            </div>

            <!-- Compare Button (shown when 2 selected) -->
            <div id="compareBar" style="display: none; background: #17a2b8; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <span id="compareText">Select 2 businesses to compare</span>
                <button id="compareBtn" onclick="compareBusinesses()"
                        style="margin-left: 15px; padding: 8px 20px; background: white; color: #17a2b8; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: none;">
                    COMPARE SELECTED
                </button>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>üéØ Opportunity Level</label>
                    <select id="opportunityFilter" onchange="filterResults()">
                        <option value="all">All Opportunities</option>
                        <option value="high">üî• High Opportunity Only</option>
                        <option value="medium-high">Medium & High</option>
                        <option value="low-plus">Low & Above</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Ranking Position</label>
                    <select id="rankFilter" onchange="filterResults()">
                        <option value="all">All Positions</option>
                        <option value="top10">Top 10</option>
                        <option value="11-20">11-20</option>
                        <option value="21plus">21+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>8 Factors Score</label>
                    <select id="factorsFilter" onchange="filterResults()">
                        <option value="all">All Scores</option>
                        <option value="6-8">6-8 Factors</option>
                        <option value="4-5">4-5 Factors</option>
                        <option value="0-3">0-3 Factors</option>
                    </select>
                </div>
            </div>

            <!-- Results Table -->
            <div style="overflow-x: auto;">
                <table class="competitive-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Rank</th>
                            <th style="width: 250px;">Business Information</th>
                            <th style="width: 500px;">8 Key Factors</th>
                            <th style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Summary Stats -->
            <div id="summaryStats" style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <!-- Stats will be populated here -->
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparisonModal" class="modal hidden">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üîç Business Comparison</h2>
                <span class="close-modal" onclick="closeComparisonModal()">&times;</span>
            </div>
            <div id="comparisonContent" style="padding: 30px;">
                <div id="comparisonLoading" style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; color: #666;">Analyzing differences and generating insights...</p>
                </div>
                <div id="comparisonResults" style="display: none;">
                    <!-- Comparison results will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentResults = [];
        let filteredResults = [];
        let authToken = localStorage.getItem('authToken');
        let selectedBusinesses = [];

        // Check for stored bulk report data from dashboard
        window.addEventListener('DOMContentLoaded', function() {
            const storedReportData = localStorage.getItem('bulkReportData');
            if (storedReportData) {
                try {
                    const reportData = JSON.parse(storedReportData);
                    console.log('üìä Loading stored bulk report from dashboard');
                    localStorage.removeItem('bulkReportData'); // Clear after loading

                    // Display the stored report
                    displayStoredBulkReport(reportData);
                } catch (error) {
                    console.error('Error loading stored bulk report:', error);
                    showToast('Error loading report', 'error');
                }
            }
        });

        // Update credit cost when count changes
        document.getElementById('count').addEventListener('change', function() {
            const count = this.value;
            document.getElementById('creditCost').textContent = count;
        });

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Navigation functions
        function goBack() {
            window.location.href = '/';
        }

        function showSection(sectionId) {
            const sections = ['setupSection', 'loadingSection', 'resultsSection'];
            sections.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        // Form submission
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const industry = document.getElementById('industry').value;
            const location = document.getElementById('location').value;
            const count = parseInt(document.getElementById('count').value);
            const startFrom = parseInt(document.getElementById('startFrom').value);

            if (!industry || !location) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            if (!authToken) {
                showToast('Please log in to run analysis', 'error');
                setTimeout(() => window.location.href = '/', 2000);
                return;
            }

            startAnalysis(industry, location, count, startFrom);
        });

        // Start analysis
        async function startAnalysis(industry, location, count, startFrom) {
            showSection('loadingSection');

            // Update progress text
            const progressSteps = [
                "Finding businesses in the area...",
                "Collecting Google Business Profile data...",
                "Running parallel citation checks...",
                "Analyzing photos, reviews, and engagement...",
                "Taking website screenshots...",
                "Calculating competitive scores...",
                "Identifying ranking opportunities...",
                "Running Bulk Audit..."
            ];

            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < progressSteps.length) {
                    document.getElementById('progressText').textContent = progressSteps[currentStep];
                    currentStep++;
                }
            }, 3000);

            try {
                // Call our fast bulk scan API
                const response = await fetch('/api/generate-fast-bulk-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        industry,
                        location,
                        count,
                        startFrom
                    })
                });

                clearInterval(progressInterval);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                if (data.success) {
                    // First, map the basic data
                    const basicResults = data.businesses.map(business => ({
                        rank: business.ranking.position,
                        name: business.businessName,
                        address: business.data.business.address,
                        phone: business.data.business.phone,
                        website: business.data.business.website,
                        rating: business.data.reviews.rating,
                        reviews: business.data.reviews.total,
                        score: business.score,
                        coreMetrics: business.coreMetrics,
                        data: business.data
                    }));

                    // Calculate opportunity scores based on position relative to neighbors
                    currentResults = calculateOpportunityScores(basicResults);

                    showResults(industry, location, data);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }

            } catch (error) {
                clearInterval(progressInterval);
                console.error('Analysis error:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    response: error.response
                });

                // Show more detailed error message
                const errorMessage = error.message || 'Unknown error occurred';
                showToast(`Analysis failed: ${errorMessage}`, 'error');

                // Also log to page for visibility
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; max-width: 400px; z-index: 10000; font-size: 12px;';
                errorDiv.innerHTML = `<strong>Error Details:</strong><br>${errorMessage}<br><small>Check browser console for more info</small>`;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 10000);

                showSection('setupSection');
            }
        }

        // Calculate opportunity level based on score and ranking
        // Calculate opportunity scores for all businesses based on their position relative to neighbors
        function calculateOpportunityScores(businesses) {
            // Sort by rank to ensure correct neighbor analysis
            const sorted = [...businesses].sort((a, b) => a.rank - b.rank);

            return sorted.map((business, index) => {
                const factorsScore = get8FactorsScore(business);

                // Get neighbors (businesses directly above and below in ranking)
                const businessAbove = index > 0 ? sorted[index - 1] : null;
                const businessBelow = index < sorted.length - 1 ? sorted[index + 1] : null;

                let opportunityScore = 0;
                let opportunityReasons = [];

                // Check if business has lower score than those below (at risk)
                if (businessBelow) {
                    const belowScore = get8FactorsScore(businessBelow);
                    if (factorsScore < belowScore) {
                        opportunityScore += 3;
                        opportunityReasons.push(`At risk: #${businessBelow.rank} has higher score (${belowScore}/8)`);
                    }
                }

                // Check if business has similar/higher score than those above (opportunity to climb)
                if (businessAbove) {
                    const aboveScore = get8FactorsScore(businessAbove);
                    if (factorsScore >= aboveScore) {
                        opportunityScore += 2;
                        opportunityReasons.push(`Can climb: #${businessAbove.rank} has similar/lower score (${aboveScore}/8)`);
                    }
                }

                // Bonus: Low absolute score = more room for improvement
                if (factorsScore <= 4) {
                    opportunityScore += 2;
                    opportunityReasons.push(`Low score (${factorsScore}/8) = high improvement potential`);
                }

                // Check 2-3 positions for additional context
                const twoBelow = index < sorted.length - 2 ? sorted[index + 2] : null;
                if (twoBelow && factorsScore < get8FactorsScore(twoBelow)) {
                    opportunityScore += 1;
                    opportunityReasons.push(`Multiple competitors below with higher scores`);
                }

                // Determine opportunity level
                let opportunityLevel = 'none';
                if (opportunityScore >= 5) opportunityLevel = 'high';
                else if (opportunityScore >= 3) opportunityLevel = 'medium';
                else if (opportunityScore >= 1) opportunityLevel = 'low';

                return {
                    ...business,
                    opportunityScore,
                    opportunityLevel,
                    opportunityReasons,
                    factorsScore
                };
            });
        }

        // Display a stored bulk report from the database
        function displayStoredBulkReport(reportData) {
            console.log('üìä Displaying stored bulk report:', reportData);

            // Map the stored businesses data to currentResults format
            const basicResults = reportData.businesses.map(business => ({
                rank: business.ranking.position,
                name: business.businessName,
                address: business.data.business.address,
                phone: business.data.business.phone,
                website: business.data.business.website,
                rating: business.data.reviews.rating,
                reviews: business.data.reviews.total,
                score: business.score,
                coreMetrics: business.coreMetrics,
                data: business.data
            }));

            // Calculate opportunity scores based on position relative to neighbors
            currentResults = calculateOpportunityScores(basicResults);

            // Display using the existing showResults function
            const industry = reportData.searchCriteria.industry;
            const location = reportData.searchCriteria.location;
            showResults(industry, location, reportData);
        }

        // Show results
        function showResults(industry, location, data) {
            showSection('resultsSection');

            // Update title and summary
            document.getElementById('resultsTitle').textContent = `${industry} in ${location}`;
            document.getElementById('resultsSummary').textContent =
                `Found ${data.searchCriteria.totalScanned} businesses ‚Ä¢ ${data.scanSummary ? `Avg Score: ${data.scanSummary.averageScore}` : ''} ‚Ä¢ Fast scan mode`;

            // Set filtered results to all results initially, sorted by ranking
            filteredResults = [...currentResults].sort((a, b) => a.rank - b.rank);

            // Populate table and stats
            populateResultsTable();
            populateSummaryStats(data);

            showToast('Fast competitive analysis completed!', 'success');
        }

        // Populate results table
        function populateResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            filteredResults.forEach(result => {
                const row = document.createElement('tr');

                // Rank with special styling for top 3
                const rankClass = result.rank <= 3 ? `rank-${result.rank}` : '';

                // Opportunity highlighting - add background color based on level
                let rowStyle = '';
                let opportunityBadge = '';
                if (result.opportunityLevel === 'high') {
                    rowStyle = 'background-color: #fff3cd; border-left: 4px solid #ffc107;';
                    opportunityBadge = '<span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; margin-left: 8px;">üéØ HIGH OPPORTUNITY</span>';
                } else if (result.opportunityLevel === 'medium') {
                    rowStyle = 'background-color: #e7f3ff; border-left: 4px solid #17a2b8;';
                    opportunityBadge = '<span style="background: #17a2b8; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; margin-left: 8px;">MEDIUM</span>';
                } else if (result.opportunityLevel === 'low') {
                    rowStyle = 'border-left: 4px solid #e0e0e0;';
                }

                // Calculate score out of 8
                const metrics = result.coreMetrics;
                const checkmark = '‚úÖ';
                const xmark = '‚ùå';

                const factorsScore = [
                    metrics.meetsDescriptionReq,
                    metrics.meetsCategoriesReq,
                    metrics.meetsPhotosReq,
                    metrics.meetsReviewsReq,
                    metrics.meetsProductTilesReq,
                    metrics.meetsPostsReq,
                    metrics.meetsSocialReq,
                    metrics.meetsQAReq
                ].filter(Boolean).length;

                // 8 Factors display in 2x4 grid with score
                const eightFactorsHtml = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="text-align: center; min-width: 60px;">
                            <div style="font-size: 2rem; font-weight: 700; color: ${factorsScore >= 6 ? '#28a745' : factorsScore >= 4 ? '#ffc107' : '#dc3545'};">${factorsScore}</div>
                            <div style="font-size: 0.7rem; color: #666;">/ 8</div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; flex: 1; font-size: 0.8rem; line-height: 1.3;">
                            <div>${metrics.meetsDescriptionReq ? checkmark : xmark} Description</div>
                            <div>${metrics.meetsProductTilesReq ? checkmark : xmark} Products</div>
                            <div>${metrics.meetsCategoriesReq ? checkmark : xmark} Categories</div>
                            <div>${metrics.meetsPostsReq ? checkmark : xmark} Recent Posts</div>
                            <div>${metrics.meetsPhotosReq ? checkmark : xmark} Photos (${metrics.photosCount || 0})</div>
                            <div>${metrics.meetsSocialReq ? checkmark : xmark} Social Links</div>
                            <div>${metrics.meetsReviewsReq ? checkmark : xmark} Reviews (${metrics.reviewsCount || 0})</div>
                            <div>${metrics.meetsQAReq ? checkmark : xmark} Q&A</div>
                        </div>
                    </div>
                `;

                row.style.cssText = rowStyle;
                row.innerHTML = `
                    <td class="rank-position ${rankClass}">
                        <input type="checkbox" class="compare-checkbox" data-business-index="${filteredResults.indexOf(result)}"
                               style="margin-right: 8px; cursor: pointer;" onchange="handleCompareSelection(this)">
                        #${result.rank}
                    </td>
                    <td class="business-info">
                        <div class="business-name">
                            ${result.name}
                            ${opportunityBadge}
                        </div>
                        <div class="business-address" style="font-size: 0.85rem; color: #666;">${result.address || 'Address not available'}</div>
                        <div class="business-phone" style="font-size: 0.85rem; color: #666;">${result.phone || 'Phone not available'}</div>
                        ${result.website ? `<div style="font-size: 0.8rem; color: #17a2b8; margin-top: 4px;">${result.website}</div>` : ''}
                        ${result.opportunityReasons && result.opportunityReasons.length > 0 ?
                            `<div style="font-size: 0.75rem; color: #856404; margin-top: 6px; line-height: 1.4;">
                                ${result.opportunityReasons.map(r => `‚Ä¢ ${r}`).join('<br>')}
                            </div>` : ''}
                    </td>
                    <td style="padding: 15px;">${eightFactorsHtml}</td>
                    <td class="action-cell">
                        <button class="action-btn" onclick="viewFullAudit('${result.name}')" style="width: 100%;">View Details</button>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Populate summary stats
        function populateSummaryStats(data) {
            const statsContainer = document.getElementById('summaryStats');
            const scanSummary = data.scanSummary;

            if (scanSummary) {
                const highOpportunities = currentResults.filter(r => r.opportunityLevel === 'high').length;
                const mediumOpportunities = currentResults.filter(r => r.opportunityLevel === 'medium').length;
                const avgFactorsScore = Math.round(currentResults.reduce((sum, r) => sum + r.factorsScore, 0) / currentResults.length);

                statsContainer.innerHTML = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ffc107;">
                        <div style="font-size: 2rem; font-weight: 700; color: #856404;">üéØ ${highOpportunities}</div>
                        <div style="color: #856404; font-weight: 600;">High Opportunities</div>
                    </div>
                    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #17a2b8;">
                        <div style="font-size: 2rem; font-weight: 700; color: #17a2b8;">${mediumOpportunities}</div>
                        <div style="color: #17a2b8; font-weight: 600;">Medium Opportunities</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #0e192b;">${avgFactorsScore}/8</div>
                        <div style="color: #666;">Avg 8 Factors Score</div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: #17a2b8;">${data.searchCriteria.totalScanned}</div>
                        <div style="color: #666;">Total Analyzed</div>
                    </div>
                `;
            }
        }

        // Filter results
        function filterResults() {
            const opportunityFilter = document.getElementById('opportunityFilter').value;
            const rankFilter = document.getElementById('rankFilter').value;
            const factorsFilter = document.getElementById('factorsFilter').value;

            filteredResults = currentResults.filter(result => {
                // Calculate 8 factors score for this business
                const factorsScore = get8FactorsScore(result);

                // Opportunity filter
                if (opportunityFilter !== 'all') {
                    if (opportunityFilter === 'high' && result.opportunityLevel !== 'high') return false;
                    if (opportunityFilter === 'medium-high' && !['medium', 'high'].includes(result.opportunityLevel)) return false;
                    if (opportunityFilter === 'low-plus' && result.opportunityLevel === 'none') return false;
                }

                // 8 Factors filter
                if (factorsFilter !== 'all') {
                    if (factorsFilter === '6-8' && factorsScore < 6) return false;
                    if (factorsFilter === '4-5' && (factorsScore < 4 || factorsScore > 5)) return false;
                    if (factorsFilter === '0-3' && factorsScore > 3) return false;
                }

                // Rank filter
                if (rankFilter !== 'all') {
                    if (rankFilter === 'top10' && result.rank > 10) return false;
                    if (rankFilter === '11-20' && (result.rank < 11 || result.rank > 20)) return false;
                    if (rankFilter === '21plus' && result.rank < 21) return false;
                }

                return true;
            });

            // Sort by ranking position
            filteredResults.sort((a, b) => a.rank - b.rank);

            populateResultsTable();
        }

        // Action handlers
        function viewFullAudit(businessName) {
            showToast(`Generating full audit for ${businessName}...`, 'info');
            // In real implementation, this would redirect to full audit with prefilled data
            setTimeout(() => {
                window.location.href = `/?business=${encodeURIComponent(businessName)}`;
            }, 1000);
        }

        function exportResults() {
            if (filteredResults.length === 0) {
                showToast('No results to export', 'warning');
                return;
            }

            // Create CSV content with 8 Key Factors
            const headers = ['Rank', 'Business Name', 'Address', 'Phone', 'Website', 'Rating', 'Reviews', 'Score',
                             'Description‚úì', 'Categories‚úì', 'Photos‚úì', 'Reviews‚úì', 'Products‚úì', 'Posts‚úì', 'Social‚úì', 'Q&A‚úì', 'Opportunity'];
            const csvContent = [
                headers.join(','),
                ...filteredResults.map(result => {
                    const m = result.coreMetrics;
                    return [
                        result.rank,
                        `"${result.name}"`,
                        `"${result.address || ''}"`,
                        `"${result.phone || ''}"`,
                        `"${result.website || ''}"`,
                        result.rating,
                        result.reviews,
                        result.score,
                        m.meetsDescriptionReq ? 'YES' : 'NO',
                        m.meetsCategoriesReq ? 'YES' : 'NO',
                        m.meetsPhotosReq ? 'YES' : 'NO',
                        m.meetsReviewsReq ? 'YES' : 'NO',
                        m.meetsProductTilesReq ? 'YES' : 'NO',
                        m.meetsPostsReq ? 'YES' : 'NO',
                        m.meetsSocialReq ? 'YES' : 'NO',
                        m.meetsQAReq ? 'YES' : 'NO',
                        result.opportunity
                    ].join(',');
                })
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `competitive-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('Results exported to CSV!', 'success');
        }

        // Handle comparison checkbox selection
        function handleCompareSelection(checkbox) {
            const businessIndex = parseInt(checkbox.dataset.businessIndex);
            const business = filteredResults[businessIndex];

            if (checkbox.checked) {
                if (selectedBusinesses.length < 2) {
                    selectedBusinesses.push(business);
                } else {
                    checkbox.checked = false;
                    showToast('You can only compare 2 businesses at a time', 'warning');
                    return;
                }
            } else {
                selectedBusinesses = selectedBusinesses.filter(b => b.name !== business.name);
            }

            updateCompareBar();
        }

        function updateCompareBar() {
            const compareBar = document.getElementById('compareBar');
            const compareText = document.getElementById('compareText');
            const compareBtn = document.getElementById('compareBtn');

            if (selectedBusinesses.length === 0) {
                compareBar.style.display = 'none';
            } else if (selectedBusinesses.length === 1) {
                compareBar.style.display = 'block';
                compareText.textContent = `1 business selected. Select 1 more to compare.`;
                compareBtn.style.display = 'none';
            } else if (selectedBusinesses.length === 2) {
                compareBar.style.display = 'block';
                compareText.textContent = `Comparing: ${selectedBusinesses[0].name} vs ${selectedBusinesses[1].name}`;
                compareBtn.style.display = 'inline-block';
            }
        }

        async function compareBusinesses() {
            if (selectedBusinesses.length !== 2) {
                showToast('Please select exactly 2 businesses to compare', 'warning');
                return;
            }

            // Show modal
            document.getElementById('comparisonModal').classList.remove('hidden');
            document.getElementById('comparisonLoading').style.display = 'block';
            document.getElementById('comparisonResults').style.display = 'none';

            try {
                // Call backend to get AI comparison
                const response = await fetch('/api/compare-businesses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        business1: selectedBusinesses[0],
                        business2: selectedBusinesses[1]
                    })
                });

                if (!response.ok) {
                    throw new Error('Comparison failed');
                }

                const comparison = await response.json();
                displayComparison(comparison);

            } catch (error) {
                console.error('Comparison error:', error);
                showToast('Failed to generate comparison', 'error');
                closeComparisonModal();
            }
        }

        function displayComparison(comparison) {
            const resultsDiv = document.getElementById('comparisonResults');
            const b1 = selectedBusinesses[0];
            const b2 = selectedBusinesses[1];

            // Determine which is higher/lower ranked
            const higherRanked = b1.rank < b2.rank ? b1 : b2;
            const lowerRanked = b1.rank < b2.rank ? b2 : b1;

            resultsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Business 1 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #0e192b; margin-bottom: 15px;">üèÜ ${higherRanked.name}</h3>
                        <div style="margin-bottom: 10px;"><strong>Rank:</strong> #${higherRanked.rank}</div>
                        <div style="margin-bottom: 10px;"><strong>8 Factors Score:</strong> ${get8FactorsScore(higherRanked)}/8</div>
                        ${renderFactorsList(higherRanked.coreMetrics)}
                    </div>

                    <!-- Business 2 -->
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #0e192b; margin-bottom: 15px;">${lowerRanked.name}</h3>
                        <div style="margin-bottom: 10px;"><strong>Rank:</strong> #${lowerRanked.rank}</div>
                        <div style="margin-bottom: 10px;"><strong>8 Factors Score:</strong> ${get8FactorsScore(lowerRanked)}/8</div>
                        ${renderFactorsList(lowerRanked.coreMetrics)}
                    </div>
                </div>

                <div style="background: #e7f3ff; border-left: 4px solid #17a2b8; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #0e192b; margin-bottom: 15px;">ü§ñ AI Analysis</h3>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${comparison.aiAnalysis || 'Generating insights...'}</div>
                </div>

                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #856404; margin-bottom: 15px;">üí° Recommendations for ${lowerRanked.name}</h3>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${comparison.recommendations || 'Analyzing improvement opportunities...'}</div>
                </div>
            `;

            document.getElementById('comparisonLoading').style.display = 'none';
            resultsDiv.style.display = 'block';
        }

        function get8FactorsScore(business) {
            const m = business.coreMetrics;
            return [
                m.meetsDescriptionReq,
                m.meetsCategoriesReq,
                m.meetsPhotosReq,
                m.meetsReviewsReq,
                m.meetsProductTilesReq,
                m.meetsPostsReq,
                m.meetsSocialReq,
                m.meetsQAReq
            ].filter(Boolean).length;
        }

        function renderFactorsList(metrics) {
            const checkmark = '‚úÖ';
            const xmark = '‚ùå';
            return `
                <div style="font-size: 0.9rem; line-height: 1.8;">
                    <div>${metrics.meetsDescriptionReq ? checkmark : xmark} Description (150+ chars)</div>
                    <div>${metrics.meetsCategoriesReq ? checkmark : xmark} Categories (3+)</div>
                    <div>${metrics.meetsPhotosReq ? checkmark : xmark} Photos (10+)</div>
                    <div>${metrics.meetsReviewsReq ? checkmark : xmark} Reviews (15+, 4.0+ rating)</div>
                    <div>${metrics.meetsProductTilesReq ? checkmark : xmark} Product/Service Tiles (2+)</div>
                    <div>${metrics.meetsPostsReq ? checkmark : xmark} Recent Posts (within 15 days)</div>
                    <div>${metrics.meetsSocialReq ? checkmark : xmark} Social Links (2+)</div>
                    <div>${metrics.meetsQAReq ? checkmark : xmark} Q&A (2+ answered)</div>
                </div>
            `;
        }

        function closeComparisonModal() {
            document.getElementById('comparisonModal').classList.add('hidden');
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!authToken) {
                showToast('Please log in to access competitive analysis', 'error');
                setTimeout(() => window.location.href = '/', 3000);
            }
        });
    </script>
</body>
</html>