<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locality - Local SEO Audit Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Source+Sans+Pro:wght@400;600&family=Montserrat:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); min-height: 100vh; }
        
        /* Add top padding when email banner is present */
        body.has-email-banner { padding-top: 60px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: #333; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; background: transparent; padding: 0; }
        .dashboard-logo-header { text-align: left; margin-bottom: 0; background: transparent; padding: 0; display: flex; justify-content: flex-start; align-items: center; }
        
        /* Email Verification Banner - Yellow Warning Style */
        .email-verification-banner {
            background: #ffc107;
            color: #333;
            padding: 8px 20px;
            border-radius: 0;
            margin: 0 0 20px 0;
            border-left: 4px solid #e0a800;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .verification-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .verification-text {
            flex: 1;
        }
        .verification-text strong {
            display: block;
            margin-bottom: 2px;
            font-size: 0.95rem;
        }
        .verification-description {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        .resend-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
            border: 1px solid rgba(0, 0, 0, 0.2);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .resend-btn:hover {
            background: rgba(0, 0, 0, 0.15);
        }
        .banner-close-btn {
            background: transparent;
            border: none;
            color: #333;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .banner-close-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        /* Modern Pricing Modal Styles */
        .pricing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .pricing-modal-content {
            background: white;
            border-radius: 24px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
            font-family: 'Inter', sans-serif;
        }

        .pricing-modal-header {
            padding: 32px 40px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid #f1f5f9;
        }

        .pricing-modal .close-modal {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 40px;
            height: 40px;
            background: #f8fafc;
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            color: #64748b;
            transition: all 0.2s ease;
        }

        .pricing-modal .close-modal:hover {
            background: #e2e8f0;
            color: #334155;
            transform: scale(1.05);
        }

        .pricing-modal-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #061124;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .pricing-modal-subtitle {
            font-size: 18px;
            color: #64748b;
            font-weight: 500;
            line-height: 1.6;
        }

        .pricing-modal-body {
            padding: 40px;
        }

        .pricing-modal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            max-width: 900px;
            margin: 0 auto;
        }

        .pricing-modal-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 32px;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .pricing-modal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.1);
            border-color: #061124;
        }

        .pricing-modal-card.featured {
            border: 2px solid #061124;
            background: linear-gradient(135deg, #faf9f7 0%, #f5f3ef 100%);
            transform: scale(1.02);
            box-shadow: 0 20px 40px -8px rgba(6, 17, 36, 0.15);
        }

        .pricing-modal-card.featured:hover {
            transform: scale(1.02) translateY(-4px);
            box-shadow: 0 25px 50px -12px rgba(6, 17, 36, 0.25);
        }

        .pricing-modal-badge {
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #bfa76f 0%, #a08b4e 100%);
            color: white;
            padding: 8px 24px;
            border-radius: 0 0 12px 12px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .pricing-modal-card-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .pricing-modal-plan-name {
            font-family: 'Montserrat', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #061124;
            margin-bottom: 8px;
        }

        .pricing-modal-plan-description {
            font-size: 16px;
            color: #64748b;
            font-weight: 500;
        }

        .pricing-modal-price-container {
            text-align: center;
            margin: 24px 0;
        }

        .pricing-modal-price {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
            margin-bottom: 8px;
        }

        .pricing-modal-currency {
            font-size: 24px;
            font-weight: 600;
            color: #64748b;
        }

        .pricing-modal-amount {
            font-size: 48px;
            font-weight: 800;
            color: #061124;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }

        .pricing-modal-period {
            font-size: 18px;
            color: #64748b;
            font-weight: 600;
        }

        .pricing-modal-price-description {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .pricing-modal-features {
            margin: 24px 0;
        }

        .pricing-modal-includes {
            color: #475569;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .pricing-modal-features ul {
            list-style: none;
            padding: 0;
        }

        .pricing-modal-features li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 15px;
            color: #334155;
            line-height: 1.5;
        }

        .pricing-modal-checkmark {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #bfa76f 0%, #a08b4e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .pricing-modal-button {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin-top: 8px;
        }

        .pricing-modal-btn-primary {
            background: linear-gradient(135deg, #061124 0%, #0a1930 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(6, 17, 36, 0.3);
        }

        .pricing-modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(6, 17, 36, 0.4);
        }

        .pricing-modal-btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .pricing-modal-btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            transform: translateY(-2px);
        }

        .pricing-modal-trust {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin: 32px 0 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .pricing-modal-trust-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .pricing-modal-trust-icon {
            width: 16px;
            height: 16px;
            color: #bfa76f;
        }

        @media (max-width: 768px) {
            .pricing-modal-content {
                width: 98%;
                margin: 10px;
                border-radius: 16px;
            }

            .pricing-modal-header {
                padding: 24px 20px 16px;
            }

            .pricing-modal-title {
                font-size: 24px;
            }

            .pricing-modal-subtitle {
                font-size: 16px;
            }

            .pricing-modal-body {
                padding: 20px;
            }

            .pricing-modal-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .pricing-modal-card {
                padding: 24px;
            }

            .pricing-modal-card.featured {
                transform: none;
            }

            .pricing-modal-card.featured:hover {
                transform: translateY(-4px);
            }

            .pricing-modal-amount {
                font-size: 40px;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .pricing-subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        .header h1 { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .wide-card { max-width: 1000px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; }
        .required { color: #dc3545; }
        
        /* Custom Checkbox Styling */
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 0;
            position: relative;
            padding-left: 30px;
        }
        
        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        .checkmark {
            position: absolute;
            top: 2px;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #e1e5e9;
            border-radius: 4px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .checkbox-container:hover .checkmark {
            border-color: #0e192b;
            background-color: #f8f9fa;
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background-color: #0e192b;
            border-color: #0e192b;
        }
        
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        
        .checkbox-container input:focus ~ .checkmark {
            outline: 2px solid #0e192b;
            outline-offset: 2px;
        }
        .btn { background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .hidden { display: none !important; }

        /* Report form grid layout */
        #reportFormSection {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 40px;
            align-items: start;
        }
        .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; }
        .success { color: #155724; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; }
        .auth-switch { text-align: center; margin-top: 20px; color: #666; }
        .auth-switch a { color: #0e192b; text-decoration: none; font-weight: 600; cursor: pointer; }
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* Terms Checkbox - Standard Styling */
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            line-height: 1.5;
            font-size: 14px;
            color: #333;
            padding: 0;
            margin: 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px !important;
            height: 18px !important;
            margin: 0 !important;
            opacity: 1 !important;
            position: static !important;
            cursor: pointer;
            accent-color: #0e192b;
        }
        
        .checkmark {
            display: none !important;
        }
        
        .checkbox-container a {
            color: #0e192b;
            text-decoration: none;
            font-weight: 600;
        }
        
        .checkbox-container a:hover {
            text-decoration: underline;
        }
        
        /* Enhanced Dashboard - consolidated above */
        
        /* Account Menu */
        .account-menu {
            position: relative;
            display: inline-block;
        }

        .menu-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #374151;
        }

        .menu-trigger:hover {
            background: #f1f5f9;
            border-color: #d1d5db;
        }

        .menu-trigger.active {
            background: #061124;
            color: white;
            border-color: #061124;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: inherit;
            margin-bottom: 2px;
        }

        .credits-info {
            font-size: 12px;
            color: #6b7280;
        }

        .menu-trigger.active .credits-info {
            color: rgba(255, 255, 255, 0.8);
        }

        .menu-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: #9ca3af;
        }

        .menu-trigger.active .menu-arrow {
            transform: rotate(180deg);
            color: rgba(255, 255, 255, 0.8);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-header {
            padding: 20px 20px 16px;
            border-bottom: 1px solid #f3f4f6;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        }

        .menu-header h3 {
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #061124;
            margin-bottom: 4px;
        }

        .menu-header p {
            font-size: 14px;
            color: #6b7280;
        }

        /* Credits Display */
        .credits-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            margin: 16px 20px;
            border-radius: 10px;
            border: 1px solid #0ea5e9;
        }

        .credits-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .credits-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .credits-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 2px;
        }

        .credits-count {
            font-size: 24px;
            font-weight: 800;
            color: #0c4a6e;
            font-family: 'Montserrat', sans-serif;
        }

        /* Menu Items */
        .menu-items {
            padding: 8px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #f8fafc;
            color: #061124;
        }

        .menu-item-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .menu-item-text {
            flex: 1;
        }

        .menu-item-badge {
            background: #10b981;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .menu-item.pro-feature .menu-item-badge {
            background: #f59e0b;
        }

        /* Divider */
        .menu-divider {
            height: 1px;
            background: #f3f4f6;
            margin: 8px 0;
        }

        /* Purchase Button Special */
        .purchase-item {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            margin: 8px 8px 12px 8px;
            border-radius: 8px;
            font-weight: 600;
            width: calc(100% - 16px);
        }

        .purchase-item:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            transform: translateY(-1px);
        }
        
        /* Reports Table Styles */
        .reports-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .reports-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6; transition: background 0.2s ease; }
        .reports-table th:hover { background: #e9ecef; }
        .reports-table td { padding: 15px; border-bottom: 1px solid #f8f9fa; vertical-align: middle; white-space: nowrap; }
        .reports-table td:first-child { white-space: normal; }
        .reports-table td:last-child { white-space: nowrap; min-width: 180px; }
        .reports-table tr:hover { background: #f8f9fa; }
        .business-name { font-weight: 600; color: #0e192b; font-size: 1.1rem; }
        .business-location { color: #666; font-size: 0.9rem; margin-top: 2px; }
        .score-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; min-width: 80px; text-align: center; }
        /* Score display styling */
        .score-display { 
            font-weight: 600; 
            font-size: 1.1rem; 
            padding: 6px 12px; 
            border-radius: 6px; 
            text-align: center; 
            min-width: 60px; 
            display: inline-block; 
        }
        /* Table score display styling */
        .table-score-display { 
            font-weight: 600; 
            font-size: 1rem; 
            padding: 4px 10px; 
            border-radius: 6px; 
            text-align: center; 
            min-width: 60px; 
            display: inline-block; 
        }
        .score-good { background: #d4edda; color: #155724; }
        .score-fair { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }
        .score-neutral { background: #e9ecef; color: #495057; }
        
        /* Report action buttons - consistent styling */
        .report-action-btn { 
            background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.85rem; 
            margin-right: 8px; 
            min-width: 80px;
            display: inline-block;
            white-space: nowrap;
        }
        .report-action-btn:hover { 
            background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(44, 82, 130, 0.3); 
        }
        .report-action-btn:last-child { margin-right: 0; }
        
        /* Lock icon styling */
        .lock-icon {
            color: #dc3545;
            font-size: 0.8rem;
            margin-left: 5px;
            opacity: 0.8;
        }
        
        /* Unlock button specific styling */
        .report-action-btn.unlock-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .report-action-btn.unlock-btn:hover {
            background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        }
        
        /* Loading Progress */
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0e192b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { width: 100%; background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #0e192b, #1a2332); width: 0%; transition: width 0.5s ease; }
        .progress-text { text-align: center; margin-top: 15px; color: #666; font-size: 0.9rem; }
        
        /* Toast Notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-warning { background: #ffc107; color: #212529; }
        
        /* NEW REPORT DESIGN */
        .single-page-report { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Business Info Header */
        .business-info-header { background: white; padding: 20px 30px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
        .business-details { font-size: 0.9rem; color: #495057; line-height: 1.6; }
        .business-details strong { color: #0e192b; }
        .logo-container { flex-shrink: 0; }
        .logo-container a { display: inline-block; transition: opacity 0.3s ease; }
        .logo-container a:hover { opacity: 0.8; }
        
        /* Consistent logo sizing across all locations - doubled size */
        .logo,
        .header img[src*="logo"],
        .footer-logo img,
        img[src*="locality-logo"] {
            height: 240px;
            width: auto;
            max-width: 800px;
            display: block;
            background-color: transparent;
            border: none;
            outline: none;
            object-fit: contain;
        }
        
        /* Specific size for footer to be slightly smaller */
        .footer-logo img {
            height: 200px;
            max-width: 720px;
            margin: 0 auto;
        }
        
        /* Center dashboard logo */
        .header img {
            margin: 0 auto;
        }
        
        /* Updated Score Display - DONUT CHART - SIMPLIFIED */
        .score-donut-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 40px auto 30px;
        }

        .score-donut-container svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .donut-bg {
            fill: none;
            stroke: #f1f3f5;
            stroke-width: 12;
        }

        .donut-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke: #dc3545;
        }

        .score-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: flex;
            align-items: baseline;
            justify-content: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }

        .score-percentage {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 600;
            margin-left: 2px;
        }

        .score-message { color: #666; max-width: 600px; margin: 20px auto 0; font-size: 1.1rem; text-align: center; }

        /* Content Sections */
        .section { margin: 20px 30px; }
        .section-title { margin-bottom: 25px; color: #0e192b; font-size: 1.5rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }

        /* Grouped Factors Section */
        .factors-section {
            padding: 20px 0;
        }

        .factors-section h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            color: #061124;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Factor Group */
        .factor-group {
            margin-bottom: 40px;
        }

        .group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid;
        }

        .group-header.missing { border-color: #dc3545; }
        .group-header.needs-improvement { border-color: #ffc107; }
        .group-header.good { border-color: #28a745; }

        .group-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        .group-icon.missing { background: #dc3545; }
        .group-icon.needs-improvement { background: #ffc107; color: #212529; }
        .group-icon.good { background: #28a745; }

        .group-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #061124;
        }

        .group-count {
            margin-left: auto;
            background: #f8fafc;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #6b7280;
        }

        /* Factor Cards in Groups */
        .factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .factor-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .factor-card.missing { border-left-color: #dc3545; }
        .factor-card.needs-improvement { border-left-color: #ffc107; }
        .factor-card.good { border-left-color: #28a745; }

        .factor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .factor-card.expanded {
            grid-column: 1 / -1;
        }

        .factor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .factor-name {
            font-weight: 600;
            color: #061124;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }

        .factor-expand-arrow {
            color: #061124;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }

        .factor-card.expanded .factor-expand-arrow {
            transform: rotate(180deg);
        }

        .factor-message {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Expanded Content */
        .factor-expanded-content {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .factor-expanded-content.show {
            display: block;
        }

        /* Legacy Factors Grid - Keep for backward compatibility */
        .factors-compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .factor-item-compact { background: #f8f9fa; border-radius: 8px; padding: 15px; border-left: 4px solid #e9ecef; position: relative; cursor: pointer; transition: all 0.3s ease; }
        .factor-item-compact:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .factor-item-compact.expanded { grid-column: 1 / -1; max-width: none; cursor: default; transform: none; }
        .factor-item-compact.status-good { border-left-color: #28a745; }
        .factor-item-compact.status-needs-improvement { border-left-color: #ffc107; }
        .factor-item-compact.status-missing { border-left-color: #dc3545; }
        .factor-item-compact.status-uncertain { border-left-color: #6c757d; }

        .factor-header-compact { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .factor-status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-good { background: #d4edda; color: #155724; }
        .status-needs-improvement { background: #fff3cd; color: #856404; }
        .status-missing { background: #f8d7da; color: #721c24; }
        .status-uncertain { background: #e2e3e5; color: #495057; }
        
        .expanded-sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .expanded-section { background: transparent; padding: 0; border-radius: 0; border: none; }
        .expanded-section h4 { color: #0e192b; margin: 0 0 10px 0; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        .expanded-section p { color: #666; margin: 0; font-size: 0.9rem; line-height: 1.5; }
        .expanded-section a { color: #0e192b; text-decoration: none; font-weight: 600; }
        .expanded-section a:hover { text-decoration: underline; }
        
        .smart-suggestion-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 15px; }
        .smart-suggestion-section h4 { color: #0e192b; margin: 0 0 15px 0; font-size: 1rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .suggestion-textarea { width: 100%; height: 120px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.9rem; line-height: 1.5; resize: vertical; font-family: inherit; }
        .suggestion-actions { display: flex; gap: 10px; margin-top: 10px; }
        .copy-suggestion-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .copy-suggestion-btn:hover { background: #218838; transform: translateY(-1px); }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Citations Row */
        .citations-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .citation-item-simple { text-align: center; padding: 15px 10px; background: white; border-radius: 8px; border: 2px solid #e9ecef; }
        .citation-item-simple.found { border-color: #28a745; background: #f8fff8; }
        .citation-item-simple.missing { border-color: #dc3545; background: #fff8f8; }
        
        /* Compact Citations Row (for detailed analysis) */
        .citations-row-compact { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; margin-bottom: 4px; }
        .citation-item-compact { text-align: center; padding: 8px 6px; background: white; border-radius: 6px; border: 2px solid #dee2e6; }
        .citation-item-compact.found { border-color: #28a745; background: #f8fff8; }
        .citation-item-compact.missing { border-color: #dc3545; background: #fff8f8; }
        .citation-name-compact { font-size: 0.75rem; font-weight: 500; color: #333; line-height: 1.2; }
        /* Fix for detailed citation icons */
        .citation-item-compact .citation-icon { font-size: 1rem; color: #28a745; margin-top: 4px; }
        .citation-item-compact.missing .citation-icon { color: #dc3545; }
        .citation-logo { width: 32px; height: 32px; margin: 0 auto 8px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .citation-content { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
        .citation-name-simple { font-size: 0.8rem; font-weight: 600; color: #495057; flex: 1; text-align: left; }
        .citation-icon { font-size: 1.2rem; color: #28a745; margin-left: 8px; }
        .citation-item-simple.missing .citation-icon { color: #dc3545; }
        .order-citations-btn { background: #0e192b; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin: 20px auto; display: block; transition: all 0.3s ease; }
        .order-citations-btn:hover { background: #1a2332; transform: translateY(-2px); }

        /* Citation Order Modal */
        .citation-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); overflow-y: auto; }
        .citation-modal-content { background: white; margin: 5% auto; padding: 0; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3); max-height: 90vh; display: flex; flex-direction: column; }
        .citation-modal-header { background: #0e192b; color: white; padding: 20px; border-radius: 12px 12px 0 0; flex-shrink: 0; }
        .citation-modal-header h2 { margin: 0; font-size: 1.5rem; }
        .citation-modal-close { color: white; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .citation-modal-close:hover { color: #ccc; }
        .citation-modal-body { padding: 30px; overflow-y: auto; }
        .citation-package-option { border: 2px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s; }
        .citation-package-option:hover { border-color: #0e192b; background: #f8f9fa; }
        .citation-package-option.selected { border-color: #0e192b; background: #f0f4ff; }
        .citation-package-option input[type="radio"] { margin-right: 10px; }
        .citation-package-label { font-weight: 600; font-size: 1.1rem; margin-bottom: 5px; }
        .citation-package-price { color: #0e192b; font-size: 1.3rem; font-weight: bold; }
        .citation-package-details { color: #6c757d; font-size: 0.9rem; margin-top: 5px; }
        .citation-form-group { margin-bottom: 20px; }
        .citation-form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #495057; }
        .citation-form-group input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; }
        .citation-form-group input:focus { outline: none; border-color: #0e192b; }
        .citation-submit-btn { background: #0e192b; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-weight: 600; font-size: 1.1rem; cursor: pointer; width: 100%; transition: all 0.3s; }
        .citation-submit-btn:hover { background: #1a2332; }
        .citation-submit-btn:disabled { background: #6c757d; cursor: not-allowed; }
        
        /* Detailed Citation Analysis */
        .detailed-analysis-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef; }
        .citation-buttons-container { display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .detailed-analysis-btn { background: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; flex: 0 1 auto; }
        .detailed-analysis-btn:hover { background: #138496; transform: translateY(-2px); }
        .detailed-analysis-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .order-citations-cta-btn { background: #0e192b; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; flex: 0 1 auto; }
        .order-citations-cta-btn:hover { background: #1a2332; transform: translateY(-2px); }
        .detailed-analysis-subtext { text-align: center; color: #6c757d; font-size: 0.9rem; margin: 0 0 20px 0; }
        
        /* Detailed Results */
        .detailed-results-container { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .detailed-results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .detailed-results-header h4 { margin: 0; color: #0e192b; }
        .detailed-score { font-size: 1.2rem; font-weight: 700; color: #17a2b8; }
        .detailed-results-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; }
        .detailed-result-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; font-size: 0.85rem; }
        .detailed-result-item.found { background: #d4edda; color: #155724; }
        .detailed-result-item.missing { background: #f8d7da; color: #721c24; }
        .detailed-result-item.error { background: #fff3cd; color: #856404; }
        .detailed-result-name { font-weight: 500; }
        .detailed-result-status { font-size: 1rem; }
        
        /* Loading Spinner */
        .detailed-loading { text-align: center; padding: 40px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #e9ecef; border-top: 4px solid #17a2b8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .detailed-loading p { color: #6c757d; margin: 0; }
        
        /* Action Plan */
        .action-item-simple { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e9ecef; }
        .action-item-simple.completed { border-left-color: #28a745; background: #f8fff8; }
        .action-item-simple.incomplete { border-left-color: #dc3545; }
        .action-checkbox { width: 20px; height: 20px; border: 2px solid #dee2e6; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #28a745; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .action-checkbox:hover { border-color: #adb5bd; background: #f8f9fa; }
        .action-item-simple.completed .action-checkbox { background: #28a745; border-color: #28a745; color: white; }
        .action-item-simple.incomplete .action-checkbox { background: white; }
        .action-text { flex: 1; font-weight: 500; color: #495057; display: flex; justify-content: space-between; align-items: center; }
        .action-arrow { color: #0e192b; font-size: 0.8rem; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.3s ease; }
        .action-arrow:hover { background: #e9ecef; transform: translateY(-1px); }
        
        /* Upsell Section */
        .upsell-box { background: #0e192b; border-radius: 12px; padding: 30px; text-align: center; border: 2px solid #1a2332; }
        .upsell-title { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; color: white; margin-bottom: 15px; font-weight: 600; }
        .upsell-description { font-size: 1rem; color: white; margin-bottom: 20px; line-height: 1.6; }
        .upsell-cta { font-size: 1.1rem; color: white; font-weight: 600; }
        .upsell-link { color: #ffd700; text-decoration: underline; font-weight: 600; }
        .upsell-link:hover { color: white; text-decoration: none; }
        
        /* Footer Logo - centered */
        .footer-logo { 
            text-align: center; 
            padding: 15px; 
            border-top: 1px solid #e9ecef; 
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Report Actions */
        .report-actions { text-align: center; margin: 20px 0; padding: 20px; border-top: 1px solid #eee; }
        
        /* Print-specific styles for optimized PDF layout */
        @media print {
            body {
                font-size: 11px;
                line-height: 1.4;
                color: #2c3e50;
                background: white !important;
                margin: 0;
                padding: 15px;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .container {
                max-width: none;
                padding: 0;
                margin: 0;
            }

            /* Professional header with brand color */
            #reportSection {
                border-top: 6px solid #0e192b !important;
                padding-top: 10px !important;
            }
            
            /* Hide non-essential elements for print */
            .btn, .report-actions, .how-to-fix-btn, .view-details-btn,
            .copy-suggestion-btn, .order-citations-btn, .order-citations-cta-btn,
            .factor-expand-arrow, .action-arrow, .detailed-analysis-btn,
            .detailed-analysis-subtext, #detailedCitationSummary,
            #loginSection, #signupSection, #dashboardSection, #reportFormSection, #loadingSection {
                display: none !important;
            }
            
            /* Professional business header */
            .business-info-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-bottom: 3px solid #0e192b !important;
                flex-direction: row !important;
                text-align: left !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                border-radius: 8px !important;
            }

            .business-details {
                font-size: 11px !important;
                color: #2c3e50 !important;
                line-height: 1.6 !important;
            }

            .business-details > div {
                margin-bottom: 3px !important;
            }

            .business-details strong {
                color: #0e192b !important;
                font-weight: 700 !important;
            }

            .logo-container {
                margin-top: 0 !important;
                flex-shrink: 0 !important;
            }

            .logo {
                height: 50px !important;
                width: auto !important;
                max-width: 180px !important;
            }

            /* Section titles with color */
            .section-title {
                font-size: 13px !important;
                margin-bottom: 8px !important;
                color: #0e192b !important;
                font-weight: 700 !important;
                padding-bottom: 5px !important;
                border-bottom: 2px solid #17a2b8 !important;
            }

            /* Make sections stand out */
            .section {
                margin: 12px 0 !important;
                padding: 12px !important;
                border: 1px solid #e1e5e9 !important;
                border-radius: 8px !important;
                background: #fafbfc !important;
            }
            
            /* Page 1: Fit 12 audit points + score */
            .print-page-1 {
                page-break-after: auto;
                margin-bottom: 0;
            }
            
            /* Compact factors grid for page 1 */
            .factors-compact-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 8px !important;
                margin: 15px 0 !important;
            }
            
            .factor-card {
                padding: 10px !important;
                margin: 0 !important;
                font-size: 10px !important;
                border: 1px solid #e1e5e9 !important;
                border-radius: 6px !important;
                background: white !important;
            }

            /* Keep colored borders for factor cards */
            .factor-card.good {
                border-left: 4px solid #27ae60 !important;
                background: #f0f9f4 !important;
            }

            .factor-card.needs-improvement {
                border-left: 4px solid #f39c12 !important;
                background: #fef9f0 !important;
            }

            .factor-card.missing {
                border-left: 4px solid #e74c3c !important;
                background: #fef5f5 !important;
            }

            .factor-title {
                font-size: 11px !important;
                margin-bottom: 5px !important;
                font-weight: 600 !important;
                color: #2c3e50 !important;
            }

            .factor-status {
                font-size: 9px !important;
                padding: 3px 8px !important;
                border-radius: 4px !important;
                font-weight: 600 !important;
            }

            .factor-status.good {
                background: #27ae60 !important;
                color: white !important;
            }

            .factor-status.needs-improvement {
                background: #f39c12 !important;
                color: white !important;
            }

            .factor-status.missing {
                background: #e74c3c !important;
                color: white !important;
            }
            
            /* Score section compact with colors */
            .score-donut-container {
                width: 140px !important;
                height: 140px !important;
                margin: 15px auto !important;
                padding: 15px !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                border-radius: 12px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
            }

            .score-donut-container h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
                color: #0e192b !important;
                font-weight: 700 !important;
            }

            /* Keep donut chart colors */
            .donut-fill {
                stroke-width: 12 !important;
            }

            .score-number {
                color: #0e192b !important;
                font-weight: 800 !important;
            }

            .score-message {
                color: #495057 !important;
                font-weight: 600 !important;
            }
            
            /* Citations with professional styling */
            .citations-page-1 {
                display: block;
                page-break-inside: avoid;
            }

            .citations-page-2 {
                display: none;
                page-break-before: always;
                page-break-after: auto;
            }

            .citation-item-simple {
                border: 1px solid #e1e5e9 !important;
                border-radius: 6px !important;
                padding: 8px !important;
                background: white !important;
            }

            .citation-item-simple.found {
                border-left: 4px solid #27ae60 !important;
                background: #f0f9f4 !important;
            }

            .citation-item-simple.missing {
                border-left: 4px solid #e74c3c !important;
                background: #fef5f5 !important;
            }

            .citation-name-simple {
                color: #2c3e50 !important;
                font-weight: 600 !important;
            }

            /* When detailed analysis is run, move all citations to page 2 */
            .detailed-analysis-active .citations-page-1 {
                display: none !important;
            }

            .detailed-analysis-active .citations-page-2 {
                display: block !important;
            }

            /* Action plan with professional styling */
            .action-plan-section {
                page-break-before: always;
                margin-top: 0 !important;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
                padding: 20px !important;
                border-radius: 10px !important;
                border: 2px solid #0e192b !important;
            }

            .action-item {
                margin-bottom: 15px !important;
                padding: 12px !important;
                background: white !important;
                border-left: 4px solid #17a2b8 !important;
                border-radius: 6px !important;
                box-shadow: 0 2px 6px rgba(0,0,0,0.05) !important;
            }

            .action-item h4 {
                color: #0e192b !important;
                font-weight: 700 !important;
                margin-bottom: 8px !important;
            }

            .action-item p {
                color: #495057 !important;
                line-height: 1.6 !important;
            }
            
            /* Page 1: Score and Factors */
            .print-page-1 {
                page-break-after: auto;
                min-height: auto;
            }
            
            /* Sections - more compact for print */
            .print-page-1 .section,
            .section {
                margin: 6px 0 !important;
                padding: 4px !important;
            }

            .print-page-1 .section-title,
            .section-title {
                font-size: 12px !important;
                margin-bottom: 4px !important;
            }
            
            /* Simplified business header on page 1 */
            .business-info-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 15px 0;
                margin-bottom: 15px;
                border-bottom: 2px solid #e9ecef;
            }
            
            .business-details {
                font-size: 14px;
                color: #495057;
                line-height: 1.4;
            }
            
            .logo-container {
                flex-shrink: 0;
            }
            
            /* Score section - compact for print with working colors */
            .score-donut-container {
                width: 80px !important;
                height: 80px !important;
                margin: 8px auto !important;
            }

            .score-donut-container h3 {
                font-size: 12px !important;
                margin-bottom: 6px !important;
            }
            
            .donut-fill {
                /* Force the colors to show in print by removing animations */
                transition: none !important;
            }
            
            .donut-fill.score-0-59 { 
                stroke: #e74c3c !important; 
                stroke-dashoffset: 264 !important; /* 40% fill for visibility */
            }
            .donut-fill.score-60-69 { 
                stroke: #f39c12 !important; 
                stroke-dashoffset: 176 !important; /* 60% fill */
            }
            .donut-fill.score-70-79 { 
                stroke: #f1c40f !important; 
                stroke-dashoffset: 132 !important; /* 70% fill */
            }
            .donut-fill.score-80-89 { 
                stroke: #2ecc71 !important; 
                stroke-dashoffset: 88 !important; /* 80% fill */
            }
            .donut-fill.score-90-100 { 
                stroke: #27ae60 !important; 
                stroke-dashoffset: 44 !important; /* 90% fill */
            }
            
            .score-number {
                font-size: 18px !important;
            }

            .score-percentage {
                font-size: 8px !important;
            }

            .score-message {
                font-size: 9px !important;
                margin: 4px auto !important;
                max-width: 400px;
                text-align: center;
                line-height: 1.2 !important;
            }
            
            /* New Grouped Factors Section - Compact for Print */
            .factors-section {
                padding: 0 !important;
                margin: 8px 0 !important;
            }

            .factors-section h2 {
                display: none !important; /* Hide the main title to save space */
            }

            .factor-group {
                margin-bottom: 8px !important;
                page-break-inside: avoid;
            }

            .group-header {
                display: flex !important;
                align-items: center !important;
                gap: 4px !important;
                margin-bottom: 4px !important;
                padding-bottom: 2px !important;
                border-bottom: 1px solid !important;
            }

            .group-icon {
                width: 12px !important;
                height: 12px !important;
                font-size: 8px !important;
                line-height: 12px !important;
            }

            .group-title {
                font-size: 10px !important;
                font-weight: 700 !important;
            }

            .group-count {
                font-size: 7px !important;
                padding: 2px 4px !important;
                margin-left: auto !important;
            }

            .factors-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 3px !important;
            }

            .factor-card {
                padding: 3px 4px !important;
                margin: 0 !important;
                border-radius: 2px !important;
                background: #f8f9fa !important;
                border-left: 2px solid !important;
                page-break-inside: avoid !important;
            }

            .factor-card.missing { border-left-color: #dc3545 !important; }
            .factor-card.needs-improvement { border-left-color: #ffc107 !important; }
            .factor-card.good { border-left-color: #28a745 !important; }

            .factor-header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                margin-bottom: 2px !important;
            }

            .factor-name {
                font-size: 8px !important;
                font-weight: 600 !important;
                color: #0e192b !important;
                line-height: 1.1 !important;
            }

            .factor-message {
                font-size: 6px !important;
                color: #666 !important;
                line-height: 1.1 !important;
                margin: 0 !important;
            }

            /* Hide expanded content and arrows in print */
            .factor-expanded-content,
            .factor-expand-arrow {
                display: none !important;
            }

            /* Legacy factors grid - 2 columns for print to fit better and save space */
            .factors-compact-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4px;
                margin-top: 8px;
            }

            .factor-item-compact {
                padding: 4px 6px;
                margin-bottom: 0;
                border-radius: 3px;
                background: #f8f9fa !important;
                border-left: 3px solid #e9ecef;
                break-inside: avoid;
                font-size: 8px;
                page-break-inside: avoid;
            }

            .factor-item-compact.status-good { border-left-color: #28a745; }
            .factor-item-compact.status-needs-improvement { border-left-color: #ffc107; }
            .factor-item-compact.status-missing { border-left-color: #dc3545; }
            .factor-item-compact.status-uncertain { border-left-color: #6c757d; }

            .factor-header-compact {
                margin-bottom: 1px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .factor-status-badge {
                font-size: 6px;
                padding: 1px 3px;
                border-radius: 3px;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 12px;
                color: #0e192b !important;
                font-weight: 600;
            }
            
            /* Page 2: Action Plan and Upsell - HIDDEN IN PRINT */
            .print-page-2 {
                display: none !important;
            }
            
            .print-page-2 .section {
                margin: 15px 0;
                padding: 10px;
            }
            
            /* Citations section - more compact */
            .print-page-1 .citations-row,
            .citations-row {
                display: grid !important;
                grid-template-columns: repeat(7, 1fr) !important;
                gap: 2px !important;
                padding: 4px !important;
                background: #f8f9fa !important;
                border-radius: 3px !important;
                margin-bottom: 6px !important;
            }

            .print-page-1 .citation-item-simple,
            .citation-item-simple {
                text-align: center !important;
                padding: 2px 1px !important;
                background: white !important;
                border-radius: 2px !important;
                border: 1px solid #e9ecef !important;
            }
            
            .citation-item-simple.found { 
                border-color: #28a745; 
                background: #f8fff8 !important; 
            }
            
            .citation-item-simple.missing { 
                border-color: #dc3545; 
                background: #fff8f8 !important; 
            }
            
            .print-page-1 .citation-logo {
                width: 16px;
                height: 16px;
                margin: 0 auto 2px;
            }
            
            .print-page-1 .citation-icon {
                font-size: 10px;
                margin-bottom: 2px;
                font-weight: bold;
            }
            
            .print-page-1 .citation-name-simple,
            .citation-name-simple {
                font-size: 6px !important;
                font-weight: 600 !important;
                color: #495057 !important;
                line-height: 1.1 !important;
            }

            .citation-logo {
                width: 16px !important;
                height: 16px !important;
                margin: 0 auto 2px !important;
            }

            .citation-icon {
                font-size: 10px !important;
            }
            
            /* Action plan for print - more compact */
            .action-item-simple {
                padding: 6px 8px;
                margin-bottom: 3px;
                background: #f8f9fa !important;
                border-radius: 4px;
                border-left: 3px solid #e9ecef;
                break-inside: avoid;
            }
            
            .action-item-simple.completed { 
                border-left-color: #28a745; 
                background: #f8fff8 !important; 
            }
            
            .action-item-simple.incomplete { 
                border-left-color: #dc3545; 
            }
            
            .action-checkbox {
                width: 14px;
                height: 14px;
                border: 2px solid #dee2e6;
                border-radius: 2px;
                margin-right: 8px;
                font-size: 10px;
            }
            
            .action-text {
                font-size: 11px;
                color: #495057 !important;
                font-weight: 500;
            }
            
            /* Footer styling - just logo, bottom right */
            .footer-logo {
                position: absolute;
                bottom: 20px;
                right: 20px;
                background: none !important;
                border: none;
                padding: 0;
            }
            
            .footer-logo img {
                height: 160px;
                max-width: 600px;
            }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .dashboard-header { flex-direction: row; align-items: center; gap: 15px; }
            .dashboard-logo-header img { height: 45px !important; }
            .account-menu { margin-top: 0; }
            .dropdown-menu {
                right: 0;
                left: 0;
                min-width: auto;
                margin: 8px;
                width: calc(100% - 16px);
            }
            .reports-table { font-size: 0.9rem; }
            .reports-table th, .reports-table td { padding: 10px; }
            .factors-compact-grid { grid-template-columns: 1fr; }
            .factors-grid { grid-template-columns: 1fr; }
            .factors-section { padding: 24px; }
            .citations-row { grid-template-columns: repeat(5, 1fr); gap: 10px; }
            .citation-item-simple { padding: 10px 5px; }
            .citation-name-simple { font-size: 0.7rem; }
            .detailed-results-grid { grid-template-columns: repeat(5, 1fr); gap: 6px; }
            .detailed-result-item { padding: 6px 8px; font-size: 0.75rem; }

            /* Report form - stack on mobile */
            #reportFormSection {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
            #reportFormSection > div[style*="width: 400px"] {
                width: 100% !important;
            }
        }
        /* Upsell Box */
.upsell-box {
    background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    margin: 20px 0;
    box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
}

.upsell-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: white;
}

.upsell-description {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
    opacity: 0.95;
}

.upsell-cta {
    font-size: 1rem;
    margin: 0;
}

.upsell-link {
    color: #ffd700;
    text-decoration: none;
    font-weight: 600;
    border-bottom: 2px solid #ffd700;
    padding-bottom: 2px;
    transition: all 0.3s ease;
}

.upsell-link:hover {
    color: white;
    border-bottom-color: white;
    transform: translateY(-1px);
}

/* Style upsell box for print */
@media print {
    .upsell-box {
        background: #f8f9fa !important;
        border: 2px solid #0e192b !important;
        padding: 15px !important;
        margin: 20px 0 !important;
        page-break-inside: avoid;
    }
    
    .upsell-title {
        font-size: 14px !important;
        color: #0e192b !important;
        margin-bottom: 8px !important;
    }
    
    .upsell-description {
        font-size: 11px !important;
        color: #333 !important;
        margin-bottom: 8px !important;
    }
    
    .upsell-cta {
        font-size: 11px !important;
        color: #333 !important;
    }
    
    .upsell-link {
        color: #0e192b !important;
        text-decoration: underline !important;
    }
}

/* Feedback Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: block;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    color: #0e192b;
    font-size: 1.3rem;
    font-weight: 600;
}

.close-modal {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    transition: color 0.3s ease;
}

.close-modal:hover {
    color: #666;
}

.modal-content form {
    padding: 30px;
}

.star-rating {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.star {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.star.active ~ .star {
    color: #ddd;
}

.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    font-family: inherit;
    resize: vertical;
}

.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0e192b;
}

.form-group textarea {
    min-height: 120px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-content form {
        padding: 20px;
    }
    
    /* Mobile logo adjustments - scaled proportionally */
    .logo,
    .header img[src*="logo"],
    img[src*="locality-logo"] {
        height: 160px;
        max-width: 560px;
    }
    
    .footer-logo img {
        height: 140px;
        max-width: 500px;
    }
    
    .business-info-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .logo-container {
        margin-top: 15px;
    }
}

/* Locked Report Styles */
.report-locked-overlay {
    position: relative;
}

.report-locked-blur {
    filter: blur(4px);
    pointer-events: none;
    user-select: none;
}

.unlock-report-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid #0e192b;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    max-width: 400px;
    width: 90%;
}

.unlock-banner-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0e192b;
    margin-bottom: 15px;
    font-family: 'Montserrat', sans-serif;
}

.unlock-banner-subtitle {
    font-size: 1rem;
    color: #666;
    margin-bottom: 20px;
    padding: 10px 15px;
    background: #e7f3ff;
    border-radius: 8px;
    border-left: 4px solid #0066cc;
}

.unlock-btn {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
}

.unlock-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
    background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 100%);
}

.factors-locked {
    position: relative;
}

.factors-locked .factors-compact-grid {
    filter: blur(12px);
    pointer-events: none !important;
    user-select: none;
    opacity: 0.3;
}

/* Disable all clicks and interactions on locked factors */
.factors-locked .factor-card {
    pointer-events: none !important;
    cursor: default !important;
}

.factors-locked .factor-card:hover {
    transform: none !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* Hide all interactive elements in locked reports */
.report-section.locked .copy-suggestion-btn,
.report-section.locked .detailed-analysis-btn,
.report-section.locked .order-citations-btn,
.report-section.locked .order-citations-cta-btn,
.report-section.locked .action-item,
.report-section.locked .citation-item-simple {
    pointer-events: none !important;
    cursor: not-allowed !important;
}

/* Disable ALL clicking on locked reports */
.report-section.locked .factor-card,
.report-section.locked .factor-title,
.report-section.locked .factor-status {
    pointer-events: none !important;
    cursor: default !important;
}

/* Remove hover effects on locked factor cards */
.report-section.locked .factor-card:hover {
    transform: none !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

/* Stronger blur for locked content */
#reportSection.locked .factors-compact-grid,
#reportSection.locked #factorsGrid,
#reportSection.locked .factor-item-compact {
    filter: blur(4px);
    opacity: 0.5;
    pointer-events: none !important;
    user-select: none;
}

#reportSection.locked .citations-row,
#reportSection.locked #citationsSection,
#reportSection.locked .action-plan-section,
#reportSection.locked #actionPlanSection {
    filter: blur(4px);
    opacity: 0.5;
    pointer-events: none !important;
    user-select: none;
}

/* Profile Verification Styles */
.profile-option-card { 
    border: 2px solid #e9ecef; 
    border-radius: 10px; 
    padding: 20px; 
    margin: 15px 0; 
    cursor: pointer; 
    transition: all 0.3s ease; 
    background: white;
}
.profile-option-card:hover { 
    border-color: #17a2b8; 
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.1); 
    transform: translateY(-2px);
}
.profile-option-card.selected { 
    border-color: #0e192b; 
    background: #f8f9fa; 
    box-shadow: 0 4px 12px rgba(14, 25, 43, 0.15);
}
.profile-name { 
    font-size: 1.3rem; 
    font-weight: 600; 
    color: #0e192b; 
    margin-bottom: 8px; 
}
.profile-address { 
    color: #666; 
    font-size: 0.95rem; 
    margin-bottom: 8px; 
}
.profile-details { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 15px; 
    font-size: 0.9rem; 
    color: #666; 
}
.profile-detail-item { 
    display: flex; 
    align-items: center; 
    gap: 5px; 
}
.profile-status { 
    display: inline-block; 
    padding: 4px 8px; 
    border-radius: 15px; 
    font-size: 0.8rem; 
    font-weight: 600; 
}
.profile-status.verified { 
    background: #d4edda; 
    color: #155724; 
}
.profile-status.unverified { 
    background: #f8d7da; 
    color: #721c24; 
}
.verify-profile-btn { 
    background: #0e192b; 
    color: white; 
    border: none; 
    padding: 15px 30px; 
    border-radius: 8px; 
    font-weight: 600; 
    font-size: 1rem; 
    cursor: pointer; 
    margin: 20px auto; 
    display: block; 
    transition: all 0.3s ease; 
}
.verify-profile-btn:hover { 
    background: #1e2a3b; 
    transform: translateY(-2px); 
}
.verify-profile-btn:disabled { 
    background: #6c757d; 
    cursor: not-allowed; 
    transform: none; 
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginSection" class="card hidden">
            <div style="text-align: center; margin-bottom: 30px; display: flex; justify-content: center;">
                <img src="locality-logo.png" alt="Locality" style="height: 118px; width: auto;">
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Login to Your Account</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Your password">
                </div>
                <div style="text-align: right; margin-bottom: 15px;">
                    <a onclick="showForgotPassword()" style="color: #0e192b; font-size: 14px; cursor: pointer; text-decoration: none;">Forgot password?</a>
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="loginError" class="error hidden"></div>
            </form>
            <div class="auth-switch">
                Don't have an account? <a onclick="showSignup()">Sign up here</a>
            </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotPasswordSection" class="card hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Reset Your Password</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email Address</label>
                    <input type="email" id="resetEmail" required placeholder="your@email.com">
                </div>
                <button type="submit" class="btn">Send Reset Link</button>
                <div id="forgotPasswordMessage" class="hidden" style="margin-top: 15px;"></div>
            </form>
            <div class="auth-switch">
                Remember your password? <a onclick="showLogin()">Back to login</a>
            </div>
        </div>

        <!-- Signup Form -->
        <div id="signupSection" class="card hidden">
            <div style="text-align: center; margin-bottom: 30px; display: flex; justify-content: center;">
                <img src="locality-logo.png" alt="Locality" style="height: 118px; width: auto;">
            </div>
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Create Your Account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" required placeholder="John">
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" required placeholder="Smith">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" required placeholder="john@email.com">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required placeholder="Create a strong password">
                </div>
                <div class="form-group">
                    <label class="checkbox-container" for="termsAgreement">
                        <input type="checkbox" id="termsAgreement" required 
                               aria-describedby="terms-description"
                               aria-label="Agreement to Terms and Conditions and Privacy Policy">
                        <span id="terms-description">
                            I agree to the <a href="https://trylocality.com/terms-of-service/" target="_blank" rel="noopener noreferrer">Terms and Conditions</a> and <a href="https://trylocality.com/privacy-policy/" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
                        </span>
                    </label>
                </div>
                <button type="submit" class="btn">Create Account</button>
                <div id="signupError" class="error hidden"></div>
                <div id="signupSuccess" class="success hidden"></div>
            </form>
            <div class="auth-switch">
                Already have an account? <a onclick="showLogin()">Login here</a>
            </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div id="dashboardSection" class="card hidden" style="max-width: 1100px;">
            <!-- Email Verification Banner -->
            <div id="emailVerificationBanner" class="email-verification-banner hidden">
                <div class="verification-content">
                    <div class="verification-text">
                        <strong>Please verify your email address</strong>
                        <span class="verification-description">Check your inbox and click the verification link</span>
                    </div>
                    <button id="resendBtn" onclick="resendVerificationEmail()" class="resend-btn">
                        Resend Email
                    </button>
                    <button onclick="dismissVerificationBanner()" class="banner-close-btn" title="Dismiss notification">
                        
                    </button>
                </div>
            </div>

            <div class="dashboard-header">
                <!-- Logo on left -->
                <div class="dashboard-logo-header">
                    <img src="locality-logo.png" alt="Locality" style="height: 60px; width: auto;">
                </div>

                <!-- Account Menu on right -->
                <div class="account-menu">
                    <div class="menu-trigger" id="menuTrigger" onclick="toggleAccountMenu()">
                        <div class="user-info">
                            <div class="user-name" id="menuUserName">John Smith</div>
                            <div class="credits-info" id="menuPlanInfo">Pro Plan Active</div>
                        </div>
                        <div class="menu-arrow"></div>
                    </div>

                    <!-- Dropdown Menu -->
                    <div class="dropdown-menu" id="accountDropdownMenu">
                        <!-- Header -->
                        <div class="menu-header">
                            <h3>Account Overview</h3>
                            <p>Manage your Locality account</p>
                        </div>

                        <!-- Credits Display -->
                        <div class="credits-display">
                            <div class="credits-left">
                                <div class="credits-icon"></div>
                                <div class="credits-text">
                                    <h4>Audits Remaining</h4>
                                </div>
                            </div>
                            <div class="credits-count" id="menuCreditsCount">47</div>
                        </div>

                        <!-- Menu Items -->
                        <div class="menu-items">
                            <button class="menu-item purchase-item" onclick="handlePurchaseCredits()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Purchase More Audits</div>
                            </button>

                            <button class="menu-item" onclick="handleAppSumoRedeem()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Redeem AppSumo Code</div>
                            </button>

                            <div class="menu-divider"></div>

                            <button class="menu-item" onclick="handleAccountSettings()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Account Settings</div>
                            </button>

                            <button class="menu-item pro-feature" id="whiteLabelMenuItem" onclick="handleWhiteLabelSettings()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Brand Customization</div>
                                <div class="menu-item-badge">Pro</div>
                            </button>

                            <button class="menu-item" onclick="handleBillingHistory()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Billing History</div>
                            </button>

                            <button class="menu-item" onclick="handleSupportHelp()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Support & Help</div>
                            </button>

                            <button class="menu-item" onclick="handleDFYServices()">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">DFY SEO Services</div>
                            </button>

                            <div class="menu-divider"></div>

                            <button class="menu-item" onclick="handleLogout()" style="color: #dc2626;">
                                <div class="menu-item-icon"></div>
                                <div class="menu-item-text">Logout</div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome Message -->
            <div style="text-align: left; margin-bottom: 30px;">
                <h1 style="font-size: 2.5rem; color: #0e192b; margin-bottom: 10px; text-align: left;">Welcome, <span id="userName"></span></h1>
                <p style="color: #666; font-size: 1.1rem; text-align: left;">Your path to ranking higher starts here</p>
            </div>

            <!-- Main Generate Button -->
            <div style="text-align: center; margin-bottom: 50px;">
                <button class="btn" onclick="showReportForm()" style="
                    width: auto; 
                    padding: 20px 40px; 
                    font-size: 1.5rem; 
                    font-weight: bold; 
                    background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%);
                    box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
                    transform: scale(1);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                     Generate New Audit
                </button>

                <button class="btn" onclick="window.location.href='competitive-analysis.html'" style="
                    width: auto;
                    padding: 20px 40px;
                    font-size: 1.5rem;
                    font-weight: bold;
                    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
                    transform: scale(1);
                    transition: all 0.3s ease;
                    margin-top: 20px;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                     Competitive Analysis
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    Comprehensive 12-factor analysis with AI-powered suggestions
                </p>
            </div>

            <!-- Reports Tabs Section -->
            <div class="reports-table-section">
                <!-- Tab Navigation -->
                <div class="reports-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e1e5e9;">
                    <button class="report-tab active" onclick="switchReportTab('audits')" id="auditsTab" style="
                        padding: 12px 24px;
                        background: none;
                        border: none;
                        border-bottom: 3px solid #0e192b;
                        color: #0e192b;
                        font-size: 1.1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        Your Audits
                    </button>
                    <button class="report-tab" onclick="switchReportTab('competitive')" id="competitiveTab" style="
                        padding: 12px 24px;
                        background: none;
                        border: none;
                        border-bottom: 3px solid transparent;
                        color: #666;
                        font-size: 1.1rem;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        Your Competitive Analyses
                    </button>
                </div>

                <!-- Audits Table Container -->
                <div id="auditsTableContainer" class="tab-content">
                    <div class="no-reports" style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No audits yet</h4>
                        <p>Generate your first SEO audit to get started!</p>
                    </div>
                </div>

                <!-- Competitive Analyses Table Container -->
                <div id="competitiveTableContainer" class="tab-content hidden">
                    <div class="no-reports" style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No competitive analyses yet</h4>
                        <p>Run your first competitive analysis to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Form -->
        <div id="reportFormSection" class="hidden">
            <!-- Left Column: Form in white card -->
            <div class="card">
                <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Generate GBP Audit</h2>
                <form id="reportForm">
                    <div class="form-group">
                        <label for="businessName">Business Name <span class="required">*</span></label>
                        <input type="text" id="businessName" required placeholder="Exactly as shown on your Google Business Profile">
                    </div>
                    <div class="form-group">
                        <label for="location">Location <span class="required">*</span></label>
                        <input type="text" id="location" required placeholder="123 Main St, Miami, FL">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">
                             You can use city/state (Miami, FL), county/state (Utah County, UT), or full address
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="industry">Industry <span class="required">*</span></label>
                        <input type="text" id="industry" required placeholder="e.g., Accountant or House Cleaner">
                    </div>
                    <div class="form-group">
                        <label for="website">Website (Optional)</label>
                        <input type="url" id="website" placeholder="https://www.example.com">
                    </div>
                    <button type="submit" class="btn">Generate Audit (1 Credit)</button>
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="showDashboard(); return false;" style="color: #666; font-size: 0.9rem; text-decoration: none;">Return to dashboard</a>
                    </div>
                    <div id="reportError" class="error hidden"></div>
                </form>
            </div>

            <!-- Right Column: Example Image (outside white box) -->
            <div style="width: 400px;">
                <img src="locality-nap-example.png" alt="Google Business Profile Example" style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
        </div>


        <!-- Enhanced Loading Section -->
        <div id="loadingSection" class="card hidden">
            <div style="text-align: center; padding: 40px;">
                <h3>Generating Your Report...</h3>
                <p>This may take 2-3 minutes...</p>

                <div style="margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing audit...</div>
                </div>
            </div>
        </div>

        <!-- NEW SINGLE PAGE REPORT -->
        <div id="reportSection" class="single-page-report hidden">
            <!-- Page 1: Business Info, Score, and Factors -->
            <div class="print-page-1">
                <!-- Business Info Header with Logo in Top Right -->
                <div class="business-info-header">
                    <div class="business-details">
                        <div><strong>Business:</strong> <span id="reportBusinessName"></span></div>
                        <div><strong>Location:</strong> <span id="reportLocation"></span></div>
                        <div><strong>Date:</strong> <span id="reportDate"></span></div>
                        <div><strong>Prepared By:</strong> <span id="reportPreparedBy">Locality Marketing</span></div>
                        
                    </div>
                    <div class="logo-container">
                        <a href="#" onclick="showDashboard(); return false;" style="cursor: pointer;">
                            <img src="locality-logo.png" alt="Locality Marketing" class="logo" title="Back to Dashboard">
                        </a>
                    </div>
                </div>

                <!-- Score Donut Chart -->
                <div style="text-align: center;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: #0e192b; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;">Search Optimization Score</h3>
                    <div class="score-donut-container">
                        <svg viewBox="0 0 180 180">
                            <circle class="donut-bg" cx="90" cy="90" r="70"></circle>
                            <circle class="donut-fill" id="scoreDonut" cx="90" cy="90" r="70"></circle>
                        </svg>
                        <div class="score-display">
                            <div class="score-number" id="scoreNumber">0</div>
                            <div class="score-percentage">%</div>
                        </div>
                    </div>
                    <div class="score-message" id="scoreMessage"></div>
                </div>

                <!-- Factors Analysis -->
                <div class="section">
                    <div class="factors-section" id="factorsGrid"></div>
                </div>

                <!-- Citations Section -->
                <div class="section" id="citationsSection">
                    <h3 class="section-title" id="citationsSectionTitle">Local Citations Status</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 25px; font-size: 1.1rem; line-height: 1.5;">
                        Citations are mentions of your business across the web. They help search engines verify your business exists and boost your local search rankings.
                    </p>
                    
                    <!-- Citations for Page 1 (normal case: 10 citations) -->
                    <div class="citations-page-1" id="citationsPage1">
                        <div class="citations-row" id="citationsRow"></div>
                    </div>
                    
                    <!-- Citations for Page 2 (detailed analysis: all 50 citations) -->
                    <div class="citations-page-2" id="citationsPage2">
                        <div id="detailedCitationsContainer"></div>
                    </div>
                    
                    <!-- Detailed Citation Analysis Section -->
                    <div class="detailed-analysis-section">
                        <div class="citation-buttons-container">
                            <button class="detailed-analysis-btn" id="detailedAnalysisBtn" onclick="runDetailedCitationAnalysis()">
                                RUN DETAILED CITATION ANALYSIS
                            </button>
                            <button class="order-citations-cta-btn" onclick="orderCitations()">
                                ORDER CITATIONS
                            </button>
                        </div>
                        <p class="detailed-analysis-subtext">
                            We have a curated list of directories that can add SEO value. Run a report to see if you are listed.
                        </p>
                        
                        
                        <!-- Loading state -->
                        <div class="detailed-loading" id="detailedLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Scanning directories... This may take a moment.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Action Plan and Upsell -->
            <div class="print-page-2">


                <!-- Action Plan -->
                <div class="section">
                    <h3 class="section-title">Action Plan</h3>
                    <div id="actionPlanList"></div>
                </div>

<!-- Upsell Section -->
<div class="section">
    <div class="upsell-box">
        <h3 class="upsell-title">Let Locality Optimize For You!</h3>
        <p class="upsell-description">
            One of our SEO professionals will optimize your profile for you, ensuring a strong keyword presence, 
            a complete profile and a better chance of more leads, starting as low as $149!
        </p>
        <p class="upsell-cta">
            Interested? <a href="https://trylocality.com/get-found-online/" target="_blank" class="upsell-link">
                Click here to learn more!
            </a>
        </p>
    </div>
</div>
                <!-- Footer Logo - Bottom Right -->
                <div class="footer-logo">
                    <img src="locality-logo.png" alt="Locality Marketing">
                </div>
            </div>

            <!-- Report Actions -->
            <div class="report-actions">
                <button class="btn" onclick="downloadPDF()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Download PDF Report
                </button>
                <button class="btn" onclick="runCompetitiveAnalysis()" style="width: auto; padding: 12px 25px; margin-right: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    Competitive Analysis
                </button>
                <button class="btn" onclick="showReportForm()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Generate Another Report
                </button>
                <button class="btn" onclick="showDashboard()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Back to Dashboard
                </button>
                <button class="btn" onclick="showFeedbackForm()" style="width: auto; padding: 12px 25px;">
                    Share Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Your Feedback</h2>
                <span class="close-modal" onclick="closeFeedbackForm()">&times;</span>
            </div>
            <form id="feedbackForm">
                <div class="form-group">
                    <label>How would you rate your experience?</label>
                    <div class="star-rating">
                        <span class="star" data-rating="1"></span>
                        <span class="star" data-rating="2"></span>
                        <span class="star" data-rating="3"></span>
                        <span class="star" data-rating="4"></span>
                        <span class="star" data-rating="5"></span>
                    </div>
                    <input type="hidden" id="feedbackRating" name="rating" required>
                </div>
                
                <div class="form-group">
                    <label for="feedbackType">Type of Feedback <span class="required">*</span></label>
                    <select id="feedbackType" name="type" required>
                        <option value="general" selected>General</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="performance">Performance Issue</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="feedbackMessage">Your Feedback <span class="required">*</span></label>
                    <textarea id="feedbackMessage" name="message" rows="5" required placeholder="Please share your feedback here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="feedbackEmail">Email (Optional)</label>
                    <input type="email" id="feedbackEmail" name="email" placeholder="your@email.com">
                    <small style="color: #666; display: block; margin-top: 5px;">Provide your email if you'd like us to follow up with you</small>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Submit Feedback</button>
                <div id="feedbackError" class="error hidden"></div>
                <div id="feedbackSuccess" class="success hidden"></div>
            </form>
        </div>
    </div>

    <!-- AppSumo Redemption Modal -->
    <div id="appsumoModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Redeem AppSumo Code</h2>
                <span class="close-modal" onclick="closeAppSumoModal()">&times;</span>
            </div>
            <form id="appsumoForm" onsubmit="redeemAppSumoCode(event)">
                <div class="form-group">
                    <label for="appsumoCode">Enter Your AppSumo Code</label>
                    <input
                        type="text"
                        id="appsumoCode"
                        name="code"
                        placeholder="APPSUMO-XXXXXX"
                        required
                        style="text-transform: uppercase; font-family: monospace; font-size: 1.1rem; letter-spacing: 1px;"
                    >
                    <p style="color: #666; font-size: 0.9rem; margin-top: 8px;">
                        Enter the unique code you received from your AppSumo purchase
                    </p>
                </div>

                <div style="background: #f0f9ff; border: 1px solid #bae6fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h4 style="color: #0369a1; margin-top: 0;">What you'll get:</h4>
                    <ul style="color: #075985; margin-left: 20px;">
                        <li>Lifetime access to SEO audits</li>
                        <li>Monthly credit renewals (based on your tier)</li>
                        <li>No recurring payments - ever!</li>
                        <li>Priority support</li>
                    </ul>
                </div>

                <button type="submit" class="btn" style="width: 100%;">
                    Activate Lifetime Access
                </button>

                <div id="appsumoError" class="error hidden"></div>
                <div id="appsumoSuccess" class="success hidden"></div>
            </form>
        </div>
    </div>

    <!-- White Label Customization Modal -->
    <div id="whiteLabelModal" class="modal hidden">
        <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto; margin: 1% auto;">
            <div class="modal-header">
                <h2>White Label Customization</h2>
                <span class="close-modal" onclick="closeWhiteLabelModal()">&times;</span>
            </div>
            <div style="display: flex; gap: 30px; padding: 30px;">
                <!-- Left Side - Settings -->
                <div style="flex: 1;">
                    <form id="whiteLabelForm">
                        <!-- Company Info Section -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Company Information</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Company Name</label>
                                <input type="text" id="customBrandName" placeholder="Enter your company name" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Logo Upload</label>
                                <div style="border: 2px dashed #cbd5e1; border-radius: 8px; padding: 20px; text-align: center; background: #f8fafc;">
                                    <input type="file" id="logoUpload" accept="image/*" style="display: none;">
                                    <button type="button" onclick="document.getElementById('logoUpload').click()" style="background: #0e192b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                        Choose Logo File
                                    </button>
                                    <p style="margin: 10px 0 5px; color: #64748b; font-size: 0.9rem;">Or drag and drop your logo here</p>
                                    <p style="margin: 0; color: #94a3b8; font-size: 0.8rem;">Recommended: PNG or JPG, 300x100px or similar ratio</p>
                                    <div id="logoPreview" style="margin-top: 15px; display: none;">
                                        <img id="logoPreviewImg" style="max-height: 60px; border-radius: 4px;">
                                        <button type="button" onclick="removeLogo()" style="margin-left: 10px; background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem;">Remove</button>
                                    </div>
                                </div>
                                
                                <!-- Remove Logo Completely Option -->
                                <div style="margin-top: 15px;">
                                    <label style="display: flex; align-items: center; font-weight: 600; color: #333; cursor: pointer;">
                                        <input type="checkbox" id="removeLogo" name="removeLogo" style="margin-right: 12px; transform: scale(1.2);">
                                        Remove logo completely (no logo will appear on reports)
                                    </label>
                                    <p style="margin: 5px 0 0 24px; color: #64748b; font-size: 0.85rem;">Check this to remove any existing logo and display reports without a logo</p>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Contact Information</h3>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Contact Name</label>
                                    <input type="text" id="customContactName" placeholder="Your name" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Email Address</label>
                                    <input type="email" id="customContactEmail" placeholder="your@email.com" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Phone Number</label>
                                <input type="tel" id="customContactPhone" placeholder="(555) 123-4567" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>

                        <!-- Branding Section -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Brand Customization</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Primary Color</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" id="customPrimaryColor" value="#0e192b" style="width: 60px; height: 40px; border: 2px solid #e9ecef; border-radius: 8px; cursor: pointer;">
                                    <input type="text" id="customPrimaryColorText" value="#0e192b" placeholder="#0e192b" style="flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">"Prepared By" Text</label>
                                <input type="text" id="customPreparedBy" placeholder="e.g., Your Company Marketing" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>

                        <!-- Enable/Disable Toggle -->
                        <div style="margin-bottom: 30px; padding: 20px; background: #f1f5f9; border-radius: 8px;">
                            <label style="display: flex; align-items: center; font-weight: 600; color: #333; cursor: pointer;">
                                <input type="checkbox" id="whiteLabelEnabled" style="margin-right: 12px; transform: scale(1.2);">
                                Enable White Label Customization
                            </label>
                            <p style="margin: 10px 0 0; color: #64748b; font-size: 0.9rem;">When enabled, your custom branding will appear on all generated reports instead of Locality branding.</p>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" onclick="closeWhiteLabelModal()" style="padding: 12px 24px; border: 2px solid #e9ecef; background: white; color: #64748b; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" style="padding: 12px 24px; border: none; background: #0e192b; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Save & Apply
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Right Side - Live Preview -->
                <div style="flex: 1; border-left: 2px solid #e9ecef; padding-left: 30px;">
                    <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem;">Live Preview</h3>
                    
                    <div style="border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <!-- Preview Header -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
                            <div>
                                <h4 style="margin: 0; color: #333;">Sample Business Report</h4>
                                <p style="margin: 5px 0 0; color: #64748b; font-size: 0.9rem;">Local SEO Audit</p>
                            </div>
                            <div id="previewLogo" style="height: 40px; display: flex; align-items: center;">
                                <img src="locality-logo.png" alt="Logo" style="max-height: 100%; max-width: 120px;">
                            </div>
                        </div>
                        
                        <!-- Preview Content -->
                        <div style="margin-bottom: 20px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white;" id="previewScoreCircle">
                                85
                            </div>
                            <h4 style="text-align: center; margin: 0 0 10px; color: #333;">SEARCH OPTIMIZATION SCORE</h4>
                            <p style="text-align: center; color: #64748b; font-size: 0.9rem;">Your business shows strong local SEO performance</p>
                        </div>
                        
                        <!-- Preview Footer -->
                        <div style="border-top: 1px solid #e9ecef; padding-top: 15px; text-align: center;">
                            <p style="margin: 0; color: #64748b; font-size: 0.9rem;">
                                Prepared By: <span id="previewPreparedBy">Locality Marketing</span>
                            </p>
                            <div id="previewContact" style="margin-top: 10px; color: #64748b; font-size: 0.8rem; display: none;">
                                <p style="margin: 2px 0;" id="previewContactName"></p>
                                <p style="margin: 2px 0;" id="previewContactEmail"></p>
                                <p style="margin: 2px 0;" id="previewContactPhone"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="accountSettingsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px; width: 95%; margin: 2% auto; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Account Settings</h2>
                <span class="close-modal" onclick="closeAccountSettingsModal()">&times;</span>
            </div>
            <div style="padding: 30px;">
                <form id="accountSettingsForm">
                    <!-- Name Section -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Personal Information</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="settingsFirstName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                First Name (Display Name)
                            </label>
                            <input type="text" id="settingsFirstName" name="firstName" placeholder="Enter your first name" 
                                style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="settingsLastName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                Last Name
                            </label>
                            <input type="text" id="settingsLastName" name="lastName" placeholder="Enter your last name" 
                                style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                        </div>
                    </div>

                    <!-- Password Section -->
                    <div style="margin-bottom: 30px;">
                        <div onclick="togglePasswordSection()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">
                            <h3 style="margin: 0;">Change Password</h3>
                            <span id="passwordToggleArrow" style="font-size: 0.8rem; transition: transform 0.3s ease; color: #666;"></span>
                        </div>
                        
                        <div id="passwordFields" style="display: none;">
                            <div style="margin-bottom: 20px;">
                                <label for="currentPassword" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                    Current Password
                                </label>
                                <input type="password" id="currentPassword" name="currentPassword" placeholder="Enter current password" 
                                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="newPassword" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                    New Password
                                </label>
                                <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" 
                                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                                <small style="color: #666; display: block; margin-top: 5px;">Leave blank if you don't want to change your password</small>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label for="confirmPassword" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                                    Confirm New Password
                                </label>
                                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" 
                                    style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem;">
                            </div>
                        </div>
                    </div>

                    <!-- Plan Information -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #0e192b; margin-bottom: 20px; font-size: 1.2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 10px;">Account Information</h3>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="font-weight: 600; color: #333;">Current Plan:</span>
                            <span id="accountPlan" style="color: #0e192b; font-weight: 500;">Loading...</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <span style="font-weight: 600; color: #333;">Credits Remaining:</span>
                            <span id="accountCredits" style="color: #0e192b; font-weight: 500;">Loading...</span>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <span style="font-weight: 600; color: #333;">White Label Status:</span>
                            <span id="accountWhiteLabel" style="color: #0e192b; font-weight: 500;">Loading...</span>
                        </div>
                        
                        <!-- Manage Account Button -->
                        <div style="text-align: center; padding-top: 15px; border-top: 1px solid #e9ecef;">
                            <button type="button" onclick="handleManageAccount()" 
                                style="padding: 12px 24px; border: 2px solid #17a2b8; background: white; color: #17a2b8; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: 100%;"
                                onmouseover="this.style.background='#17a2b8'; this.style.color='white'; this.style.transform='translateY(-1px)'"
                                onmouseout="this.style.background='white'; this.style.color='#17a2b8'; this.style.transform='translateY(0)'">
                                 MANAGE PLAN & CREDITS
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button type="button" onclick="closeAccountSettingsModal()" 
                            style="padding: 12px 24px; border: 2px solid #e9ecef; background: white; color: #64748b; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" 
                            style="padding: 12px 24px; border: none; background: #0e192b; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Billing History Modal -->
    <div id="billingHistoryModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px; width: 95%; margin: 2% auto; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2> Billing History</h2>
                <span class="close-modal" onclick="closeBillingHistoryModal()">&times;</span>
            </div>
            <div style="padding: 30px;">
                <div id="billingHistoryContent">
                    <!-- Loading state -->
                    <div id="billingHistoryLoading" style="text-align: center; padding: 40px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                        <p style="color: #666;">Loading your billing history...</p>
                    </div>
                    
                    <!-- Empty state -->
                    <div id="billingHistoryEmpty" class="hidden" style="text-align: center; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 15px;"></div>
                        <h3 style="color: #0e192b; margin-bottom: 10px;">No Purchases Yet</h3>
                        <p style="color: #666; margin-bottom: 20px;">Your billing history will appear here after your first purchase.</p>
                        <button onclick="closeBillingHistoryModal(); showPricingModal();" 
                            style="padding: 12px 24px; background: #0e192b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Browse Plans
                        </button>
                    </div>
                    
                    <!-- Error state -->
                    <div id="billingHistoryError" class="hidden" style="text-align: center; padding: 40px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;"></div>
                        <h3 style="color: #dc3545; margin-bottom: 10px;">Unable to Load Billing History</h3>
                        <p style="color: #666; margin-bottom: 20px;">Please try again or contact support if the problem persists.</p>
                        <button onclick="loadBillingHistory()" 
                            style="padding: 12px 24px; background: #17a2b8; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                    
                    <!-- Billing history table -->
                    <div id="billingHistoryTable" class="hidden">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #0e192b; margin-bottom: 5px;">Purchase History</h3>
                            <p style="color: #666; font-size: 0.9rem;">All your purchases and subscription payments</p>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #e9ecef;">
                                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #0e192b;">Date</th>
                                        <th style="padding: 15px; text-align: left; font-weight: 600; color: #0e192b;">Plan</th>
                                        <th style="padding: 15px; text-align: center; font-weight: 600; color: #0e192b;">Credits</th>
                                        <th style="padding: 15px; text-align: right; font-weight: 600; color: #0e192b;">Amount</th>
                                        <th style="padding: 15px; text-align: center; font-weight: 600; color: #0e192b;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="billingHistoryTableBody">
                                    <!-- Payment rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Subscription Management -->
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; text-align: center;">
                            <p style="color: #856404; margin: 0; font-size: 0.95rem;">
                                Click here to 
                                <a href="#" onclick="showCancellationModal(); return false;" style="color: #dc3545; font-weight: 600; text-decoration: underline;">CANCEL</a> 
                                or 
                                <a href="#" onclick="closeBillingHistoryModal(); showPricingModal(); return false;" style="color: #28a745; font-weight: 600; text-decoration: underline;">UPGRADE</a>
                                your subscription
                            </p>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                            <h4 style="color: #0e192b; margin-bottom: 10px;"> Need Help?</h4>
                            <p style="color: #666; margin: 0; font-size: 0.9rem;">
                                For billing questions or refund requests, contact us at 
                                <a href="mailto:trylocality@gmail.com" style="color: #17a2b8; text-decoration: none;">trylocality@gmail.com</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancellation Modal -->
    <div id="cancellationModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2> Cancel Subscription</h2>
                <span class="close-modal" onclick="closeCancellationModal()">&times;</span>
            </div>
            <form id="cancellationForm">
                <div style="padding: 30px;">
                    <p style="color: #666; margin-bottom: 20px;">We're sorry to see you go! Please help us understand why you're canceling:</p>
                    
                    <div class="form-group">
                        <label for="cancellationReason">Why are you canceling? <span class="required">*</span></label>
                        <select id="cancellationReason" name="reason" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
                            <option value="">Select a reason...</option>
                            <option value="too-expensive">Too expensive</option>
                            <option value="not-using">Not using the service</option>
                            <option value="missing-features">Missing features I need</option>
                            <option value="found-alternative">Found a better alternative</option>
                            <option value="technical-issues">Too many technical issues</option>
                            <option value="other">Other reason</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cancellationFeedback">Additional feedback (optional)</label>
                        <textarea id="cancellationFeedback" name="feedback" rows="4" 
                            placeholder="Please share any additional feedback to help us improve..." 
                            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <p style="color: #856404; margin: 0; font-size: 0.9rem;">
                            <strong> Important:</strong> Canceling will immediately end your subscription. You will lose access to all premium features and any remaining credits.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeCancellationModal()" 
                            style="padding: 12px 24px; border: 1px solid #ddd; background: white; color: #333; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Keep Subscription
                        </button>
                        <button type="submit" 
                            style="padding: 12px 24px; border: none; background: #dc3545; color: white; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            CONFIRM CANCELLATION
                        </button>
                    </div>
                </div>
                <div id="cancellationError" class="error hidden" style="padding: 0 30px 20px;"></div>
            </form>
        </div>
    </div>

    <!-- Modern Pricing Modal -->
    <div id="pricingModal" class="pricing-modal hidden">
        <div class="pricing-modal-content">
            <!-- Header -->
            <div class="pricing-modal-header">
                <button class="close-modal" onclick="closePricingModal()"></button>
                <h2 class="pricing-modal-title">Choose Your Plan</h2>
                <p class="pricing-modal-subtitle">Get comprehensive local SEO analysis and boost your visibility</p>
            </div>

            <!-- Pricing Body -->
            <div class="pricing-modal-body">
                <div class="pricing-modal-grid">
                    <!-- Local Business Audit Card -->
                    <div class="pricing-modal-card">
                        <div class="pricing-modal-card-header">
                            <h3 class="pricing-modal-plan-name">Local Business Audit</h3>
                            <p class="pricing-modal-plan-description">Best for Small Business Owners with a Single Location</p>
                        </div>

                        <div class="pricing-modal-price-container">
                            <div class="pricing-modal-price">
                                <span class="pricing-modal-currency">$</span>
                                <span class="pricing-modal-amount">45</span>
                            </div>
                            <p class="pricing-modal-price-description">One-time purchase</p>
                        </div>

                        <div class="pricing-modal-features">
                            <ul>
                                <li><span class="pricing-modal-checkmark"></span> Complete 12-factor SEO analysis</li>
                                <li><span class="pricing-modal-checkmark"></span> Essential directory citation scan</li>
                                <li><span class="pricing-modal-checkmark"></span> AI-powered optimization suggestions</li>
                                <li><span class="pricing-modal-checkmark"></span> Actionable improvement roadmap</li>
                                <li><span class="pricing-modal-checkmark"></span> Professional PDF export</li>
                                <li><span class="pricing-modal-checkmark"></span> Access to training resources</li>
                            </ul>
                        </div>

                        <button class="pricing-modal-button pricing-modal-btn-secondary" onclick="purchaseSingleReportModal()">
                            Get Started
                        </button>
                    </div>

                    <!-- Pro Plan Card -->
                    <div class="pricing-modal-card featured">
                        <div class="pricing-modal-badge">Most Popular</div>
                        
                        <div class="pricing-modal-card-header">
                            <h3 class="pricing-modal-plan-name">Pro Plan</h3>
                            <p class="pricing-modal-plan-description">Best for Marketing Agencies and Multi-location businesses</p>
                        </div>

                        <div class="pricing-modal-price-container">
                            <div class="pricing-modal-price">
                                <span class="pricing-modal-currency">$</span>
                                <span class="pricing-modal-amount">99</span>
                                <span class="pricing-modal-period">/month</span>
                            </div>
                        </div>

                        <div class="pricing-modal-features">
                            <p class="pricing-modal-includes">Includes everything in the Local Business Audit plus:</p>
                            <ul>
                                <li><span class="pricing-modal-checkmark"></span> <strong>50 audits per month</strong></li>
                                <li><span class="pricing-modal-checkmark"></span> Custom branding & logo</li>
                                <li><span class="pricing-modal-checkmark"></span> Multi-location management</li>
                                <li><span class="pricing-modal-checkmark"></span> White-label PDF reports</li>
                                <li><span class="pricing-modal-checkmark"></span> Priority customer support</li>
                            </ul>
                        </div>

                        <button class="pricing-modal-button pricing-modal-btn-primary" onclick="subscribePlanModal('pro')">
                            Get Started
                        </button>
                    </div>
                </div>

                <!-- Trust Indicators -->
                <div class="pricing-modal-trust">
                    <div class="pricing-modal-trust-item">
                        <svg class="pricing-modal-trust-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                        Secure Payment
                    </div>
                    <div class="pricing-modal-trust-item">
                        <svg class="pricing-modal-trust-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        30-Day Guarantee
                    </div>
                    <div class="pricing-modal-trust-item">
                        <svg class="pricing-modal-trust-icon" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Cancel Anytime
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let currentReportData = null;
        let userReports = [];
        let currentSortColumn = 'date'; // Default sort by date
        let currentSortDirection = 'desc'; // Most recent first
        
        // Clear report state function
        function clearReportState() {
            console.log(' Clearing report state...');
            currentReportData = null;
            
            // Remove any unlock overlay that might be showing
            const unlockOverlay = document.getElementById('unlockReportOverlay');
            if (unlockOverlay) {
                unlockOverlay.remove();
                console.log(' Removed unlock overlay during state clear');
            }
            
            // Remove locked class from report section
            const reportSection = document.getElementById('reportSection');
            if (reportSection) {
                reportSection.classList.remove('locked');
            }
            
            // Clear report elements with null checks
            const reportBusinessName = document.getElementById('reportBusinessName');
            if (reportBusinessName) reportBusinessName.textContent = '';
            
            const reportLocation = document.getElementById('reportLocation');
            if (reportLocation) reportLocation.textContent = '';
            
            const reportDate = document.getElementById('reportDate');
            if (reportDate) reportDate.textContent = '';
            
            const scoreNumber = document.getElementById('scoreNumber');
            if (scoreNumber) scoreNumber.textContent = '0';
            
            const scoreMessage = document.getElementById('scoreMessage');
            if (scoreMessage) scoreMessage.textContent = '';
            
            // Clear factors grid
            const factorsGrid = document.getElementById('factorsGrid');
            if (factorsGrid) factorsGrid.innerHTML = '';
            
            // Clear citations row
            const citationsRow = document.getElementById('citationsRow');
            if (citationsRow) citationsRow.innerHTML = '';
            
            // Clear action plan
            const actionPlanList = document.getElementById('actionPlanList');
            if (actionPlanList) actionPlanList.innerHTML = '';
            
            // Reset donut chart
            const scoreDonut = document.getElementById('scoreDonut');
            if (scoreDonut) {
                scoreDonut.style.strokeDashoffset = '440';
                scoreDonut.style.stroke = '#e9ecef';
            }
        }

        // Directory logos mapping
        const directoryLogos = {
            'Yelp': 'Directory Logos/Yelp.png',
            'Better Business Bureau': 'Directory Logos/BBB.png',
            'Yellow Pages': 'Directory Logos/YellowPages.png',
            'Apple Maps': 'Directory Logos/Apple-Maps.png',
            'Apple Maps Business Connect': 'Directory Logos/Apple-Maps.png',
            'Facebook': 'Directory Logos/Facebook.png',
            'Facebook Business': 'Directory Logos/Facebook.png',
            'Foursquare': 'Directory Logos/Foursquare.png',
            'Bing Maps': 'Directory Logos/Bing-Maps.png',
            'Bing Places': 'Directory Logos/Bing-Maps.png',
            'Angi': 'Directory Logos/Angi.png',
            'Chamber of Commerce': 'Directory Logos/Chamberofcommerce.png',
            'DNB (Dun & Bradstreet)': 'Directory Logos/DNB.png',
            'DNB': 'Directory Logos/DNB.png',
            'Nextdoor': 'Directory Logos/nextdoor.png'
        };
        
        // Directory name display mapping
        const directoryDisplayNames = {
            'Apple Maps Business Connect': 'Apple Maps',
            'DNB (Dun & Bradstreet)': 'DNB',
            'Bing Places': 'Bing Maps'
        };

        // Progress simulation steps
        const progressSteps = [
            { percent: 15, text: 'Finding business profile...' },
            { percent: 30, text: 'Scanning SEO elements...' },
            { percent: 45, text: 'Analyzing profile with AI...' },
            { percent: 60, text: 'Checking local citations...' },
            { percent: 75, text: 'Evaluating website presence...' },
            { percent: 85, text: 'Generating recommendations...' },
            { percent: 95, text: 'Calculating SEO score...' },
            { percent: 100, text: 'Finalizing report...' }
        ];

       window.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log(' Locality App starting...');
        
        // Check for payment success
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            // If this tab was opened by Stripe checkout, notify the original tab and close
            if (window.opener && !window.opener.closed) {
                try {
                    window.opener.postMessage('payment_success', '*');
                    console.log(' Payment success message sent to original tab');
                    window.close();
                    return; // Exit early since we're closing this tab
                } catch (error) {
                    console.error(' Failed to communicate with original tab:', error);
                    // Fall back to normal success handling if communication fails
                }
            }
            
            // Normal success handling for cases where we can't close the tab
            showToast('Payment successful! Your credits have been added.', 'success');
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            // Refresh user data to show new credits
            if (authToken) {
                await checkAuth();
                
                // If we were purchasing from unlock modal, automatically unlock the report
                if (isPurchasingFromUnlockModal && currentReportData && currentReportData.reportId) {
                    console.log(' Auto-unlocking report after payment from unlock modal (direct return)');
                    isPurchasingFromUnlockModal = false; // Reset flag
                    
                    // Show the report section with the unlocked report
                    hideAllSections();
                    document.getElementById('reportSection').classList.remove('hidden');
                    
                    // Wait a moment for everything to load
                    setTimeout(() => {
                        unlockCurrentReport();
                    }, 500);
                }
            }
        }
        
        // Clear any stale report data on page load
        try {
            clearReportState();
        } catch (clearError) {
            console.error('Error clearing report state:', clearError);
        }
        
        // Ensure report section is hidden on page load
        const reportSection = document.getElementById('reportSection');
        if (reportSection) {
            reportSection.classList.add('hidden');
        }
        
        // Check if user is already logged in
        console.log(' Page load - Auth token exists:', !!authToken);
        if (authToken) {
            console.log(' Checking authentication...');
            try {
                await checkAuth();
                showDashboard(); // Explicitly show dashboard on initial load
            } catch (authError) {
                console.error(' Auth check failed, showing login:', authError);
                showLogin();
            }
        } else {
            console.log(' No auth token, showing login...');
            showLogin();
        }
        
        // Safety check: ensure at least one section is visible after 2 seconds
        setTimeout(() => {
            const visibleSections = ['loginSection', 'signupSection', 'forgotPasswordSection', 'dashboardSection', 'reportFormSection', 'loadingSection', 'reportSection']
                .filter(id => {
                    const element = document.getElementById(id);
                    return element && !element.classList.contains('hidden');
                });
            
            if (visibleSections.length === 0) {
                console.warn(' No sections visible after initialization, forcing login display');
                showLogin();
            }
        }, 2000);
        
        // Listen for payment success messages from Stripe checkout tab
        window.addEventListener('message', async (event) => {
            console.log(' Received message:', event.data, 'from:', event.origin);
            
            if (event.data === 'payment_success') {
                console.log(' Payment success message received from Stripe tab');
                showToast('Payment successful! Your credits have been added.', 'success');
                
                // Refresh user data to show new credits
                if (authToken) {
                    console.log(' Refreshing user data after payment success');
                    await checkAuth();
                    
                    // If we were purchasing from unlock modal, automatically unlock the report
                    if (isPurchasingFromUnlockModal && currentReportData && currentReportData.reportId) {
                        console.log(' Auto-unlocking report after payment from unlock modal');
                        isPurchasingFromUnlockModal = false; // Reset flag
                        
                        // Close pricing modal first
                        closePricingModal();
                        
                        // Wait a moment for UI to update
                        setTimeout(() => {
                            unlockCurrentReport();
                        }, 500);
                    }
                } else {
                    console.warn(' No auth token available for refresh');
                }
            }
        });
        
    } catch (error) {
        console.error(' Critical initialization error:', error);
        // Try to at least show login screen
        try {
            showLogin();
        } catch (loginError) {
            console.error(' Failed to show login:', loginError);
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>Something went wrong</h1><p>Please refresh the page or contact support.</p></div>';
        }
    }
});
        // Get dynamic summary based on status
        function getDynamicSummary(factorId, status) {
            const summaries = {
                'description': {
                    'GOOD': 'Way to go! Your business description is strong and keyword relevant',
                    'NEEDS IMPROVEMENT': 'Great start, but a few small tweaks would help you rank higher!',
                    'MISSING': 'Uh oh! This is a key optimization piece you are missing, lets fix it!'
                },
                'claimed': {
                    'GOOD': 'Perfect! Your Google Business Profile is claimed and verified',
                    'NEEDS IMPROVEMENT': 'Your profile needs verification to unlock full control',
                    'MISSING': 'Critical! You need to claim your Google Business Profile immediately'
                },
                'categories': {
                    'GOOD': 'Excellent! You have comprehensive business categories set up',
                    'NEEDS IMPROVEMENT': 'Good foundation, but adding more categories will help you rank for more searches',
                    'MISSING': 'You\'re missing important categories that could bring you more customers'
                },
                'productTiles': {
                    'GOOD': 'Great job! Your product/service tiles showcase your offerings well',
                    'NEEDS IMPROVEMENT': 'You have some tiles, but adding more will give you better keyword coverage',
                    'MISSING': 'Missing opportunity! Product tiles help customers see what you offer'
                },
                'photos': {
                    'GOOD': 'Fantastic! You have plenty of high-quality photos on your profile',
                    'NEEDS IMPROVEMENT': 'You have some photos, but adding more will build more trust with customers',
                    'MISSING': 'Photos are essential for building trust - let\'s get some uploaded!'
                },
                'posts': {
                    'GOOD': 'Awesome! You\'re actively posting and engaging with customers',
                    'NEEDS IMPROVEMENT': 'You have some posts, but regular posting will boost your visibility',
                    'MISSING': 'Regular posts show Google your business is active - time to start posting!'
                },
                'qa': {
                    'GOOD': 'Perfect! Your Q&A section helps customers get answers quickly',
                    'NEEDS IMPROVEMENT': 'Some Q&As are there, but adding more common questions will help customers',
                    'MISSING': 'Q&As help answer customer questions before they call - let\'s add some!',
                    'UNCERTAIN': 'We couldn\'t clearly detect your Q&A section - it may exist but isn\'t visible'
                },
                'social': {
                    'GOOD': 'Excellent! Your social media links help customers connect with you',
                    'NEEDS IMPROVEMENT': 'You have some social links, but adding more platforms increases your reach',
                    'MISSING': 'Social media links build trust and give customers more ways to find you'
                },
                'reviews': {
                    'GOOD': 'Outstanding! Your reviews show customers love working with you',
                    'NEEDS IMPROVEMENT': 'You have reviews, but a few improvements could boost your reputation further',
                    'MISSING': 'Reviews are crucial for trust and rankings - let\'s get your review strategy going!'
                },
                'citations': {
                    'GOOD': 'Great work! You\'re listed in most major directories',
                    'NEEDS IMPROVEMENT': 'You\'re in some directories, but more citations will boost your local authority',
                    'MISSING': 'Citations help Google verify your business - let\'s get you listed in key directories'
                },
                'gbpEmbed': {
                    'GOOD': 'Perfect! Your Google Business Profile is embedded on your website',
                    'NEEDS IMPROVEMENT': 'Close! Your embed needs some optimization to work better',
                    'MISSING': 'Embedding your Google profile on your website strengthens your local SEO'
                },
                'landingPage': {
                    'GOOD': 'Excellent! You have a strong local landing page targeting your area',
                    'NEEDS IMPROVEMENT': 'You have a local page, but some tweaks could make it rank even better',
                    'MISSING': 'A local landing page helps you rank for "[service] in [city]" searches'
                }
            };
            
            return summaries[factorId]?.[status] || `${status.toLowerCase()} status for ${factorId}`;
        }

        // DEPRECATED: This function was causing fake data to persist
        // Use displayReport() with real data instead
        function showReportWithSampleData() {
            console.warn(' showReportWithSampleData() is deprecated - redirecting to dashboard');
            showDashboard();
        }

        // Navigation functions
        function showLogin() {
            hideAllSections();
            clearReportState(); // Clear any stale report data and overlays
            const loginSection = document.getElementById('loginSection');
            if (loginSection) {
                loginSection.classList.remove('hidden');
                console.log(' Login section displayed');
            } else {
                console.error(' Login section not found!');
            }
        }

        function showSignup() {
            hideAllSections();
            clearReportState(); // Clear any stale report data and overlays
            document.getElementById('signupSection').classList.remove('hidden');
        }

        function showForgotPassword() {
            hideAllSections();
            clearReportState(); // Clear any stale report data and overlays
            document.getElementById('forgotPasswordSection').classList.remove('hidden');
        }

        function showDashboard() {
            hideAllSections();
            try {
                clearReportState(); // Clear any stale report data
            } catch (clearError) {
                console.error('Error clearing report state in showDashboard:', clearError);
            }
            
            const dashboardSection = document.getElementById('dashboardSection');
            if (dashboardSection) {
                dashboardSection.classList.remove('hidden');
                console.log(' Dashboard section displayed');
                if (authToken) {
                    loadUserReports();
                }
            } else {
                console.error(' Dashboard section not found!');
                showLogin(); // Fallback to login if dashboard not found
            }
        }

        function showReportForm() {
            hideAllSections();
            clearReportState(); // Clear any stale report data
            document.getElementById('reportFormSection').classList.remove('hidden');
            
            // Clear the form when showing it
            document.getElementById('reportForm').reset();
            document.getElementById('reportError').classList.add('hidden');
            
            // Update button text based on credits
            const submitBtn = document.querySelector('#reportForm button[type="submit"]');
            if (currentUser && currentUser.creditsRemaining <= 0) {
                submitBtn.textContent = 'Generate Preview Report (Free)';
            } else {
                submitBtn.textContent = 'Generate Audit (1 Credit)';
            }
        }

        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').classList.remove('hidden');
            simulateProgress();
        }

        function showReport() {
            // Only show report if we have valid report data
            if (!currentReportData) {
                console.warn(' Attempted to show report without valid data, redirecting to dashboard');
                showDashboard();
                return;
            }
            
            hideAllSections();
            document.getElementById('reportSection').classList.remove('hidden');
        }

        function hideAllSections() {
            const sections = ['loginSection', 'signupSection', 'forgotPasswordSection', 'dashboardSection', 'reportFormSection', 'loadingSection', 'reportSection'];
            sections.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                } else {
                    console.warn(` Section element not found: ${id}`);
                }
            });
        }

        // Enhanced progress simulation
        function simulateProgress() {
            let currentStep = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            function updateProgress() {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    progressFill.style.width = step.percent + '%';
                    progressText.textContent = step.text;
                    currentStep++;
                    
                    // Varied timing to make it feel more realistic
                    const delay = currentStep < 3 ? 3000 : (currentStep < 6 ? 8000 : 5000);
                    setTimeout(updateProgress, delay);
                }
            }
            
            updateProgress();
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Check if user is authenticated
        async function checkAuth() {
            try {
                console.log(' Making auth request...');
                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateDashboard();
                    // Don't automatically redirect to dashboard - let calling function decide
                    console.log(' User authenticated:', currentUser.firstName);
                } else {
                    console.log(' Token invalid (status:', response.status, '), clearing auth state...');
                    localStorage.removeItem('authToken');
                    authToken = null;
                    showLogin();
                }
            } catch (error) {
                console.error(' Auth check failed:', error);
                console.log(' Clearing auth state and showing login...');
                localStorage.removeItem('authToken');
                authToken = null;
                showLogin();
            }
        }

        // Update dashboard with user data
        function updateDashboard() {
            if (currentUser) {
                const userName = document.getElementById('userName');
                if (userName) userName.textContent = currentUser.firstName;
                
                // Update menu user name
                const menuUserName = document.getElementById('menuUserName');
                if (menuUserName) menuUserName.textContent = currentUser.firstName;
                
                // Update credits in dropdown menu
                const menuCreditsCount = document.getElementById('menuCreditsCount');
                if (menuCreditsCount) menuCreditsCount.textContent = currentUser.creditsRemaining;
                
                // Update plan info
                const menuPlanInfo = document.getElementById('menuPlanInfo');
                if (menuPlanInfo) {
                    const planText = currentUser.subscriptionTier && currentUser.subscriptionTier !== 'free' ? 
                        `${currentUser.subscriptionTier} Plan Active` : 
                        `${currentUser.creditsRemaining} Credits Remaining`;
                    menuPlanInfo.textContent = planText;
                }
                
                // Show/hide email verification banner
                const verificationBanner = document.getElementById('emailVerificationBanner');
                if (verificationBanner) {
                    const wasDismissed = sessionStorage.getItem('verificationBannerDismissed') === 'true';
                    if (currentUser.emailVerified || wasDismissed) {
                        verificationBanner.classList.add('hidden');
                        document.body.classList.remove('has-email-banner');
                    } else {
                        verificationBanner.classList.remove('hidden');
                        document.body.classList.add('has-email-banner');
                    }
                }
                
                // Show/hide white label menu item for subscription users
                const whiteLabelMenuItem = document.getElementById('whiteLabelMenuItem');
                if (whiteLabelMenuItem) {
                    if (currentUser.subscriptionTier && currentUser.subscriptionTier !== 'free') {
                        whiteLabelMenuItem.style.display = 'flex';
                    } else {
                        whiteLabelMenuItem.style.display = 'none';
                    }
                }
                
                // Update report form button text if form is visible
                const submitBtn = document.querySelector('#reportForm button[type="submit"]');
                if (submitBtn) {
                    if (currentUser.creditsRemaining <= 0) {
                        submitBtn.textContent = 'Generate Preview Report (Free)';
                    } else {
                        submitBtn.textContent = 'Generate Audit (1 Credit)';
                    }
                }
            }
        }

        // Resend verification email
        async function resendVerificationEmail() {
            if (!currentUser) return;
            
            const button = document.getElementById('resendBtn');
            const originalText = button.textContent;
            
            try {
                // Show loading state
                button.disabled = true;
                button.textContent = 'Sending...';
                
                const response = await fetch('/api/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showToast('Verification email sent! Please check your inbox.', 'success');
                    button.textContent = 'Email Sent ';
                    
                    // Re-enable button after 30 seconds
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = originalText;
                    }, 30000);
                } else {
                    button.disabled = false;
                    button.textContent = originalText;
                    showToast(data.error || 'Failed to send verification email', 'error');
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                button.disabled = false;
                button.textContent = originalText;
                showToast('Network error. Please try again.', 'error');
            }
        }

        // Dismiss email verification banner
        function dismissVerificationBanner() {
            const banner = document.getElementById('emailVerificationBanner');
            if (banner) {
                banner.classList.add('hidden');
                // Store dismissal in sessionStorage so it stays dismissed during this session
                sessionStorage.setItem('verificationBannerDismissed', 'true');
            }
        }

        // Load user's reports from the backend
        async function loadUserReports() {
            try {
                const response = await fetch('/api/user-reports', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userReports = data.reports || [];
                    displayReportsTable();
                    console.log(` Loaded ${userReports.length} reports`);
                } else {
                    console.error('Failed to load reports, status:', response.status);
                    userReports = [];
                    displayReportsTable(); // Still display empty table
                    showToast('Unable to load reports. Please refresh the page.', 'error');
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                userReports = [];
                displayReportsTable(); // Still display empty table
                showToast('Network error loading reports. Please refresh the page.', 'error');
            }
        }

        // Switch between report tabs
        function switchReportTab(tabType) {
            // Update tab button styles
            const auditsTab = document.getElementById('auditsTab');
            const competitiveTab = document.getElementById('competitiveTab');

            if (tabType === 'audits') {
                auditsTab.style.borderBottom = '3px solid #0e192b';
                auditsTab.style.color = '#0e192b';
                competitiveTab.style.borderBottom = '3px solid transparent';
                competitiveTab.style.color = '#666';

                document.getElementById('auditsTableContainer').classList.remove('hidden');
                document.getElementById('competitiveTableContainer').classList.add('hidden');
            } else {
                competitiveTab.style.borderBottom = '3px solid #0e192b';
                competitiveTab.style.color = '#0e192b';
                auditsTab.style.borderBottom = '3px solid transparent';
                auditsTab.style.color = '#666';

                document.getElementById('competitiveTableContainer').classList.remove('hidden');
                document.getElementById('auditsTableContainer').classList.add('hidden');
            }
        }

        // Sort reports by column
        function sortReports(column) {
            // Toggle direction if clicking same column, otherwise default to desc/asc based on column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                // Default sort directions
                if (column === 'name') {
                    currentSortDirection = 'asc'; // A-Z
                } else if (column === 'score') {
                    currentSortDirection = 'desc'; // High to low
                } else if (column === 'date') {
                    currentSortDirection = 'desc'; // Most recent first
                }
            }

            // Re-display with new sort
            displayReportsTable();
        }

        // Get sort arrow indicator
        function getSortArrow(column) {
            if (currentSortColumn !== column) {
                return ''; // Unsorted indicator
            }
            return currentSortDirection === 'asc' ? '' : '';
        }

        // Display reports as a table (updated to separate audits from competitive analyses)
        function displayReportsTable() {
            if (!userReports || userReports.length === 0) {
                document.getElementById('auditsTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No audits yet</h4>
                        <p>Generate your first SEO audit to get started!</p>
                    </div>
                `;
                document.getElementById('competitiveTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No competitive analyses yet</h4>
                        <p>Run your first competitive analysis to get started!</p>
                    </div>
                `;
                return;
            }

            // Separate reports by type
            let singleAudits = userReports.filter(report => {
                // Bulk audits have business names starting with "Fast Bulk:" or "Bulk:"
                return !report.business_name.startsWith('Fast Bulk:') && !report.business_name.startsWith('Bulk:');
            });

            let competitiveAnalyses = userReports.filter(report => {
                return report.business_name.startsWith('Fast Bulk:') || report.business_name.startsWith('Bulk:');
            });

            // Sort single audits
            if (singleAudits.length > 0) {
                singleAudits.sort((a, b) => {
                    let aVal, bVal;

                    if (currentSortColumn === 'name') {
                        aVal = a.business_name.toLowerCase();
                        bVal = b.business_name.toLowerCase();
                        return currentSortDirection === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    } else if (currentSortColumn === 'score') {
                        aVal = a.score || 0;
                        bVal = b.score || 0;
                        return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    } else if (currentSortColumn === 'date') {
                        aVal = new Date(a.created_at).getTime();
                        bVal = new Date(b.created_at).getTime();
                        return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    return 0;
                });
            }

            // Sort competitive analyses
            if (competitiveAnalyses.length > 0) {
                competitiveAnalyses.sort((a, b) => {
                    let aVal, bVal;

                    if (currentSortColumn === 'name') {
                        aVal = a.business_name.toLowerCase();
                        bVal = b.business_name.toLowerCase();
                        return currentSortDirection === 'asc'
                            ? aVal.localeCompare(bVal)
                            : bVal.localeCompare(aVal);
                    } else if (currentSortColumn === 'date') {
                        aVal = new Date(a.created_at).getTime();
                        bVal = new Date(b.created_at).getTime();
                        return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
                    }
                    return 0;
                });
            }

            // Display single audits
            if (singleAudits.length === 0) {
                document.getElementById('auditsTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No audits yet</h4>
                        <p>Generate your first SEO audit to get started!</p>
                    </div>
                `;
            } else {
                let auditsTableHTML = `
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th onclick="sortReports('name')" style="cursor: pointer; user-select: none;">
                                    Business ${getSortArrow('name')}
                                </th>
                                <th onclick="sortReports('score')" style="cursor: pointer; user-select: none;">
                                    Score ${getSortArrow('score')}
                                </th>
                                <th onclick="sortReports('date')" style="cursor: pointer; user-select: none;">
                                    Date ${getSortArrow('date')}
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                singleAudits.forEach(report => {
                    const date = new Date(report.created_at).toLocaleDateString();
                    const score = report.score || 'N/A';
                    const scoreClass = score === 'N/A' ? 'score-neutral' :
                                     score >= 80 ? 'score-good' :
                                     score >= 60 ? 'score-fair' : 'score-poor';
                    const lockIcon = !report.was_paid ? '<span class="lock-icon"></span>' : '';

                    auditsTableHTML += `
                        <tr>
                            <td>
                                <div class="business-name">${report.business_name} ${lockIcon}</div>
                                <div class="business-location">${report.city}  ${report.industry}</div>
                            </td>
                            <td>
                                <div class="table-score-display ${scoreClass}">${score}${score !== 'N/A' ? '/100' : ''}</div>
                            </td>
                            <td>${date}</td>
                            <td>
                                <button class="report-action-btn view-btn" onclick="viewStoredReport(${report.id})">VIEW</button>
                                <button class="report-action-btn run-again-btn" onclick="runReportAgain('${report.business_name}', '${report.city}', '${report.industry}', '${report.website || ''}')">
                                    RUN AGAIN
                                </button>
                            </td>
                        </tr>
                    `;
                });

                auditsTableHTML += `</tbody></table>`;
                document.getElementById('auditsTableContainer').innerHTML = auditsTableHTML;
            }

            // Display competitive analyses
            if (competitiveAnalyses.length === 0) {
                document.getElementById('competitiveTableContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No competitive analyses yet</h4>
                        <p>Run your first competitive analysis to get started!</p>
                    </div>
                `;
            } else {
                let competitiveTableHTML = `
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th onclick="sortReports('name')" style="cursor: pointer; user-select: none;">
                                    Analysis ${getSortArrow('name')}
                                </th>
                                <th>Businesses</th>
                                <th onclick="sortReports('date')" style="cursor: pointer; user-select: none;">
                                    Date ${getSortArrow('date')}
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                competitiveAnalyses.forEach(report => {
                    const date = new Date(report.created_at).toLocaleDateString();
                    // Extract industry from business_name (format: "Fast Bulk: Industry")
                    const industry = report.business_name.replace('Fast Bulk: ', '').replace('Bulk: ', '');

                    competitiveTableHTML += `
                        <tr>
                            <td>
                                <div class="business-name">${industry}</div>
                                <div class="business-location">${report.city}</div>
                            </td>
                            <td style="text-align: center; font-weight: 600; color: #17a2b8;">
                                View Report
                            </td>
                            <td>${date}</td>
                            <td>
                                <button class="report-action-btn view-btn" onclick="viewStoredBulkReport(${report.id})">VIEW</button>
                            </td>
                        </tr>
                    `;
                });

                competitiveTableHTML += `</tbody></table>`;
                document.getElementById('competitiveTableContainer').innerHTML = competitiveTableHTML;
            }
        }

        // Function to pre-fill form with previous report data
        function runReportAgain(businessName, location, industry, website) {
            showReportForm();
            
            // Pre-fill the form
            document.getElementById('businessName').value = businessName;
            document.getElementById('location').value = location;
            document.getElementById('industry').value = industry;
            document.getElementById('website').value = website;
        }

        // View a stored bulk report - redirects to competitive analysis page
        async function viewStoredBulkReport(reportId) {
            // Use the same function as viewStoredReport - it handles bulk reports automatically
            return viewStoredReport(reportId);
        }

        // View a stored report - fetch the full report data
        async function viewStoredReport(reportId) {
            console.log(` Loading stored report: ${reportId}`);
            try {
                showToast('Loading stored report...', 'warning');
                
                const response = await fetch(`/api/reports/${reportId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                console.log(` Report fetch response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(` Failed to load report: ${response.status} - ${errorText}`);
                    throw new Error(`Failed to load report: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(' Report data received:', {
                    success: data.success,
                    hasReport: !!data.report,
                    isLocked: data.report?.isLocked,
                    reportKeys: data.report ? Object.keys(data.report) : []
                });
                
                if (data.success && data.report) {
                    // Check if this is a bulk audit report
                    if (data.report.type === 'fast_bulk_scan') {
                        // Redirect to competitive analysis page with the report data
                        console.log(' Bulk audit detected - redirecting to competitive analysis page');
                        localStorage.setItem('bulkReportData', JSON.stringify(data.report));
                        window.location.href = 'competitive-analysis.html';
                        return;
                    }

                    // Set the current report data before displaying, including report ID for unlocking
                    currentReportData = {
                        ...data.report,
                        reportId: reportId
                    };
                    // Display the stored report using the existing display function
                    displayReport(currentReportData);
                    showReport(); // This will now have valid currentReportData

                    const message = data.report.isLocked ? 'Locked report preview loaded!' : 'Report loaded successfully!';
                    showToast(message, 'success');
                } else {
                    console.error('Invalid report response:', data);
                    throw new Error('Invalid report data received');
                }
                
            } catch (error) {
                console.error('Error loading report:', error);
                showToast('Failed to load report. Please try again.', 'error');
            }
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.textContent = 'Logging in...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateDashboard();
                    showDashboard();
                    showToast('Logged in successfully!', 'success');
                    console.log(' Login successful!');
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed. Please check your connection.';
                errorDiv.classList.remove('hidden');
                console.error('Login error:', error);
            } finally {
                submitBtn.textContent = 'Login';
                submitBtn.disabled = false;
            }
        });

        // Handle signup form submission
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const termsAgreement = document.getElementById('termsAgreement').checked;
            const errorDiv = document.getElementById('signupError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Validate terms agreement
            if (!termsAgreement) {
                errorDiv.textContent = 'You must agree to the Terms and Conditions and Privacy Policy to create an account.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName, lastName, email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateDashboard();
                    showDashboard();
                    showToast('Account created successfully!', 'success');
                    console.log(' Signup successful!');
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Signup failed. Please check your connection.';
                errorDiv.classList.remove('hidden');
                console.error('Signup error:', error);
            } finally {
                submitBtn.textContent = 'Create Account';
                submitBtn.disabled = false;
            }
        });

        // Handle forgot password form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const messageDiv = document.getElementById('forgotPasswordMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.textContent = 'Sending...';
            submitBtn.disabled = true;
            messageDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    messageDiv.classList.remove('hidden');
                    e.target.reset();
                } else {
                    messageDiv.innerHTML = `<div class="error">${data.error || 'Failed to send reset link'}</div>`;
                    messageDiv.classList.remove('hidden');
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">Network error. Please try again.</div>';
                messageDiv.classList.remove('hidden');
                console.error('Forgot password error:', error);
            } finally {
                submitBtn.textContent = 'Send Reset Link';
                submitBtn.disabled = false;
            }
        });

        // Handle report form submission with proper data mapping
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const businessName = document.getElementById('businessName').value;
            const location = document.getElementById('location').value;
            const industry = document.getElementById('industry').value;
            const website = document.getElementById('website').value;
            const errorDiv = document.getElementById('reportError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Store form data for later use
            window.pendingReportData = { businessName, location, industry, website };
            
            // Validate location format - must have at least one comma
            if (!location.includes(',')) {
                errorDiv.textContent = 'Please enter a valid location (e.g., "Miami, FL" or "123 Main St, Miami, FL 33101")';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.textContent = 'Generating Report...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            
            // Go straight to loading screen
            showLoading();
            window.pendingReportData = { businessName, location, industry, website };
            
            try {
                // Try profile verification first, but handle it in background
                await verifyBusinessProfile(businessName, location);
                
            } catch (error) {
                console.error(' Report generation error:', error);
                errorDiv.textContent = 'Failed to generate report. Please try again.';
                errorDiv.classList.remove('hidden');
                hideAllSections();
                showReportForm();
            } finally {
                // Reset button text based on credits
                if (currentUser && currentUser.creditsRemaining <= 0) {
                    submitBtn.textContent = 'Generate Preview Report (Free)';
                } else {
                    submitBtn.textContent = 'Generate Audit (1 Credit)';
                }
                submitBtn.disabled = false;
            }
        });

        // Simplified function to handle donut chart - NO ANIMATION
        function updateScoreDonut(score) {
            const scoreDonut = document.getElementById('scoreDonut');
            const circumference = 440;
            const offset = circumference - (circumference * score / 100);

            // Set color and offset immediately based on score
            if (score >= 90) {
                scoreDonut.style.stroke = '#27ae60';
            } else if (score >= 80) {
                scoreDonut.style.stroke = '#2ecc71';
            } else if (score >= 70) {
                scoreDonut.style.stroke = '#f1c40f';
            } else if (score >= 60) {
                scoreDonut.style.stroke = '#f39c12';
            } else {
                scoreDonut.style.stroke = '#dc3545';
            }
            
            // Set the fill immediately - no animation
            scoreDonut.style.strokeDashoffset = offset;
        }

        // Display the report with new donut chart
        function displayReport(reportData) {
            console.log(' Displaying single-page report:', reportData);
            console.log(' Data structure check:', Object.keys(reportData));

            // Store report ID and business name for manual overrides
            window.currentReportId = reportData.id || reportData.reportId;
            window.currentBusinessName = reportData.businessName || reportData.business?.name || '';

            try {
                // More flexible data access to handle different backend structures
                const businessData = reportData.business || reportData.businessData || {};
                const auditData = reportData.auditOverview || reportData.audit || reportData;
            const scoreData = auditData.overallScore || auditData.score || { score: 0, message: 'Report generated successfully' };
            
            // For locked/fallback reports, ensure we have minimum required data
            if (reportData.isLocked && reportData.isFallback) {
                console.log(' Displaying fallback locked report with minimal data');
                // Ensure factors are in the correct format (convert array to object if needed)
                if (Array.isArray(auditData.factors)) {
                    const factorsObj = {};
                    auditData.factors.forEach(factor => {
                        factorsObj[factor.id] = {
                            title: factor.name,
                            score: factor.score,
                            maxScore: factor.maxScore,
                            status: factor.status,
                            message: factor.message
                        };
                    });
                    auditData.factors = factorsObj;
                }
            }
            
            // Update business info header with fallback values
            document.getElementById('reportBusinessName').textContent = 
                businessData.name || reportData.businessName || 'Business Report';
            document.getElementById('reportLocation').textContent = 
                businessData.location || reportData.location || 'Location';
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            
            // Update prepared by field with dynamic brand info
            const brandInfo = reportData.brandInfo || {};
            document.getElementById('reportPreparedBy').textContent = 
                brandInfo.preparedBy || 'Locality Marketing';
            
            // Update logo sources with dynamic brand logo
            if (brandInfo.logo) {
                const logoElements = document.querySelectorAll('img[alt*="Locality"]');
                logoElements.forEach(img => {
                    img.src = brandInfo.logo;
                });
            }

            // Update score with fallback
            const score = scoreData.score || reportData.finalScore || 0;
            
            document.getElementById('scoreNumber').textContent = score;
            document.getElementById('scoreMessage').textContent = 
                scoreData.message || getScoreMessage(score);

            // Animate the donut chart with the new function
            updateScoreDonut(score);

            // Display factors with fallback data
            let factors = auditData.factors || reportData.factors || generateDefaultFactors(score);
            
            // Handle locked report display
            if (reportData.isLocked) {
                console.log(' Displaying LOCKED report');
                // Convert factors array to object format for locked display
                if (Array.isArray(factors)) {
                    const factorsObj = {};
                    factors.forEach(factor => {
                        factorsObj[factor.id] = {
                            title: factor.name,
                            score: factor.score,
                            maxScore: factor.maxScore,
                            status: factor.status,
                            message: factor.message
                        };
                    });
                    factors = factorsObj;
                }
                // Add locked class to report section
                document.getElementById('reportSection').classList.add('locked');
                displayLockedReport(factors, reportData.optimizationOpportunities || 0);
            } else {
                console.log(' Displaying UNLOCKED report with full factors');
                // Keep factors as array for unlocked display
                if (!Array.isArray(factors)) {
                    // Convert object back to array if needed
                    factors = Object.keys(factors).map(id => ({
                        id: id,
                        name: factors[id].title || factors[id].name,
                        status: factors[id].status,
                        message: factors[id].message,
                        score: factors[id].score,
                        maxScore: factors[id].maxScore
                    }));
                }
                // Remove locked class if present
                document.getElementById('reportSection').classList.remove('locked');
                displayFactorsCompact(factors, reportData.smartSuggestions?.suggestions || {});
                
                // Display citations with fallback
                const citations = reportData.citationsAnalysis || reportData.citations || { data: { checked: [] } };
                displayCitationsRow(citations);
                
                // Display action plan with fallback
                const actionPlan = reportData.actionPlan || generateDefaultActionPlan(factors);
                displayActionPlanSimple(actionPlan);
                
                // Auto-display stored detailed citation analysis if it exists
                if (reportData.detailedCitationAnalysis) {
                    console.log(' Auto-displaying stored detailed citation analysis');
                    displayStoredDetailedResults(reportData.detailedCitationAnalysis);
                }
            }
            } catch (error) {
                console.error(' Error displaying report:', error);
                console.error('Report data that caused error:', reportData);
                showToast('Error displaying report. Please refresh and try again.', 'error');
                // Still try to show the report section even if there's an error
                showReport();
            }
        }

        // Calculate actual optimization opportunities from factors
        function calculateOptimizationOpportunities(factors) {
            let opportunities = 0;
            
            for (const factorId in factors) {
                const factor = factors[factorId];
                
                // Count factors that need improvement (not "GOOD")
                if (factor.status === 'MISSING' || factor.status === 'NEEDS_IMPROVEMENT' || factor.status === 'UNCERTAIN') {
                    opportunities++;
                }
            }
            
            return opportunities;
        }

        // Display locked report with blur effect and unlock overlay
        function displayLockedReport(factors, optimizationOpportunities) {
            console.log(' Displaying locked report with blur overlay');
            
            // Remove any existing unlock overlay first
            const existingOverlay = document.getElementById('unlockReportOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Calculate actual optimization opportunities from factors
            const actualOpportunities = calculateOptimizationOpportunities(factors);
            
            // First, display everything normally using the regular functions
            // Convert factors object to array format for displayFactorsCompact
            let factorsArray = factors;
            if (!Array.isArray(factors) && typeof factors === 'object') {
                factorsArray = Object.keys(factors).map(id => ({
                    id: id,
                    name: factors[id].title || factors[id].name,
                    status: factors[id].status,
                    message: factors[id].message,
                    score: factors[id].score,
                    maxScore: factors[id].maxScore
                }));
            }
            displayFactorsCompact(factorsArray, {});
            
            // Display citations with sample data
            const fallbackCitations = {
                data: {
                    checked: [
                        { directory: 'Google', found: true },
                        { directory: 'Yelp', found: false },
                        { directory: 'Facebook', found: true },
                        { directory: 'Yellow Pages', found: false },
                        { directory: 'Bing Places', found: false },
                        { directory: 'Apple Maps', found: true },
                        { directory: 'Foursquare', found: false },
                        { directory: 'Better Business Bureau', found: false },
                        { directory: 'Merchant Circle', found: false },
                        { directory: 'Chamber of Commerce', found: false }
                    ]
                }
            };
            displayCitationsRow(fallbackCitations);
            
            // Display action plan with sample data
            const fallbackActionPlan = {
                actions: [
                    { id: 'description', task: 'Optimize Business Description', priority: 'HIGH', completed: false, estimatedTime: '15 minutes' },
                    { id: 'tiles', task: 'Add Product/Service Tiles', priority: 'HIGH', completed: false, estimatedTime: '30 minutes' },
                    { id: 'photos', task: 'Upload High-Quality Photos', priority: 'MEDIUM', completed: false, estimatedTime: '1 hour' },
                    { id: 'citations', task: 'Build Local Citations', priority: 'HIGH', completed: false, estimatedTime: '2-4 hours' },
                    { id: 'reviews', task: 'Implement Review Strategy', priority: 'HIGH', completed: false, estimatedTime: '2-4 weeks' }
                ]
            };
            displayActionPlanSimple(fallbackActionPlan);
            
            // NOW apply locked class to blur everything
            document.getElementById('reportSection').classList.add('locked');
            
            // Create floating unlock overlay
            const unlockOverlay = document.createElement('div');
            unlockOverlay.id = 'unlockReportOverlay';
            unlockOverlay.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                border: 2px solid #0e192b;
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
                backdrop-filter: blur(10px);
            `;
            unlockOverlay.innerHTML = `
                <div style="font-size: 1.8rem; margin-bottom: 10px;"></div>
                <div style="font-size: 1.4rem; font-weight: bold; color: #0e192b; margin-bottom: 10px;">
                    ANALYSIS COMPLETE
                </div>
                <div style="color: #666; margin-bottom: 20px; font-size: 1rem;">
                    ${actualOpportunities} Optimization Opportunities Found
                </div>
                <div style="color: #888; margin-bottom: 25px; font-size: 0.9rem; line-height: 1.4;">
                    Your complete SEO audit is ready! Unlock to see detailed recommendations and actionable insights.
                </div>
                <button class="unlock-btn" onclick="handleUnlockAccess()" style="
                    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 8px;
                    font-size: 1.1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    width: 100%;
                ">
                     UNLOCK FULL REPORT
                </button>
            `;
            
            // Add hover effect to unlock button
            const unlockBtn = unlockOverlay.querySelector('.unlock-btn');
            unlockBtn.addEventListener('mouseenter', () => {
                unlockBtn.style.transform = 'translateY(-2px)';
                unlockBtn.style.boxShadow = '0 8px 25px rgba(30, 64, 175, 0.4)';
            });
            unlockBtn.addEventListener('mouseleave', () => {
                unlockBtn.style.transform = 'translateY(0)';
                unlockBtn.style.boxShadow = 'none';
            });
            
            // Insert overlay into document body
            document.body.appendChild(unlockOverlay);
            
            console.log(' Locked report displayed with blur effect and unlock overlay');
        }

        // Handle unlock access - either use credits or buy more
        function handleUnlockAccess() {
            if (currentUser && currentUser.creditsRemaining > 0) {
                // User has credits, offer to unlock directly
                if (confirm(`Unlock this report for 1 credit? You have ${currentUser.creditsRemaining} credits remaining.`)) {
                    unlockCurrentReport();
                } else {
                    // User declined, show pricing modal
                    redirectToPricing();
                }
            } else {
                // User has no credits, redirect to pricing
                redirectToPricing();
            }
        }

        // Redirect to pricing page
        function redirectToPricing() {
            showPricingModal(true, true); // true = highlight single report, true = from unlock modal
            showToast('Please purchase credits to unlock the full report!', 'info');
        }

        // Update credit display in UI
        function updateCreditDisplay() {
            if (!currentUser) return;
            
            // Update credits in dropdown menu
            const menuCreditsCount = document.getElementById('menuCreditsCount');
            if (menuCreditsCount) {
                menuCreditsCount.textContent = currentUser.creditsRemaining;
            }
            
            // Update credits in account settings modal if open
            const accountCredits = document.getElementById('accountCredits');
            if (accountCredits) {
                accountCredits.textContent = currentUser.creditsRemaining || 0;
            }
            
            console.log(` Credit display updated: ${currentUser.creditsRemaining} credits remaining`);
        }

        // Unlock the current report using credits
        async function unlockCurrentReport() {
            if (!currentReportData || !currentReportData.reportId) {
                showToast('Unable to unlock report. Please refresh and try again.', 'error');
                return;
            }

            await unlockReport(currentReportData.reportId, () => {
                // Remove the unlock overlay
                const overlay = document.getElementById('unlockReportOverlay');
                if (overlay) {
                    overlay.remove();
                }
                
                // Remove the locked class to un-blur content
                const reportSection = document.getElementById('reportSection');
                if (reportSection) {
                    reportSection.classList.remove('locked');
                }
                
                // Update current report data to mark as unlocked
                currentReportData.isLocked = false;
                
                // Ensure we're in the reports view and display the unlocked report
                try {
                    // Switch to reports view if not already there
                    showSection('reports');
                    
                    // Re-display the full unlocked report immediately
                    displayReport(currentReportData);
                    
                    // Scroll to top of report
                    const reportSection = document.getElementById('reportSection');
                    if (reportSection) {
                        reportSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    
                    console.log(' Report successfully unlocked and displayed');
                } catch (displayError) {
                    console.error('Error displaying unlocked report:', displayError);
                    // Fallback: show success message and suggest refresh
                    showToast('Report unlocked! Refreshing page to display full report...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    return;
                }
                
                // Show success message
                showToast('Report unlocked! You can now view the full analysis.', 'success');
            });
        }

        // Unlock a report from dashboard

        // Generic unlock report function
        async function unlockReport(reportId, onSuccess) {
            try {
                const response = await fetch(`/api/reports/${reportId}/unlock`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Update user credits
                    if (currentUser) {
                        currentUser.creditsRemaining = data.creditsRemaining;
                        // Safely update credit display
                        try {
                            updateCreditDisplay();
                        } catch (updateError) {
                            console.error('Error updating credit display:', updateError);
                        }
                    }

                    console.log(' Report unlocked successfully');
                    if (onSuccess) onSuccess();
                } else {
                    throw new Error(data.error || 'Failed to unlock report');
                }
            } catch (error) {
                console.error('Error unlocking report:', error);
                showToast(error.message || 'Failed to unlock report. Please try again.', 'error');
            }
        }

        // Helper function to generate score message
        function getScoreMessage(score) {
            if (score >= 90) return 'Outstanding! Your local SEO strategy is working beautifully with just minor fine-tuning needed';
            if (score >= 80) return 'Great work! You have a strong foundation with exciting opportunities to reach even more customers';
            if (score >= 70) return 'You\'re on the right track! A few focused improvements will significantly boost your visibility';
            if (score >= 60) return 'Good start! There are several valuable opportunities to enhance your local presence';
            if (score >= 40) return 'You have potential! With some focused effort, you can build a strong local presence';
            return 'Every business starts somewhere! Let\'s work together to build your local SEO success step by step';
        }

        // Helper function to generate default factors if missing
        function generateDefaultFactors(score) {
            return [
                { id: 'claimed', name: 'Claimed Profile', status: 'GOOD', message: 'Profile is claimed and verified' },
                { id: 'description', name: 'Business Description', status: score > 50 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('description', score > 50 ? 'GOOD' : 'NEEDS IMPROVEMENT') },
                { id: 'categories', name: 'Categories', status: 'GOOD', message: getDynamicSummary('categories', 'GOOD') },
                { id: 'photos', name: 'Photos', status: score > 60 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('photos', score > 60 ? 'GOOD' : 'NEEDS IMPROVEMENT') },
                { id: 'reviews', name: 'Customer Reviews', status: score > 70 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('reviews', score > 70 ? 'GOOD' : 'NEEDS IMPROVEMENT') }
            ];
        }

        // Helper function to generate default action plan
        function generateDefaultActionPlan(factors) {
            return {
                actions: [
                    { id: 'description', task: 'Optimize Business Description', completed: false },
                    { id: 'photos', task: 'Upload High-Quality Photos', completed: false },
                    { id: 'reviews', task: 'Improve Review Strategy', completed: false },
                    { id: 'citations', task: 'Build Local Citations', completed: false },
                    { id: 'posts', task: 'Start Regular Google Posts', completed: false }
                ]
            };
        }

        // Display factors in compact format with expandable details
        function displayFactorsCompact(factors, smartSuggestions) {
            const factorsGrid = document.getElementById('factorsGrid');

            // Clean up any previous locked state
            factorsGrid.classList.remove('factors-locked');
            const existingOverlay = factorsGrid.parentElement.querySelector('.unlock-report-banner');
            if (existingOverlay) {
                existingOverlay.remove();
            }

            // Also remove the floating unlock overlay if it exists
            const floatingOverlay = document.getElementById('unlockReportOverlay');
            if (floatingOverlay) {
                floatingOverlay.remove();
            }

            // Show citations and action plan sections for unlocked reports
            const citationsSection = document.getElementById('citationsSection');
            const actionPlanSection = document.getElementById('actionPlanSection');
            if (citationsSection) citationsSection.style.display = 'block';
            if (actionPlanSection) actionPlanSection.style.display = 'block';

            // Group factors by status
            const grouped = {
                missing: [],
                'needs-improvement': [],
                good: []
            };

            factors.forEach(factor => {
                const statusClass = factor.status.toLowerCase().replace(/\s+/g, '-');
                if (grouped[statusClass]) {
                    grouped[statusClass].push(factor);
                }
            });

            // Build HTML with groups
            let factorsHTML = '<h2>Ranking Factor Review</h2>';

            // Helper function to create factor card
            const createFactorCard = (factor) => {
                const statusClass = factor.status.toLowerCase().replace(/\s+/g, '-');
                const suggestion = getSmartSuggestion(factor, smartSuggestions);

                return `
                    <div class="factor-card ${statusClass}" onclick="toggleFactor(this)" data-factor-id="${factor.id}">
                        <div class="factor-header">
                            <div class="factor-name">${factor.name}</div>
                            <span class="factor-expand-arrow"></span>
                        </div>
                        <p class="factor-message">${factor.message}</p>

                        <div class="factor-expanded-content">
                            <div class="expanded-sections">
                                <div class="expanded-section">
                                    <h4>What Is This?</h4>
                                    <p>${getFactorDescription(factor.id)}</p>
                                </div>
                                <div class="expanded-section">
                                    <h4>Why It Matters?</h4>
                                    <p>${getFactorImportance(factor.id)}</p>
                                </div>
                                <div class="expanded-section">
                                    <h4>How to fix it</h4>
                                    <p>${getFactorHowToFix(factor.id)}</p>
                                </div>
                            </div>

                            ${suggestion ? `
                                <div class="smart-suggestion-section">
                                    <h4>Smart Suggestion</h4>
                                    <textarea class="suggestion-textarea" id="suggestion-${factor.id}" readonly>${suggestion}</textarea>
                                    <div class="suggestion-actions">
                                        <button class="copy-suggestion-btn" onclick="copySuggestionToClipboard('${factor.id}'); event.stopPropagation();">
                                             Copy to Clipboard
                                        </button>
                                    </div>
                                </div>
                            ` : ''}

                            <!-- Manual Override Section -->
                            <div class="manual-override-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                                <button class="manual-update-btn" onclick="showManualOverride('${factor.id}'); event.stopPropagation();" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; font-size: 13px; color: #495057; cursor: pointer; transition: all 0.2s;">
                                    Manual Update
                                </button>
                                <div class="manual-override-dropdown" id="override-${factor.id}" onclick="event.stopPropagation();" style="display: none; margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                    <div style="font-size: 13px; color: #6c757d; margin-bottom: 8px;">Update status manually:</div>
                                    <select class="override-select" id="select-${factor.id}" onclick="event.stopPropagation();" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px; margin-bottom: 8px;">
                                        <option value="missing" ${statusClass === 'missing' ? 'selected' : ''}> Missing</option>
                                        <option value="needs_improvement" ${statusClass === 'needs-improvement' ? 'selected' : ''}> Needs Improvement</option>
                                        <option value="good" ${statusClass === 'good' ? 'selected' : ''}> Good</option>
                                    </select>
                                    <div style="display: flex; gap: 8px;">
                                        <button onclick="saveFactorOverride('${factor.id}'); event.stopPropagation();" style="flex: 1; background: #0e192b; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 13px; cursor: pointer;">Save</button>
                                        <button onclick="cancelManualOverride('${factor.id}'); event.stopPropagation();" style="flex: 1; background: #6c757d; color: white; border: none; padding: 8px; border-radius: 4px; font-size: 13px; cursor: pointer;">Cancel</button>
                                    </div>
                                    <div id="override-status-${factor.id}" style="margin-top: 8px; font-size: 12px; color: #6c757d;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            };

            // MISSING Group
            if (grouped.missing.length > 0) {
                factorsHTML += `
                    <div class="factor-group">
                        <div class="group-header missing">
                            <div class="group-icon missing"></div>
                            <div class="group-title">MISSING</div>
                            <div class="group-count">${grouped.missing.length} Factor${grouped.missing.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="factors-grid">
                            ${grouped.missing.map(createFactorCard).join('')}
                        </div>
                    </div>
                `;
            }

            // NEEDS IMPROVEMENT Group
            if (grouped['needs-improvement'].length > 0) {
                factorsHTML += `
                    <div class="factor-group">
                        <div class="group-header needs-improvement">
                            <div class="group-icon needs-improvement">!</div>
                            <div class="group-title">NEEDS IMPROVEMENT</div>
                            <div class="group-count">${grouped['needs-improvement'].length} Factor${grouped['needs-improvement'].length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="factors-grid">
                            ${grouped['needs-improvement'].map(createFactorCard).join('')}
                        </div>
                    </div>
                `;
            }

            // GOOD Group
            if (grouped.good.length > 0) {
                factorsHTML += `
                    <div class="factor-group">
                        <div class="group-header good">
                            <div class="group-icon good"></div>
                            <div class="group-title">GOOD</div>
                            <div class="group-count">${grouped.good.length} Factor${grouped.good.length !== 1 ? 's' : ''}</div>
                        </div>
                        <div class="factors-grid">
                            ${grouped.good.map(createFactorCard).join('')}
                        </div>
                    </div>
                `;
            }

            factorsGrid.innerHTML = factorsHTML;
        }

        // Toggle factor expanded view (for new grouped layout)
        function toggleFactor(element) {
            const expandedContent = element.querySelector('.factor-expanded-content');
            const isExpanded = element.classList.contains('expanded');

            // Close all other expanded factors
            document.querySelectorAll('.factor-card.expanded').forEach(card => {
                if (card !== element) {
                    card.classList.remove('expanded');
                    card.querySelector('.factor-expanded-content').classList.remove('show');
                }
            });

            // Toggle this factor
            if (isExpanded) {
                element.classList.remove('expanded');
                expandedContent.classList.remove('show');
            } else {
                element.classList.add('expanded');
                expandedContent.classList.add('show');
            }
        }

        // Toggle factor expanded view (legacy function for old layout)
        function toggleFactorExpanded(factorId) {
            const factorItem = document.querySelector(`#expanded-${factorId}`).closest('.factor-item-compact');
            const expandedContent = document.getElementById(`expanded-${factorId}`);

            // Close all other expanded factors
            document.querySelectorAll('.factor-item-compact.expanded').forEach(item => {
                if (item !== factorItem) {
                    item.classList.remove('expanded');
                    item.querySelector('.factor-expanded-content').classList.remove('show');
                }
            });

            // Toggle this factor
            factorItem.classList.toggle('expanded');
            expandedContent.classList.toggle('show');
        }

        // Get factor descriptions (you can expand this with all 12 factors)
        function getFactorDescription(factorId) {
            const descriptions = {
                'description': 'A short (up to 750 characters) summary that tells customers what your business does and why they should choose you.',
                'claimed': 'Verifying and claiming ownership of your Google Business Profile.',
                'categories': 'Your business\'s primary and secondary categories listed on your Google Business Profile. These are preset options provided by Google, not an open field.',
                'productTiles': 'The product/service section of your GBP where you list specific offerings with names, descriptions, and optional prices. You can include links to those offerings specific landing page.',
                'photos': 'Images displayed on your Google Business Profile, uploaded by you or your customers.',
                'posts': 'Updates you can publish on your GBP to share promotions, tips, or business news. Think of it like a mini social media feed but on your Google Profile.',
                'qa': 'A space on your profile where customers can ask questions about your business, and you (or others) can answer them.',
                'social': 'Links to your Facebook, Instagram, LinkedIn, or other social profiles listed on your GBP.',
                'reviews': 'Ratings and feedback left by customers on your Google Business Profile.',
                'citations': 'Mentions of your business name, address, and phone number (NAP) across online directories like Yelp, BBB, and YP.com. There are thousands of these sites, but getting listed in local directories, or industry specific ones, are most valuable.',
                'gbpEmbed': 'A map or widget that shows your Google listing embedded directly on your website.',
                'landingPage': 'A dedicated page on your site targeting your specific service area (e.g., Plumbing in Nashville).'
            };
            return descriptions[factorId] || 'Important aspect of your local SEO presence';
        }

        function getFactorImportance(factorId) {
            const importance = {
                'description': 'Google uses this field to understand what you offer. Including the right keywords here helps you show up in more relevant searches.',
                'claimed': 'Until it\'s claimed, you can\'t update info, respond to reviews, or optimize your listing.',
                'categories': 'Categories help Google decide which searches your business should appear in. The more accurate and complete, the better.',
                'productTiles': 'It\'s a chance to highlight all your key services and inject keyword-rich content into your profile. Most businesses skip this piece and miss out on those keyword opportunities.',
                'photos': 'Photos show Google (and customers) that you\'re active and real. They improve click-through rates and build trust.',
                'posts': 'Posts signal activity to Google and give potential customers reasons to engage. You can share discounts, new offerings or just help build your brand.',
                'qa': 'This builds trust, answers common questions up front, and adds valuable keywords to your listing.',
                'social': 'Social profiles build trust, help customers connect, and boost your visibility beyond search.',
                'reviews': 'Strong reviews don\'t just boost reputationthey impact how high you rank in local search results. Plus, customers are more likely to pick businesses with strong reviews.',
                'citations': 'Google uses consistent citations to verify your business\'s credibility and location authority. While most people don\'t go to these sites to find your business, Google does. The more directories you show up in, the more likely you are to rank higher.',
                'gbpEmbed': 'It links your site and profile together in Google\'s eyesand helps customers easily find your business.',
                'landingPage': 'Google likes to match local intent with local content. A strong landing page improves both GBP and organic rankings. It helps local customers too!'
            };
            return importance[factorId] || 'This factor impacts your local search visibility and customer trust';
        }

        function getFactorHowToFix(factorId) {
            const howToFix = {
                'description': '<a href="https://trylocality.com/2025/07/how-to-add-or-update-your-business-description-on-google/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to update your description </a>',
                'claimed': '<a href="https://trylocality.com/2025/07/how-to-claim-verify-ownership-of-the-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to claim your profile </a>',
                'categories': '<a href="https://trylocality.com/2025/07/how-to-add-or-update-your-google-business-categories/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to update your categories </a>',
                'productTiles': '<a href="https://trylocality.com/2025/07/how-to-add-product-tiles-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add product tiles </a>',
                'photos': '<a href="https://trylocality.com/2025/07/how-to-add-photos-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add photos </a>',
                'posts': '<a href="https://trylocality.com/2025/07/how-to-add-updates-to-a-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add posts </a>',
                'qa': '<a href="https://trylocality.com/2025/07/how-to-add-qa-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add Q&A </a>',
                'social': '<a href="https://trylocality.com/2025/07/how-to-add-social-media-links-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add social links </a>',
                'reviews': '<a href="https://trylocality.com/2025/07/how-to-get-more-google-reviews-and-manage-them-well/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to get more reviews </a>',
                'citations': '<a href="https://trylocality.com/2025/07/how-to-build-local-citations-that-boost-your-google-rankings/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to build citations </a>',
                'gbpEmbed': '<a href="https://trylocality.com/2025/07/how-to-embed-your-google-business-profile-on-your-website/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to embed your GBP </a>',
                'landingPage': '<a href="https://trylocality.com/2025/07/creating-a-local-landing-page-that-boosts-your-gbp-rankings/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to create a landing page </a>'
            };
            return howToFix[factorId] || '<a href="https://trylocality.com" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn more </a>';
        }

        function getSmartSuggestion(factor, smartSuggestions) {
            // If the factor has GOOD status or achieved full score, hide the suggestion box
            if (factor.status === 'GOOD' || factor.score === factor.maxScore) {
                return null; // This will hide the suggestion section
            }
            
            // Factors that should NOT show smart suggestions regardless of score
            const noSuggestionFactors = ['claimed', 'photos', 'gbpEmbed', 'social'];
            if (noSuggestionFactors.includes(factor.id)) {
                return null; // This will hide the suggestion section
            }
            
            // Try to get from AI suggestions
            const suggestionKey = getSuggestionKey(factor.id);
            // smartSuggestions is already the suggestions object (passed from displayFactorsCompact)
            if (smartSuggestions && smartSuggestions[suggestionKey]) {
                return smartSuggestions[suggestionKey].content;
            }
            
            // If no AI suggestion was generated (likely because score was GOOD/full points),
            // return null to hide the suggestion box entirely
            return null;
        }

        // Copy suggestion to clipboard
        function copySuggestionToClipboard(factorId) {
            // Prevent event bubbling to parent elements
            if (event) {
                event.stopPropagation();
            }
            
            const textarea = document.getElementById(`suggestion-${factorId}`);
            textarea.select();
            document.execCommand('copy');
            
            // Show feedback
            const button = event.target || event.srcElement;
            const originalText = button.textContent;
            button.textContent = ' Copied!';
            button.style.background = '#28a745';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
            
            showToast('Suggestion copied to clipboard!', 'success');
        }

        // Manual Override Functions
        function showManualOverride(factorId) {
            const dropdown = document.getElementById(`override-${factorId}`);
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function cancelManualOverride(factorId) {
            const dropdown = document.getElementById(`override-${factorId}`);
            dropdown.style.display = 'none';
        }

        async function saveFactorOverride(factorId) {
            const select = document.getElementById(`select-${factorId}`);
            const statusDiv = document.getElementById(`override-status-${factorId}`);
            const overrideStatus = select.value;

            statusDiv.textContent = 'Saving...';
            statusDiv.style.color = '#6c757d';

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showToast('Please log in to update factor status', 'error');
                    return;
                }

                const response = await fetch('/api/factor-override', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        reportId: window.currentReportId,
                        factorName: factorId,
                        overrideStatus: overrideStatus,
                        aiDetectedStatus: getCurrentFactorStatus(factorId),
                        businessName: window.currentBusinessName || ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    statusDiv.textContent = ' Saved successfully - Reloading...';
                    statusDiv.style.color = '#28a745';

                    showToast('Factor status updated successfully!', 'success');

                    // Reload the report to show updated factor position and recalculated score
                    setTimeout(async () => {
                        try {
                            await viewStoredReport(window.currentReportId);
                            showToast('Report updated with new factor status', 'success');
                        } catch (reloadError) {
                            console.error('Error reloading report:', reloadError);
                            showToast('Factor saved but failed to reload. Please refresh the page.', 'warning');
                        }
                    }, 800);
                } else {
                    statusDiv.textContent = ' Failed to save';
                    statusDiv.style.color = '#dc3545';
                    showToast(data.error || 'Failed to update factor status', 'error');
                }
            } catch (error) {
                console.error('Error saving factor override:', error);
                statusDiv.textContent = ' Error occurred';
                statusDiv.style.color = '#dc3545';
                showToast('Error updating factor status', 'error');
            }
        }

        function getCurrentFactorStatus(factorId) {
            const factorCard = document.querySelector(`[data-factor-id="${factorId}"]`);
            if (!factorCard) return 'unknown';

            if (factorCard.classList.contains('missing')) return 'missing';
            if (factorCard.classList.contains('needs-improvement')) return 'needs_improvement';
            if (factorCard.classList.contains('good')) return 'good';
            return 'unknown';
        }

        // Display citations in single row format
        function displayCitationsRow(citationsData) {
            const citationsRow = document.getElementById('citationsRow');
            let citationsHTML = '';
            
            citationsData.data.checked.forEach(citation => {
                const status = citation.found ? 'found' : 'missing';
                const icon = citation.found ? '' : '';
                const logoUrl = directoryLogos[citation.directory] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNmOGY5ZmEiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiPgo8cGF0aCBkPSJNNCA0TDggOE00IDhMOCA0IiBzdHJva2U9IiM2Yzc1N2QiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4KPC9zdmc+';
                
                const displayName = directoryDisplayNames[citation.directory] || citation.directory;
                citationsHTML += `
                    <div class="citation-item-simple ${status}">
                        <div class="citation-logo" style="background-image: url('${logoUrl}');"></div>
                        <div class="citation-content">
                            <div class="citation-name-simple">${displayName}</div>
                            <div class="citation-icon">${icon}</div>
                        </div>
                    </div>
                `;
            });
            
            citationsRow.innerHTML = citationsHTML;
            
            // Ensure page 1 citations are visible (in case detailed analysis wasn't run)
            const page1CitationsSection = citationsRow.closest('.section');
            if (page1CitationsSection) {
                page1CitationsSection.style.display = 'block';
            }
        }

        // Get suggestion key helper function
        function getSuggestionKey(factorId) {
            // Map factor IDs to suggestion keys from your backend
            const keyMapping = {
                'description': 'businessDescription',
                'categories': 'categories',
                'productTiles': 'productTiles',
                'posts': 'posts',
                'qa': 'qa',
                'reviews': 'reviews',
                'citations': 'citations',
                'landingPage': 'landingPage'
            };
            return keyMapping[factorId] || factorId;
        }

        // Toggle fix content function
        function toggleFixContent(factorId) {
            const fixContent = document.getElementById(`fix-${factorId}`);
            if (fixContent) {
                fixContent.classList.toggle('show');
            }
        }

        // Get training URL for action items
        function getActionItemTrainingUrl(actionId) {
            const trainingUrls = {
                'description': 'https://trylocality.com/2025/07/how-to-add-or-update-your-business-description-on-google/',
                'claimed': 'https://trylocality.com/2025/07/how-to-claim-verify-ownership-of-the-google-business-profile/',
                'categories': 'https://trylocality.com/2025/07/how-to-add-or-update-your-google-business-categories/',
                'productTiles': 'https://trylocality.com/2025/07/how-to-add-product-tiles-to-your-google-business-profile/',
                'photos': 'https://trylocality.com/2025/07/how-to-add-photos-to-your-google-business-profile/',
                'posts': 'https://trylocality.com/2025/07/how-to-add-updates-to-a-google-business-profile/',
                'qa': 'https://trylocality.com/2025/07/how-to-add-qa-to-your-google-business-profile/',
                'social': 'https://trylocality.com/2025/07/how-to-add-social-media-links-to-your-google-business-profile/',
                'reviews': 'https://trylocality.com/2025/07/how-to-get-more-google-reviews-and-manage-them-well/',
                'citations': 'https://trylocality.com/2025/07/how-to-build-local-citations-that-boost-your-google-rankings/',
                'gbpEmbed': 'https://trylocality.com/2025/07/how-to-embed-your-google-business-profile-on-your-website/',
                'landingPage': 'https://trylocality.com/2025/07/creating-a-local-landing-page-that-boosts-your-gbp-rankings/'
            };
            return trainingUrls[actionId] || `https://trylocality.com/blog/${actionId}`;
        }

        // Display simple action plan
        function displayActionPlanSimple(actionData) {
            const actionPlanList = document.getElementById('actionPlanList');
            let actionHTML = '';
            
            // Store action data globally for checkbox handling
            window.currentActionPlan = actionData.actions;
            
            // Load saved checkbox states from localStorage if available
            if (currentReportData && currentReportData.reportId) {
                const storageKey = `actionPlan_${currentReportData.reportId}`;
                const savedStates = localStorage.getItem(storageKey);
                if (savedStates) {
                    try {
                        const parsedStates = JSON.parse(savedStates);
                        // Merge saved states with current action plan
                        parsedStates.forEach((savedAction, index) => {
                            if (window.currentActionPlan[index]) {
                                window.currentActionPlan[index].completed = savedAction.completed;
                            }
                        });
                    } catch (e) {
                        console.error('Error loading saved action plan states:', e);
                    }
                }
            }
            
            window.currentActionPlan.forEach((action, index) => {
                const statusClass = action.completed ? 'completed' : 'incomplete';
                const checkmark = action.completed ? '' : '';
                const trainingUrl = getActionItemTrainingUrl(action.id);
                
                actionHTML += `
                    <div class="action-item-simple ${statusClass}" id="action-item-${index}">
                        <div class="action-checkbox" onclick="toggleActionCheckbox(${index})">${checkmark}</div>
                        <div class="action-text">
                            <span>${action.task}</span>
                            <a href="${trainingUrl}" target="_blank" class="action-arrow" title="Learn how to complete this task"></a>
                        </div>
                    </div>
                `;
            });
            
            actionPlanList.innerHTML = actionHTML;
        }

        // Toggle action checkbox
        function toggleActionCheckbox(index) {
            if (!window.currentActionPlan) return;
            
            // Toggle the completed status
            window.currentActionPlan[index].completed = !window.currentActionPlan[index].completed;
            
            // Update the UI
            const actionItem = document.getElementById(`action-item-${index}`);
            const checkbox = actionItem.querySelector('.action-checkbox');
            
            if (window.currentActionPlan[index].completed) {
                actionItem.classList.remove('incomplete');
                actionItem.classList.add('completed');
                checkbox.textContent = '';
            } else {
                actionItem.classList.remove('completed');
                actionItem.classList.add('incomplete');
                checkbox.textContent = '';
            }
            
            // Save to localStorage if we have a report ID
            if (currentReportData && currentReportData.reportId) {
                const storageKey = `actionPlan_${currentReportData.reportId}`;
                localStorage.setItem(storageKey, JSON.stringify(window.currentActionPlan));
            }
        }

        // Detailed Citation Analysis function
        async function runDetailedCitationAnalysis() {
            const button = document.getElementById('detailedAnalysisBtn');
            const loading = document.getElementById('detailedLoading');
            
            console.log(' Detailed Citation Analysis - Starting');
            console.log(' Button element:', button);
            console.log(' Loading element:', loading);
            
            if (!button) {
                console.error(' Button element not found');
                showToast('Error: Button element not found', 'error');
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'ANALYZING...';
            if (loading) {
                loading.style.display = 'block';
            }
            
            try {
                // Get business data from current report
                console.log(' Current report data:', currentReportData);
                
                // Try multiple paths to get business data
                const businessName = currentReportData?.businessName || 
                                   currentReportData?.business?.name ||
                                   currentReportData?.businessData?.name ||
                                   document.getElementById('reportBusinessName')?.textContent?.trim() || '';
                                   
                const phoneNumber = currentReportData?.business?.phone ||
                                  currentReportData?.businessData?.phone ||
                                  currentReportData?.phone || '';
                
                console.log(' Extracted business data:', { businessName, phoneNumber });
                
                if (!businessName) {
                    throw new Error('Business name not available. Please ensure a report is loaded.');
                }
                
                // Make API call - get fresh token from localStorage
                const currentAuthToken = localStorage.getItem('authToken');
                console.log(' Debug: Auth token exists:', !!currentAuthToken);
                console.log(' Debug: Current user:', currentUser);
                console.log(' Debug: Business data:', businessName, location);
                
                if (!currentAuthToken) {
                    console.error(' No auth token found in localStorage');
                    throw new Error('Not authenticated. Please log in again.');
                }
                
                // Get report ID for storing analysis results
                const reportId = currentReportData?.reportId;
                const requestPayload = {
                    businessName,
                    phoneNumber,
                    reportId
                };
                
                console.log(' Making API request to /api/detailed-citation-analysis');
                console.log(' Request payload:', requestPayload);
                
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
                
                const response = await fetch('/api/detailed-citation-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAuthToken}`
                    },
                    body: JSON.stringify(requestPayload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log(' Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(errorData.error || `Analysis failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log(' Detailed analysis response received:', data);
                displayDetailedResults(data);
                
            } catch (error) {
                console.error(' Detailed analysis error:', error);
                console.error(' Error stack:', error.stack);
                
                // Handle different error types
                let errorMessage = 'Unknown error occurred';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. The analysis is taking too long. Please try again later.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network error. Please check your connection and try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showToast(`Failed to run detailed citation analysis: ${errorMessage}`, 'error');
                
                // Also alert for visibility
                alert(`Detailed Citation Analysis Error:\n\n${errorMessage}\n\nPlease check the console for more details.`);
            } finally {
                // Reset button state
                if (button) {
                    button.disabled = false;
                    button.textContent = 'RUN DETAILED CITATION ANALYSIS';
                }
                if (loading) {
                    loading.style.display = 'none';
                }
            }
        }
        
        // Display detailed citation results
        function displayDetailedResults(data) {
            console.log(' Displaying detailed results:', data);
            
            // Hide the button after execution
            const button = document.getElementById('detailedAnalysisBtn');
            if (button) {
                button.style.display = 'none';
            }
            
            // Hide the subtext as well
            const subtext = document.querySelector('.detailed-analysis-subtext');
            if (subtext) {
                subtext.style.display = 'none';
            }
            
            // Update main citations display to show all 50 citations
            updateMainCitationsDisplay(data);
        }
        
        // Display stored detailed citation results (without duplicating original 10)
        function displayStoredDetailedResults(data) {
            console.log(' Displaying stored detailed results:', data);
            
            // Hide the button since analysis was already run
            const button = document.getElementById('detailedAnalysisBtn');
            if (button) {
                button.style.display = 'none';
            }
            
            // Hide the subtext as well
            const subtext = document.querySelector('.detailed-analysis-subtext');
            if (subtext) {
                subtext.style.display = 'none';
            }
            
            // Display only the detailed 40 citations without the original 10
            displayDetailedCitationsOnly(data);
        }
        
        // Display only the detailed 40 citations with compact spacing
        function displayDetailedCitationsOnly(detailedData) {
            console.log(' Displaying detailed citations only:', detailedData);
            
            try {
                const detailedCitations = detailedData.results || [];
                let detailedHTML = '';
                
                // Display detailed citations in rows of 5 with reduced spacing
                for (let i = 0; i < detailedCitations.length; i += 5) {
                    detailedHTML += '<div class="citations-row-compact">';
                    
                    for (let j = i; j < Math.min(i + 5, detailedCitations.length); j++) {
                        const citation = detailedCitations[j];
                        const status = citation.found ? 'found' : 'missing';
                        const icon = citation.found ? '' : citation.status === 'ERROR' ? '' : '';
                        
                        detailedHTML += `
                            <div class="citation-item-compact ${status}">
                                <div class="citation-name-compact">${citation.name || citation.directory}</div>
                                <div class="citation-icon">${icon}</div>
                            </div>`;
                    }
                    
                    detailedHTML += '</div>';
                }
                
                // Update the detailed citations container
                const detailedCitationsContainer = document.getElementById('detailedCitationsContainer');
                if (detailedCitationsContainer) {
                    detailedCitationsContainer.innerHTML = detailedHTML;
                }
                
                // Mark report as having detailed analysis for print styling
                const reportSection = document.getElementById('reportSection');
                if (reportSection) {
                    reportSection.classList.add('detailed-analysis-active');
                }
                
                // Add overall score, description, and order button
                const originalCitations = currentReportData.citationsAnalysis?.data?.checked?.slice(0, 10) || [];
                addDetailedCitationSummary(originalCitations, detailedCitations);
                
                console.log(' Detailed citations only displayed with compact spacing');
                
            } catch (error) {
                console.error(' ERROR in displayDetailedCitationsOnly:', error);
            }
        }
        
        // Update main citations display with detailed analysis (replaces original)
        function updateMainCitationsDisplay(detailedData) {
            console.log(' DEBUG: updateMainCitationsDisplay called with:', detailedData);
            
            try {
                const citationsSectionTitle = document.getElementById('citationsSectionTitle');
                const citationsRow = document.getElementById('citationsRow');
                
                console.log(' DEBUG: Found elements - title:', !!citationsSectionTitle, 'row:', !!citationsRow);
                
                // Update the section title to "Detailed Citation Analysis"
                if (citationsSectionTitle) {
                    citationsSectionTitle.textContent = 'Detailed Citation Analysis';
                    console.log(' DEBUG: Title updated successfully');
                }
            
            // Get original 10 citations and detailed 40 citations
            const originalCitations = currentReportData.citationsAnalysis?.data?.checked?.slice(0, 10) || [];
            const detailedCitations = detailedData.results || [];
            
            // Don't modify the original citations display (citationsRow) - it's already showing the first 10
            // Only update the detailed citations container with the additional 40
            
            // Update the detailed citations container (Page 2) with only the 40 additional citations
            const detailedCitationsContainer = document.getElementById('detailedCitationsContainer');
            if (detailedCitationsContainer && detailedCitations.length > 0) {
                let detailedHTML = '';
                
                // Display detailed citations in rows of 5 with compact spacing
                for (let i = 0; i < detailedCitations.length; i += 5) {
                    detailedHTML += '<div class="citations-row-compact">';
                    
                    for (let j = i; j < Math.min(i + 5, detailedCitations.length); j++) {
                        const citation = detailedCitations[j];
                        const status = citation.found ? 'found' : 'missing';
                        const icon = citation.found ? '' : citation.status === 'ERROR' ? '' : '';
                        
                        detailedHTML += `
                            <div class="citation-item-compact ${status}">
                                <div class="citation-name-compact">${citation.name || citation.directory}</div>
                                <div class="citation-icon">${icon}</div>
                            </div>`;
                    }
                    
                    detailedHTML += '</div>';
                }
                
                detailedCitationsContainer.innerHTML = detailedHTML;
            }
            
            // Mark report as having detailed analysis for print styling
            const reportSection = document.getElementById('reportSection');
            if (reportSection) {
                reportSection.classList.add('detailed-analysis-active');
            }
            
            // Add overall score, description, and order button after detailed analysis
            addDetailedCitationSummary(originalCitations, detailedCitations);
            
            console.log(' Citations display updated - showing detailed analysis with all 50 citations');
                
            } catch (error) {
                console.error(' ERROR in updateMainCitationsDisplay:', error);
                console.error(' ERROR stack:', error.stack);
                throw error; // Re-throw to let the calling function handle it
            }
        }
        
        // Add detailed citation summary with score, description, and order button
        function addDetailedCitationSummary(originalCitations, detailedCitations) {
            const allCitations = [...originalCitations, ...detailedCitations];
            const foundCount = allCitations.filter(citation => citation.found).length;
            const totalCount = allCitations.length;
            
            // Find the citations section to add summary after the header
            const citationsSection = document.getElementById('citationsSection');
            if (!citationsSection) {
                console.error(' Citations section not found');
                return;
            }
            
            // Remove existing summary if it exists
            const existingSummary = document.getElementById('detailedCitationSummary');
            if (existingSummary) {
                existingSummary.remove();
            }
            
            // Hide the original header text
            const headerText = citationsSection.querySelector('p');
            if (headerText) {
                headerText.style.display = 'none';
            }
            
            // Hide the detailed analysis section (button + subtext)
            const detailedAnalysisSection = document.querySelector('.detailed-analysis-section');
            if (detailedAnalysisSection) {
                detailedAnalysisSection.style.display = 'none';
            }
            
            // Create summary container
            const summaryHTML = `
                <div id="detailedCitationSummary" style="margin: 20px 0; padding: 25px; background: #f8f9fa; border-radius: 12px; border-left: 5px solid #17a2b8;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0; color: #0e192b; font-size: 1.4rem;">Citation Analysis Complete</h4>
                        <div style="text-align: right;">
                            <div style="font-size: 2rem; font-weight: 700; color: #17a2b8; margin-bottom: 5px;">${foundCount}/${totalCount}</div>
                            <div style="font-size: 0.9rem; color: #6c757d; font-weight: 600;">CITATIONS FOUND</div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="color: #0e192b; margin-bottom: 15px; font-size: 1.1rem;">Why Citations Matter for Local SEO</h5>
                        <p style="margin-bottom: 15px; line-height: 1.6; color: #495057;">
                            Citations are online mentions of your business name, address, and phone number (NAP) across directories, websites, and platforms. They're crucial for local SEO because:
                        </p>
                        <ul style="margin-bottom: 15px; padding-left: 20px; color: #495057; line-height: 1.6;">
                            <li><strong>Build Trust:</strong> Search engines use consistent citations to verify your business legitimacy</li>
                            <li><strong>Improve Rankings:</strong> More quality citations boost your local search visibility</li>
                            <li><strong>Increase Discovery:</strong> Citations help customers find you on multiple platforms</li>
                            <li><strong>Competitive Advantage:</strong> Businesses with more citations typically outrank competitors</li>
                        </ul>
                        <p style="margin: 0; color: #495057; line-height: 1.6;">
                            <strong>Missing ${totalCount - foundCount} citations?</strong> Each missing citation is a missed opportunity for better local rankings and customer discovery.
                        </p>
                    </div>
                    
                    <button class="order-citations-btn" onclick="orderCitations()" style="width: 100%; font-size: 1.1rem; padding: 15px;">
                         ORDER CITATION BUILDING SERVICE
                    </button>
                </div>
            `;
            
            // Insert summary after the header but before the citations
            const citationsPage1 = document.getElementById('citationsPage1');
            if (citationsPage1) {
                citationsPage1.insertAdjacentHTML('beforebegin', summaryHTML);
            } else {
                // Fallback to inserting after the section title
                const sectionTitle = document.getElementById('citationsSectionTitle');
                if (sectionTitle) {
                    sectionTitle.insertAdjacentHTML('afterend', summaryHTML);
                }
            }
            
            console.log(` Added detailed citation summary: ${foundCount}/${totalCount} citations found`);
        }

        // Order citations function - opens modal with pre-filled data
        function orderCitations() {
            const modal = document.getElementById('citationModal');

            // Pre-fill business information from current report
            const businessName = currentReportData?.business?.name || currentReportData?.businessName || '';
            const address = currentReportData?.business?.address || currentReportData?.business?.full_address || '';
            const phone = currentReportData?.business?.phone || '';

            document.getElementById('citationBusinessName').value = businessName;
            document.getElementById('citationAddress').value = address;
            document.getElementById('citationPhone').value = phone;

            // Capture citation analysis data for prioritization
            const citationAnalysis = currentReportData?.citationsAnalysis || currentReportData?.detailedCitationAnalysis;
            if (citationAnalysis) {
                // Store citation data in a hidden field or global variable
                window.citationPriorityData = {
                    missing: [],
                    found: [],
                    total: 0
                };

                // Extract missing and found citations
                if (citationAnalysis.data && citationAnalysis.data.checked) {
                    citationAnalysis.data.checked.forEach(citation => {
                        if (citation.found) {
                            window.citationPriorityData.found.push({
                                directory: citation.directory,
                                url: citation.url || ''
                            });
                        } else {
                            window.citationPriorityData.missing.push({
                                directory: citation.directory
                            });
                        }
                    });
                    window.citationPriorityData.total = citationAnalysis.data.checked.length;
                }

                // Also check detailed analysis if available
                if (citationAnalysis.detailedResults) {
                    citationAnalysis.detailedResults.forEach(citation => {
                        const status = citation.status?.toLowerCase() || '';
                        if (status === 'not found' || status === 'missing' || !citation.found) {
                            // Add to missing if not already there
                            if (!window.citationPriorityData.missing.some(c => c.directory === citation.directory)) {
                                window.citationPriorityData.missing.push({
                                    directory: citation.directory,
                                    issue: citation.issue || 'Not found'
                                });
                            }
                        }
                    });
                }

                console.log(' Citation priority data captured:', window.citationPriorityData);
            } else {
                console.warn(' No citation analysis data available for this report');
                window.citationPriorityData = null;
            }

            modal.style.display = 'block';
        }

        // Close citation modal
        function closeCitationModal() {
            document.getElementById('citationModal').style.display = 'none';
        }

        // Select package option
        function selectPackage(packageSize) {
            // Remove selected class from all options
            document.querySelectorAll('.citation-package-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selected class to clicked option
            event.currentTarget.classList.add('selected');

            // Check the radio button
            document.getElementById(`package${packageSize}`).checked = true;
        }

        // Submit citation order - creates Stripe checkout
        async function submitCitationOrder(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('citationSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            try {
                const formData = new FormData(event.target);
                const packageSize = formData.get('package');
                const businessName = formData.get('businessName');
                const address = formData.get('address');
                const phone = formData.get('phone');

                // Prepare citation priority data
                const citationData = window.citationPriorityData || { missing: [], found: [], total: 0 };

                console.log(` Submitting citation order with ${citationData.missing.length} missing citations to prioritize`);

                // Call backend to create Stripe checkout session
                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/create-citation-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        packageSize: parseInt(packageSize),
                        businessName,
                        address,
                        phone,
                        citationPriorities: {
                            missing: citationData.missing,
                            found: citationData.found,
                            totalAnalyzed: citationData.total,
                            missingCount: citationData.missing.length,
                            foundCount: citationData.found.length
                        }
                    })
                });

                const data = await response.json();

                if (response.ok && data.url) {
                    // Redirect to Stripe checkout
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || 'Failed to create checkout session');
                }
            } catch (error) {
                console.error('Citation order error:', error);
                showToast(error.message || 'Failed to process order. Please try again.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Proceed to Checkout';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('citationModal');
            if (event.target === modal) {
                closeCitationModal();
            }
        }

        // Buy credits function
        function buyCredits() {
            showPricingModal();
        }

        // Download PDF function
        function downloadPDF() {
            // Hide non-printable elements
            const elementsToHide = document.querySelectorAll('.btn, .report-actions, .how-to-fix-btn, .detailed-analysis-btn, .order-citations-cta-btn, .detailed-analysis-subtext, #detailedCitationSummary');
            elementsToHide.forEach(el => el.style.display = 'none');

            // Ensure proper print layout classes are applied
            const reportSection = document.getElementById('reportSection');
            const hasDetailedAnalysis = reportSection && reportSection.classList.contains('detailed-analysis-active');

            console.log(` Generating PDF - Detailed analysis: ${hasDetailedAnalysis}`);

            // Trigger print
            window.print();

            // Restore elements after print
            setTimeout(() => {
                elementsToHide.forEach(el => el.style.display = '');
            }, 1000);
        }

        // Competitive Analysis function
        async function runCompetitiveAnalysis() {
            if (!currentReportData) {
                showToast('No report data available. Please generate a report first.', 'error');
                return;
            }

            // Extract business info from current report
            // Backend returns: { business: { name, location, industry, website } }
            const businessName = currentReportData.business?.name || currentReportData.businessName || currentReportData.businessInfo?.businessName;
            const location = currentReportData.business?.location || currentReportData.location || currentReportData.businessInfo?.location;
            const industry = currentReportData.business?.industry || currentReportData.industry || currentReportData.businessInfo?.industry;

            if (!businessName || !location || !industry) {
                showToast('Missing business information. Cannot run competitive analysis.', 'error');
                console.error('Missing data:', { businessName, location, industry });
                return;
            }

            // Confirm with user
            const confirmed = confirm(`Run competitive analysis for ${businessName}?\n\nThis will analyze businesses ranking around you in Google Maps.\n\nNote: This costs credits based on how many businesses are analyzed (typically 6-11 businesses).`);

            if (!confirmed) {
                return;
            }

            try {
                showToast('Starting competitive analysis... This may take 1-2 minutes.', 'info');

                const token = localStorage.getItem('authToken');
                const response = await fetch('/api/competitive-analysis-around-business', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        businessName: businessName,
                        location: location,
                        industry: industry
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Store the report data in localStorage and redirect to competitive analysis page
                    localStorage.setItem('bulkReportData', JSON.stringify(data));
                    showToast(`Competitive analysis complete! Analyzed ${data.searchCriteria.totalScanned} businesses.`, 'success');

                    // Redirect to competitive analysis page after a short delay
                    setTimeout(() => {
                        window.location.href = 'competitive-analysis.html';
                    }, 1000);
                } else if (response.status === 402) {
                    // Insufficient credits
                    showToast(data.error || 'Insufficient credits for competitive analysis.', 'error');

                    // Prompt user to buy credits
                    setTimeout(() => {
                        const buyCreds = confirm(`${data.error}\n\nWould you like to purchase more credits?`);
                        if (buyCreds) {
                            buyCredits();
                        }
                    }, 500);
                } else if (response.status === 404) {
                    // Business not found in rankings
                    showToast(data.error || 'Business not found in rankings.', 'error');
                    if (data.suggestion) {
                        alert(`${data.error}\n\nTip: ${data.suggestion}`);
                    }
                } else {
                    throw new Error(data.error || 'Failed to run competitive analysis');
                }
            } catch (error) {
                console.error('Competitive analysis error:', error);
                showToast('Failed to run competitive analysis. Please try again.', 'error');
            }
        }

        // Account Menu Functions
        function toggleAccountMenu() {
            const trigger = document.getElementById('menuTrigger');
            const dropdown = document.getElementById('accountDropdownMenu');
            
            trigger.classList.toggle('active');
            dropdown.classList.toggle('show');
            
            // Close menu when clicking outside
            if (dropdown.classList.contains('show')) {
                document.addEventListener('click', closeMenuOnClickOutside);
            } else {
                document.removeEventListener('click', closeMenuOnClickOutside);
            }
        }
        
        function closeMenuOnClickOutside(event) {
            const menu = document.querySelector('.account-menu');
            if (!menu.contains(event.target)) {
                closeAccountMenu();
            }
        }
        
        function closeAccountMenu() {
            const trigger = document.getElementById('menuTrigger');
            const dropdown = document.getElementById('accountDropdownMenu');
            
            trigger.classList.remove('active');
            dropdown.classList.remove('show');
            document.removeEventListener('click', closeMenuOnClickOutside);
        }
        
        // Menu Item Handlers
        function handlePurchaseCredits() {
            closeAccountMenu();
            buyCredits();
        }

        function handleAppSumoRedeem() {
            closeAccountMenu();
            showAppSumoModal();
        }

        function handleAccountSettings() {
            closeAccountMenu();
            showAccountSettingsModal();
        }
        
        function handleWhiteLabelSettings() {
            closeAccountMenu();
            showWhiteLabelModal();
        }
        
        function handleBillingHistory() {
            closeAccountMenu();
            showBillingHistoryModal();
        }
        
        // Billing History Modal Functions
        function showBillingHistoryModal() {
            document.getElementById('billingHistoryModal').classList.remove('hidden');
            document.getElementById('billingHistoryModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            loadBillingHistory();
        }
        
        function closeBillingHistoryModal() {
            document.getElementById('billingHistoryModal').classList.remove('show');
            document.getElementById('billingHistoryModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        async function loadBillingHistory() {
            try {
                // Show loading state
                document.getElementById('billingHistoryLoading').classList.remove('hidden');
                document.getElementById('billingHistoryEmpty').classList.add('hidden');
                document.getElementById('billingHistoryError').classList.add('hidden');
                document.getElementById('billingHistoryTable').classList.add('hidden');
                
                console.log(' Loading billing history...');
                
                const response = await fetch('/api/billing-history', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    console.log(` Loaded ${data.payments.length} payment records`);
                    
                    // Hide loading state
                    document.getElementById('billingHistoryLoading').classList.add('hidden');
                    
                    if (data.payments.length === 0) {
                        // Show empty state
                        document.getElementById('billingHistoryEmpty').classList.remove('hidden');
                    } else {
                        // Show billing history table
                        displayBillingHistory(data.payments);
                        document.getElementById('billingHistoryTable').classList.remove('hidden');
                    }
                } else {
                    throw new Error(data.error || 'Failed to load billing history');
                }
                
            } catch (error) {
                console.error(' Billing history error:', error);
                
                // Hide loading state and show error
                document.getElementById('billingHistoryLoading').classList.add('hidden');
                document.getElementById('billingHistoryError').classList.remove('hidden');
                
                showToast('Failed to load billing history', 'error');
            }
        }
        
        function displayBillingHistory(payments) {
            const tbody = document.getElementById('billingHistoryTableBody');
            tbody.innerHTML = '';
            
            payments.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e9ecef';
                
                // Alternate row colors
                if (index % 2 === 0) {
                    row.style.backgroundColor = '#fafafa';
                }
                
                // Add hover effect
                row.onmouseover = () => row.style.backgroundColor = '#f0f8ff';
                row.onmouseout = () => row.style.backgroundColor = index % 2 === 0 ? '#fafafa' : 'white';
                
                // Status badge styling
                let statusBadge = '';
                if (payment.status === 'Completed') {
                    statusBadge = `<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"> ${payment.status}</span>`;
                } else {
                    statusBadge = `<span style="background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;"> ${payment.status}</span>`;
                }
                
                row.innerHTML = `
                    <td style="padding: 15px; color: #333;">${payment.date}</td>
                    <td style="padding: 15px; color: #333; font-weight: 500;">${payment.planType}</td>
                    <td style="padding: 15px; text-align: center; color: #0e192b; font-weight: 600;">${payment.credits}</td>
                    <td style="padding: 15px; text-align: right; color: #0e192b; font-weight: 600; font-size: 1.1rem;">$${payment.amount}</td>
                    <td style="padding: 15px; text-align: center;">${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log(` Displayed ${payments.length} payment records in table`);
        }

        // AppSumo Modal Functions
        function showAppSumoModal() {
            document.getElementById('appsumoModal').classList.remove('hidden');
            document.getElementById('appsumoModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            document.getElementById('appsumoCode').value = '';
            document.getElementById('appsumoError').classList.add('hidden');
            document.getElementById('appsumoSuccess').classList.add('hidden');
        }

        function closeAppSumoModal() {
            document.getElementById('appsumoModal').classList.remove('show');
            document.getElementById('appsumoModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function redeemAppSumoCode(event) {
            event.preventDefault();

            const code = document.getElementById('appsumoCode').value.trim();
            const errorEl = document.getElementById('appsumoError');
            const successEl = document.getElementById('appsumoSuccess');

            // Hide previous messages
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            try {
                const response = await fetch('/api/redeem-appsumo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show success message
                    successEl.textContent = data.message;
                    successEl.classList.remove('hidden');

                    // Update user credits display
                    if (data.plan && data.plan.creditsNow) {
                        updateCreditsDisplay(data.plan.creditsNow);
                    }

                    // Close modal after 3 seconds
                    setTimeout(() => {
                        closeAppSumoModal();
                        showToast(`AppSumo activated! You now have ${data.plan.monthlyCredits} credits/month for life!`, 'success');

                        // Reload page to update user data
                        setTimeout(() => window.location.reload(), 2000);
                    }, 3000);

                } else {
                    // Show error message
                    errorEl.textContent = data.error || 'Failed to redeem code';
                    errorEl.classList.remove('hidden');
                }

            } catch (error) {
                console.error('AppSumo redemption error:', error);
                errorEl.textContent = 'Failed to connect to server. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        // Cancellation Modal Functions
        function showCancellationModal() {
            closeBillingHistoryModal();
            document.getElementById('cancellationModal').classList.remove('hidden');
            document.getElementById('cancellationModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function closeCancellationModal() {
            document.getElementById('cancellationModal').classList.remove('show');
            document.getElementById('cancellationModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('cancellationForm').reset();
            document.getElementById('cancellationError').classList.add('hidden');
        }
        
        // Initialize cancellation form event listener
        setTimeout(() => {
            const cancellationForm = document.getElementById('cancellationForm');
            if (cancellationForm) {
                cancellationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const reason = document.getElementById('cancellationReason').value;
                    const feedback = document.getElementById('cancellationFeedback').value;
                    
                    if (!reason) {
                        document.getElementById('cancellationError').textContent = 'Please select a reason for cancellation';
                        document.getElementById('cancellationError').classList.remove('hidden');
                        return;
                    }
                    
                    // Disable submit button
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Processing...';
                    
                    try {
                        const response = await fetch('/api/cancel-subscription', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                reason: reason,
                                feedback: feedback,
                                timestamp: new Date().toISOString()
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            showToast('Subscription cancelled successfully', 'success');
                            closeCancellationModal();
                            
                            // Update user data
                            currentUser.subscriptionTier = 'free';
                            currentUser.creditsRemaining = 0;
                            updateDashboard();
                            
                            // Refresh the page after a short delay
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            throw new Error(data.error || 'Failed to cancel subscription');
                        }
                    } catch (error) {
                        console.error('Cancellation error:', error);
                        document.getElementById('cancellationError').textContent = error.message || 'Failed to cancel subscription. Please try again.';
                        document.getElementById('cancellationError').classList.remove('hidden');
                        
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                });
            }
        }, 100);
        
        function handleSupportHelp() {
            closeAccountMenu();
            // Placeholder for support functionality
            window.open('mailto:trylocality@gmail.com?subject=Support Request', '_blank');
            showToast('Opening email client for support...', 'info');
        }
        
        function handleDFYServices() {
            closeAccountMenu();
            window.open('https://trylocality.com/get-found-online/', '_blank');
            showToast('Opening DFY SEO Services...', 'info');
        }
        
        function handleLogout() {
            closeAccountMenu();
            logout();
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            userReports = [];
            showLogin();
            showToast('Logged out successfully', 'success');
            console.log(' User logged out');
        }

        // Feedback Form Functions
        function showFeedbackForm() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            document.getElementById('feedbackModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeFeedbackForm() {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('feedbackForm').reset();
            document.getElementById('feedbackRating').value = '';
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.getElementById('feedbackError').classList.add('hidden');
            document.getElementById('feedbackSuccess').classList.add('hidden');
        }

        // Account Settings Functions
        function showAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.remove('hidden');
            document.getElementById('accountSettingsModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            loadAccountSettings();
        }

        function closeAccountSettingsModal() {
            document.getElementById('accountSettingsModal').classList.remove('show');
            document.getElementById('accountSettingsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset password fields and collapse section
            const passwordFields = document.getElementById('passwordFields');
            const passwordArrow = document.getElementById('passwordToggleArrow');
            if (passwordFields && passwordArrow) {
                passwordFields.style.display = 'none';
                passwordArrow.style.transform = 'rotate(0deg)';
            }
            
            // Clear password form fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        function togglePasswordSection() {
            const passwordFields = document.getElementById('passwordFields');
            const passwordArrow = document.getElementById('passwordToggleArrow');
            
            if (passwordFields.style.display === 'none' || passwordFields.style.display === '') {
                passwordFields.style.display = 'block';
                passwordArrow.style.transform = 'rotate(180deg)';
            } else {
                passwordFields.style.display = 'none';
                passwordArrow.style.transform = 'rotate(0deg)';
                
                // Clear password fields when collapsing
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
        }

        function handleManageAccount() {
            closeAccountSettingsModal();
            showPricingModal();
            showToast('Manage your plan and purchase additional credits below', 'info');
        }

        async function loadAccountSettings() {
            try {
                // Load current user data
                if (currentUser) {
                    document.getElementById('settingsFirstName').value = currentUser.firstName || '';
                    document.getElementById('settingsLastName').value = currentUser.lastName || '';
                    document.getElementById('accountPlan').textContent = formatPlanName(currentUser.subscriptionTier || 'free');
                    document.getElementById('accountCredits').textContent = currentUser.creditsRemaining || 0;
                    
                    // Check white label status
                    const currentAuthToken = localStorage.getItem('authToken');
                    const response = await fetch('/api/white-label', {
                        headers: {
                            'Authorization': `Bearer ${currentAuthToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const isEnabled = data.settings?.enabled || false;
                        document.getElementById('accountWhiteLabel').textContent = isEnabled ? 'Enabled' : 'Disabled';
                    } else {
                        document.getElementById('accountWhiteLabel').textContent = 'Disabled';
                    }
                }
            } catch (error) {
                console.error('Error loading account settings:', error);
                document.getElementById('accountWhiteLabel').textContent = 'Unknown';
            }
        }

        function formatPlanName(tier) {
            const planNames = {
                'free': 'Free',
                'pro': 'Pro',
                'premium': 'Premium',
                'starter': 'Pro', // Backward compatibility
                'professional': 'Premium',
                'agency': 'Premium',
                'unlimited': 'Unlimited'
            };
            return planNames[tier] || tier.charAt(0).toUpperCase() + tier.slice(1);
        }

        // White Label Functions
        function showWhiteLabelModal() {
            document.getElementById('whiteLabelModal').classList.remove('hidden');
            document.getElementById('whiteLabelModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            loadWhiteLabelSettings();
        }

        function closeWhiteLabelModal() {
            document.getElementById('whiteLabelModal').classList.remove('show');
            document.getElementById('whiteLabelModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        async function loadWhiteLabelSettings() {
            try {
                const currentAuthToken = localStorage.getItem('authToken');
                const response = await fetch('/api/white-label', {
                    headers: {
                        'Authorization': `Bearer ${currentAuthToken}`
                    }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Populate form fields
                    document.getElementById('customBrandName').value = settings.custom_brand_name || '';
                    document.getElementById('customContactName').value = settings.custom_contact_name || '';
                    document.getElementById('customContactEmail').value = settings.custom_contact_email || '';
                    document.getElementById('customContactPhone').value = settings.custom_contact_phone || '';
                    document.getElementById('customPreparedBy').value = settings.custom_prepared_by || '';
                    document.getElementById('customPrimaryColor').value = settings.custom_primary_color || '#0e192b';
                    document.getElementById('customPrimaryColorText').value = settings.custom_primary_color || '#0e192b';
                    document.getElementById('whiteLabelEnabled').checked = settings.white_label_enabled || false;
                    
                    // Handle remove logo option - if no logo exists, check the remove logo option
                    const removeLogoCheckbox = document.getElementById('removeLogo');
                    if (removeLogoCheckbox) {
                        const hasLogo = settings.custom_brand_logo && settings.custom_brand_logo.trim() !== '';
                        removeLogoCheckbox.checked = !hasLogo;
                        
                        // Update preview logo display
                        const previewLogo = document.getElementById('previewLogo');
                        if (!hasLogo) {
                            previewLogo.style.display = 'none';
                        }
                    }
                    
                    // Update preview
                    updateWhiteLabelPreview();
                }
            } catch (error) {
                console.error('Error loading white label settings:', error);
                showToast('Failed to load white label settings', 'error');
            }
        }

        function updateWhiteLabelPreview() {
            const brandName = document.getElementById('customBrandName').value;
            const contactName = document.getElementById('customContactName').value;
            const contactEmail = document.getElementById('customContactEmail').value;
            const contactPhone = document.getElementById('customContactPhone').value;
            const preparedBy = document.getElementById('customPreparedBy').value;
            const primaryColor = document.getElementById('customPrimaryColor').value;
            const enabled = document.getElementById('whiteLabelEnabled').checked;
            
            // Update preview elements
            const previewScoreCircle = document.getElementById('previewScoreCircle');
            const previewPreparedBy = document.getElementById('previewPreparedBy');
            const previewContact = document.getElementById('previewContact');
            const previewContactName = document.getElementById('previewContactName');
            const previewContactEmail = document.getElementById('previewContactEmail');
            const previewContactPhone = document.getElementById('previewContactPhone');
            
            if (enabled) {
                previewScoreCircle.style.backgroundColor = primaryColor;
                previewPreparedBy.textContent = preparedBy || brandName + ' Marketing';
                
                if (contactName || contactEmail || contactPhone) {
                    previewContact.style.display = 'block';
                    previewContactName.textContent = contactName || '';
                    previewContactEmail.textContent = contactEmail || '';
                    previewContactPhone.textContent = contactPhone || '';
                } else {
                    previewContact.style.display = 'none';
                }
            } else {
                previewScoreCircle.style.backgroundColor = '#0e192b';
                previewPreparedBy.textContent = 'Locality Marketing';
                previewContact.style.display = 'none';
            }
        }

        function removeLogo() {
            document.getElementById('logoUpload').value = '';
            document.getElementById('logoPreview').style.display = 'none';
            
            // Update preview logo to show default
            const previewLogo = document.getElementById('previewLogo');
            previewLogo.innerHTML = '<span style="font-size: 1.5rem; font-weight: bold; color: #0e192b;">Locality</span>';
            
            // Uncheck the remove logo checkbox
            document.getElementById('removeLogo').checked = false;
        }

        // Add event listeners for white label form
        // Account Settings Form Handler
        document.getElementById('accountSettingsForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            
            try {
                const formData = new FormData(e.target);
                const updates = {};
                
                // Check if name fields have changed
                const firstName = formData.get('firstName').trim();
                const lastName = formData.get('lastName').trim();
                
                if (firstName !== currentUser.firstName) {
                    updates.firstName = firstName;
                }
                if (lastName !== currentUser.lastName) {
                    updates.lastName = lastName;
                }
                
                // Check if password fields are filled
                const currentPassword = formData.get('currentPassword');
                const newPassword = formData.get('newPassword');
                const confirmPassword = formData.get('confirmPassword');
                
                if (newPassword) {
                    if (!currentPassword) {
                        showToast('Please enter your current password', 'error');
                        submitBtn.textContent = 'Save Changes';
                        submitBtn.disabled = false;
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showToast('New passwords do not match', 'error');
                        submitBtn.textContent = 'Save Changes';
                        submitBtn.disabled = false;
                        return;
                    }
                    if (newPassword.length < 6) {
                        showToast('New password must be at least 6 characters', 'error');
                        submitBtn.textContent = 'Save Changes';
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    updates.currentPassword = currentPassword;
                    updates.newPassword = newPassword;
                }
                
                // Only proceed if there are updates
                if (Object.keys(updates).length === 0) {
                    showToast('No changes to save', 'info');
                    closeAccountSettingsModal();
                    return;
                }
                
                const currentAuthToken = localStorage.getItem('authToken');
                const response = await fetch('/api/user/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAuthToken}`
                    },
                    body: JSON.stringify(updates)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    let errorMessage = 'Failed to update account settings';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // If not JSON, use the text
                        errorMessage = errorText || errorMessage;
                    }
                    showToast(errorMessage, 'error');
                    return;
                }
                
                const result = await response.json();
                console.log('Update successful:', result);
                
                showToast('Account settings updated successfully!', 'success');
                
                // Update currentUser object
                if (updates.firstName) currentUser.firstName = updates.firstName;
                if (updates.lastName) currentUser.lastName = updates.lastName;
                
                // Update display name in UI
                updateUserDisplay();
                
                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                closeAccountSettingsModal();
                
            } catch (error) {
                console.error('Error updating account settings:', error);
                console.error('Error details:', error.message, error.stack);
                showToast('Failed to update settings. Please check console for details.', 'error');
            } finally {
                submitBtn.textContent = 'Save Changes';
                submitBtn.disabled = false;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Logo upload handler
            const logoUpload = document.getElementById('logoUpload');
            if (logoUpload) {
                logoUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewImg = document.getElementById('logoPreviewImg');
                            const previewDiv = document.getElementById('logoPreview');
                            previewImg.src = e.target.result;
                            previewDiv.style.display = 'block';
                            
                            // Update preview logo
                            const previewLogo = document.getElementById('previewLogo');
                            previewLogo.innerHTML = `<img src="${e.target.result}" alt="Logo" style="max-height: 100%; max-width: 120px;">`;
                            
                            // Uncheck remove logo completely when new logo is uploaded
                            document.getElementById('removeLogo').checked = false;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Remove logo completely checkbox handler
            const removeLogoCheckbox = document.getElementById('removeLogo');
            if (removeLogoCheckbox) {
                removeLogoCheckbox.addEventListener('change', function() {
                    const previewLogo = document.getElementById('previewLogo');
                    
                    if (this.checked) {
                        // Hide logo completely
                        previewLogo.style.display = 'none';
                        
                        // Clear any uploaded logo
                        document.getElementById('logoUpload').value = '';
                        document.getElementById('logoPreview').style.display = 'none';
                    } else {
                        // Show default logo
                        previewLogo.style.display = 'block';
                        previewLogo.innerHTML = '<span style="font-size: 1.5rem; font-weight: bold; color: #0e192b;">Locality</span>';
                    }
                });
            }
            
            // Color picker sync
            const colorPicker = document.getElementById('customPrimaryColor');
            const colorText = document.getElementById('customPrimaryColorText');
            if (colorPicker && colorText) {
                colorPicker.addEventListener('change', function() {
                    colorText.value = this.value;
                    updateWhiteLabelPreview();
                });
                
                colorText.addEventListener('input', function() {
                    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                        colorPicker.value = this.value;
                        updateWhiteLabelPreview();
                    }
                });
            }
            
            // Live preview updates
            const previewInputs = ['customBrandName', 'customContactName', 'customContactEmail', 'customContactPhone', 'customPreparedBy', 'whiteLabelEnabled'];
            previewInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateWhiteLabelPreview);
                    element.addEventListener('change', updateWhiteLabelPreview);
                }
            });
            
            // White label form submission
            const whiteLabelForm = document.getElementById('whiteLabelForm');
            if (whiteLabelForm) {
                whiteLabelForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;
                    
                    try {
                        const currentAuthToken = localStorage.getItem('authToken');
                        const formData = {
                            custom_brand_name: document.getElementById('customBrandName').value,
                            custom_contact_name: document.getElementById('customContactName').value,
                            custom_contact_email: document.getElementById('customContactEmail').value,
                            custom_contact_phone: document.getElementById('customContactPhone').value,
                            custom_prepared_by: document.getElementById('customPreparedBy').value,
                            custom_primary_color: document.getElementById('customPrimaryColor').value,
                            white_label_enabled: document.getElementById('whiteLabelEnabled').checked,
                            remove_logo_completely: document.getElementById('removeLogo').checked
                        };
                        
                        const response = await fetch('/api/white-label', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${currentAuthToken}`
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            showToast('White label settings saved successfully!', 'success');
                            closeWhiteLabelModal();
                        } else {
                            showToast(result.error || 'Failed to save white label settings', 'error');
                        }
                    } catch (error) {
                        console.error('Error saving white label settings:', error);
                        showToast('Network error. Please try again.', 'error');
                    } finally {
                        submitBtn.textContent = 'Save & Apply';
                        submitBtn.disabled = false;
                    }
                });
            }
        });
        

        // Star rating functionality
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('feedbackRating');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    ratingInput.value = rating;
                    
                    // Update star display
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
                
                star.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(ratingInput.value) || 0;
                    stars.forEach((s, i) => {
                        if (i < currentRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
            
            // Handle feedback form submission
            document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const rating = document.getElementById('feedbackRating').value;
                const type = document.getElementById('feedbackType').value;
                const message = document.getElementById('feedbackMessage').value;
                const email = document.getElementById('feedbackEmail').value;
                const errorDiv = document.getElementById('feedbackError');
                const successDiv = document.getElementById('feedbackSuccess');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                
                // Validate required fields
                if (!rating) {
                    errorDiv.textContent = 'Please select a star rating';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!type) {
                    errorDiv.textContent = 'Please select a feedback type';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!message.trim()) {
                    errorDiv.textContent = 'Please enter your feedback';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                // Clear previous messages
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                
                // Disable submit button
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                try {
                    // Get fresh auth token from localStorage
                    const currentAuthToken = localStorage.getItem('authToken');
                    if (!currentAuthToken) {
                        throw new Error('Not authenticated. Please log in again.');
                    }
                    
                    const response = await fetch('/api/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentAuthToken}`
                        },
                        body: JSON.stringify({
                            rating: parseInt(rating),
                            type,
                            message: message.trim(),
                            email: email.trim() || null,
                            reportData: currentReportData ? {
                                businessName: currentReportData.businessName,
                                location: currentReportData.location,
                                industry: currentReportData.industry
                            } : null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        successDiv.textContent = 'Thank you for your feedback! We appreciate your input.';
                        successDiv.classList.remove('hidden');
                        
                        // Reset form after successful submission
                        setTimeout(() => {
                            closeFeedbackForm();
                        }, 2000);
                    } else {
                        errorDiv.textContent = result.error || 'Failed to submit feedback. Please try again.';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Feedback submission error:', error);
                    errorDiv.textContent = 'Network error. Please check your connection and try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    // Re-enable submit button
                    submitBtn.textContent = 'Submit Feedback';
                    submitBtn.disabled = false;
                }
            });
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('feedbackModal');
            if (event.target === modal) {
                closeFeedbackForm();
            }
            
            const pricingModal = document.getElementById('pricingModal');
            if (event.target === pricingModal) {
                closePricingModal();
            }
        });

        // Track if we're purchasing from unlock modal
        let isPurchasingFromUnlockModal = false;
        
        // Pricing Modal Functions
        function showPricingModal(highlightSingle = false, fromUnlockModal = false) {
            // Track if we're coming from unlock modal
            isPurchasingFromUnlockModal = fromUnlockModal;
            
            // Remove any unlock overlay when opening pricing modal
            const unlockOverlay = document.getElementById('unlockReportOverlay');
            if (unlockOverlay) {
                unlockOverlay.remove();
            }
            
            const modal = document.getElementById('pricingModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Highlight single report if coming from preview
            if (highlightSingle) {
                const singleCard = modal.querySelector('.pricing-modal-card:first-child');
                if (singleCard) {
                    singleCard.style.animation = 'pulse 1s ease-in-out';
                    setTimeout(() => singleCard.style.animation = '', 1000);
                }
            }
        }

        function closePricingModal() {
            const modal = document.getElementById('pricingModal');
            modal.style.display = 'none';
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset the unlock modal flag when closing pricing modal
            isPurchasingFromUnlockModal = false;
        }

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Check if user is logged in
        function checkAuthForPricing() {
            const token = getAuthToken();
            if (!token) {
                showToast('Please log in to purchase credits', 'warning');
                showLogin();
                return false;
            }
            return true;
        }

        // Poll for payment completion
        let paymentPollingInterval = null;
        let lastCreditsCount = null;
        
        function startPaymentPolling() {
            // Store current credits count
            lastCreditsCount = currentUser?.creditsRemaining || 0;
            
            // Clear any existing polling
            if (paymentPollingInterval) {
                clearInterval(paymentPollingInterval);
            }
            
            // Poll every 3 seconds for up to 5 minutes
            let pollCount = 0;
            const maxPolls = 100; // 5 minutes at 3 second intervals
            
            paymentPollingInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch('/api/profile', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const newCreditsCount = data.user.creditsRemaining;
                        
                        // Check if credits increased
                        if (newCreditsCount > lastCreditsCount) {
                            // Payment successful!
                            currentUser = data.user;
                            updateDashboard();
                            showToast('Payment successful! Your credits have been added.', 'success');
                            clearInterval(paymentPollingInterval);
                            paymentPollingInterval = null;
                            
                            // Close pricing modal if open
                            closePricingModal();
                        }
                    }
                } catch (error) {
                    console.error('Payment polling error:', error);
                }
                
                // Stop polling after max attempts
                if (pollCount >= maxPolls) {
                    clearInterval(paymentPollingInterval);
                    paymentPollingInterval = null;
                }
            }, 3000);
        }

        // Pricing modal specific functions
        async function purchaseSingleReportModal() {
            if (!checkAuthForPricing()) return;
            
            try {
                showToast('Redirecting to checkout...', 'info');
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ priceType: 'oneTime' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                    showToast('Opening checkout in a new tab...', 'info');
                    
                    // Start polling for payment completion
                    startPaymentPolling();
                } else {
                    showToast(data.error || 'Failed to create checkout session', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to process checkout. Please try again.', 'error');
            }
        }

        async function subscribePlanModal(plan) {
            if (!checkAuthForPricing()) return;
            
            try {
                showToast('Redirecting to checkout...', 'info');
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ priceType: plan })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.open(data.url, '_blank');
                    showToast('Opening checkout in a new tab...', 'info');
                    
                    // Start polling for payment completion
                    startPaymentPolling();
                } else {
                    showToast(data.error || 'Failed to create checkout session', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to process checkout. Please try again.', 'error');
            }
        }

        // ==========================================
        // PROFILE VERIFICATION FUNCTIONS
        // ==========================================
        
        let selectedProfileId = null;
        let profileOptions = [];
        
        // Function to verify business profile and show options
        async function verifyBusinessProfile(businessName, location) {
            console.log(` Verifying profile for: ${businessName} in ${location}`);
            
            try {
                const response = await fetch('/api/verify-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ businessName, location })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: response.statusText }));
                    throw new Error(errorData.error || `Profile verification failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success || !data.profiles || data.profiles.length === 0) {
                    throw new Error('No business profiles found');
                }
                
                console.log(` Found ${data.profiles.length} profile options`);
                
                if (data.profiles.length === 1) {
                    // Only one profile found - use it directly (loading screen already showing)
                    console.log(' Single profile found, proceeding directly to report generation');
                    try {
                        await generateReportWithProfile(data.profiles[0]);
                    } catch (reportError) {
                        console.error(' Report generation failed:', reportError);
                        hideAllSections();
                        showReportForm();
                        showToast('Failed to generate report. Please try again.', 'error');
                        throw reportError;
                    }
                } else if (data.profiles.length > 1) {
                    // Multiple profiles - show verification UI over the loading screen
                    console.log(' Multiple profiles found, showing verification UI');
                    showProfileVerification(data.profiles, data.searchQuery);
                } else {
                    throw new Error('No business profiles found for the provided information');
                }
                
            } catch (error) {
                console.error(' Profile verification error:', error);
                // If profile verification fails, try generating report without profile (loading already showing)
                console.log(' Falling back to report generation without profile verification');
                try {
                    await generateReportWithProfile(null);
                } catch (reportError) {
                    console.error(' Report generation also failed:', reportError);
                    throw error; // Throw original error
                }
            }
        }
        
        // Function to show profile verification UI
        function showProfileVerification(profiles, searchQuery) {
            profileOptions = profiles;
            selectedProfileId = null;
            
            // Update search info display
            document.getElementById('searchedBusinessName').textContent = searchQuery.businessName;
            document.getElementById('searchedLocation').textContent = searchQuery.location;
            
            // Populate profile options
            const container = document.getElementById('profileOptionsContainer');
            container.innerHTML = '';
            
            profiles.forEach(profile => {
                const profileCard = document.createElement('div');
                profileCard.className = 'profile-option-card';
                profileCard.onclick = () => selectProfile(profile.id);
                
                const statusClass = profile.verified ? 'verified' : 'unverified';
                const statusText = profile.verified ? 'Verified/Claimed' : 'Not Claimed';
                
                profileCard.innerHTML = `
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-address">${profile.address}</div>
                    <div class="profile-details">
                        <div class="profile-detail-item">
                            <span></span>
                            <span>${profile.phone}</span>
                        </div>
                        <div class="profile-detail-item">
                            <span></span>
                            <span>${profile.rating}/5 (${profile.reviews} reviews)</span>
                        </div>
                        <div class="profile-detail-item">
                            <span class="profile-status ${statusClass}">${statusText}</span>
                        </div>
                        ${profile.website ? `<div class="profile-detail-item"><span></span><span>${profile.website}</span></div>` : ''}
                    </div>
                `;
                
                container.appendChild(profileCard);
            });
            
            // Add continue button
            const continueBtn = document.createElement('button');
            continueBtn.className = 'verify-profile-btn';
            continueBtn.textContent = 'Continue with Selected Profile';
            continueBtn.disabled = true;
            continueBtn.onclick = proceedWithSelectedProfile;
            container.appendChild(continueBtn);
            
            // Show the verification section
            hideAllSections();
            document.getElementById('profileVerificationSection').classList.remove('hidden');
        }
        
        // Function to select a profile
        function selectProfile(profileId) {
            selectedProfileId = profileId;
            
            // Update UI - remove selection from all cards
            document.querySelectorAll('.profile-option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const cards = document.querySelectorAll('.profile-option-card');
            if (cards[profileId]) {
                cards[profileId].classList.add('selected');
            }
            
            // Enable continue button
            document.querySelector('.verify-profile-btn').disabled = false;
            
            console.log(` Profile ${profileId} selected: ${profileOptions[profileId].name}`);
        }
        
        // Function to proceed with selected profile
        async function proceedWithSelectedProfile() {
            if (selectedProfileId === null) {
                showToast('Please select a business profile to continue', 'error');
                return;
            }
            
            const selectedProfile = profileOptions[selectedProfileId];
            console.log(` Proceeding with selected profile: ${selectedProfile.name}`);
            
            // Go back to loading screen
            showLoading();
            
            try {
                await generateReportWithProfile(selectedProfile);
            } catch (error) {
                console.error(' Report generation error:', error);
                hideAllSections();
                showReportForm();
                showToast('Failed to generate report. Please try again.', 'error');
            }
        }
        
        // Function to generate report with selected profile
        async function generateReportWithProfile(selectedProfile) {
            console.log(` Generating report${selectedProfile ? ` with profile: ${selectedProfile.name}` : ''}`);
            
            const { businessName, location, industry, website } = window.pendingReportData;
            
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        businessName, 
                        location, 
                        industry, 
                        website,
                        selectedProfile
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                console.log(' Response received - Status:', response.status, 'OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(' Server returned error:', response.status, errorText);
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                console.log(' Report data received successfully');
                console.log(' DEBUGGING - Data structure check:');
                console.log('  - data exists:', !!data);
                console.log('  - data.success:', data?.success);
                console.log('  - data.isLocked:', data?.isLocked);  
                console.log('  - data.isFallback:', data?.isFallback);
                console.log('  - data.auditOverview exists:', !!data?.auditOverview);
                console.log('  - data.auditOverview.factors exists:', !!data?.auditOverview?.factors);
                console.log('  - factors length:', data?.auditOverview?.factors?.length);
                console.log('  - data.factors exists (legacy):', !!data?.factors);

                // Check for consistent success response format
                if (data && data.success && data.report) {
                    console.log(' Report data received and validated');
                    console.log('  - Report type:', data.report.isLocked ? 'LOCKED/PREVIEW' : 'FULL');
                    console.log('  - Has audit data:', !!data.report.auditOverview);
                    console.log('  - Has business data:', !!data.report.business);
                    console.log('  - Has factors:', !!data.report.auditOverview?.factors);
                    console.log('  - Factors count:', data.report.auditOverview?.factors?.length);
                    
                    currentReportData = data.report;
                    displayReport(data.report);
                    showReport();
                    
                    // Only refresh user data after successful report generation
                    // Don't redirect to dashboard - stay on report
                    await checkAuth();
                    await loadUserReports();
                    
                    const message = data.report.isLocked ? 'Preview report generated successfully!' : 'Report generated successfully!';
                    showToast(message, 'success');
                    console.log(' Report displayed successfully!');
                } else {
                    throw new Error('Invalid report data received');
                }
                
            } catch (error) {
                console.error(' Report generation error:', error);
                hideAllSections();
                showReportForm();
                showToast('Failed to generate report. Please try again.', 'error');
            }
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                checkAuth().then(() => showDashboard());
            } else {
                showLogin();
            }
        });
    </script>

    <!-- Citation Order Modal -->
    <div id="citationModal" class="citation-modal">
        <div class="citation-modal-content">
            <div class="citation-modal-header">
                <span class="citation-modal-close" onclick="closeCitationModal()">&times;</span>
                <h2>Order Citation Building Service</h2>
            </div>
            <div class="citation-modal-body">
                <form id="citationOrderForm" onsubmit="submitCitationOrder(event)">
                    <!-- Package Selection -->
                    <div style="margin-bottom: 25px;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Choose Your Package:</h3>

                        <div class="citation-package-option" onclick="selectPackage('25')">
                            <input type="radio" name="package" value="25" id="package25" required>
                            <label for="package25" style="cursor: pointer; margin: 0;">
                                <div class="citation-package-label">25 Citations</div>
                                <div class="citation-package-price">$30</div>
                                <div class="citation-package-details">Build your presence on 25 key local directories</div>
                            </label>
                        </div>

                        <div class="citation-package-option" onclick="selectPackage('50')">
                            <input type="radio" name="package" value="50" id="package50" required>
                            <label for="package50" style="cursor: pointer; margin: 0;">
                                <div class="citation-package-label">50 Citations</div>
                                <div class="citation-package-price">$50</div>
                                <div class="citation-package-details">Maximum coverage across 50 local directories</div>
                            </label>
                        </div>
                    </div>

                    <!-- Business Information -->
                    <h3 style="margin-bottom: 15px; font-size: 1.1rem;">Verify Business Information:</h3>

                    <div class="citation-form-group">
                        <label for="citationBusinessName">Business Name *</label>
                        <input type="text" id="citationBusinessName" name="businessName" required>
                    </div>

                    <div class="citation-form-group">
                        <label for="citationAddress">Business Address *</label>
                        <input type="text" id="citationAddress" name="address" required>
                    </div>

                    <div class="citation-form-group">
                        <label for="citationPhone">Business Phone *</label>
                        <input type="tel" id="citationPhone" name="phone" required>
                    </div>

                    <button type="submit" class="citation-submit-btn" id="citationSubmitBtn">
                        Proceed to Checkout
                    </button>
                </form>
            </div>
        </div>
    </div>

</body>
</html>