<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locality - Local SEO Audit Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Source+Sans+Pro:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', 'Source Sans Pro', sans-serif; background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: #333; margin-bottom: 30px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header h1 { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; }
        .wide-card { max-width: 1000px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; }
        .required { color: #dc3545; }
        
        /* Custom Checkbox Styling */
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            cursor: pointer;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 0;
            position: relative;
            padding-left: 30px;
        }
        
        .checkbox-container input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }
        
        .checkmark {
            position: absolute;
            top: 2px;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #fff;
            border: 2px solid #e1e5e9;
            border-radius: 4px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .checkbox-container:hover .checkmark {
            border-color: #0e192b;
            background-color: #f8f9fa;
        }
        
        .checkbox-container input:checked ~ .checkmark {
            background-color: #0e192b;
            border-color: #0e192b;
        }
        
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        
        .checkbox-container input:focus ~ .checkmark {
            outline: 2px solid #0e192b;
            outline-offset: 2px;
        }
        .btn { background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .hidden { display: none; }
        .error { color: #dc3545; margin-top: 10px; padding: 10px; background: #f8d7da; border-radius: 5px; }
        .success { color: #155724; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 5px; }
        .auth-switch { text-align: center; margin-top: 20px; color: #666; }
        .auth-switch a { color: #0e192b; text-decoration: none; font-weight: 600; cursor: pointer; }
        .loading { opacity: 0.7; pointer-events: none; }
        
        /* Terms Checkbox - Standard Styling */
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            line-height: 1.5;
            font-size: 14px;
            color: #333;
            padding: 0;
            margin: 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px !important;
            height: 18px !important;
            margin: 0 !important;
            opacity: 1 !important;
            position: static !important;
            cursor: pointer;
            accent-color: #0e192b;
        }
        
        .checkmark {
            display: none !important;
        }
        
        .checkbox-container a {
            color: #0e192b;
            text-decoration: none;
            font-weight: 600;
        }
        
        .checkbox-container a:hover {
            text-decoration: underline;
        }
        
        /* Enhanced Dashboard */
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 40px; }
        .credits-section { text-align: right; }
        .credits-section > div { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 15px 20px; margin-bottom: 10px; }
        .big-number { font-size: 2rem; font-weight: bold; color: #0e192b; }
        
        /* Reports Table Styles */
        .reports-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .reports-table th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #495057; border-bottom: 1px solid #dee2e6; }
        .reports-table td { padding: 15px; border-bottom: 1px solid #f8f9fa; vertical-align: middle; }
        .reports-table tr:hover { background: #f8f9fa; }
        .business-name { font-weight: 600; color: #0e192b; font-size: 1.1rem; }
        .business-location { color: #666; font-size: 0.9rem; margin-top: 2px; }
        .score-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; min-width: 80px; text-align: center; }
        /* Score display styling */
        .score-display { 
            font-weight: 600; 
            font-size: 1.1rem; 
            padding: 6px 12px; 
            border-radius: 6px; 
            text-align: center; 
            min-width: 60px; 
            display: inline-block; 
        }
        /* Table score display styling */
        .table-score-display { 
            font-weight: 600; 
            font-size: 1rem; 
            padding: 4px 10px; 
            border-radius: 6px; 
            text-align: center; 
            min-width: 60px; 
            display: inline-block; 
        }
        .score-good { background: #d4edda; color: #155724; }
        .score-fair { background: #fff3cd; color: #856404; }
        .score-poor { background: #f8d7da; color: #721c24; }
        .score-neutral { background: #e9ecef; color: #495057; }
        
        /* Report action buttons - consistent styling */
        .report-action-btn { 
            background: linear-gradient(135deg, #1a2332 0%, #0e192b 100%); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 0.85rem; 
            margin-right: 8px; 
            min-width: 80px;
        }
        .report-action-btn:hover { 
            background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 8px rgba(44, 82, 130, 0.3); 
        }
        .report-action-btn:last-child { margin-right: 0; }
        
        /* Loading Progress */
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0e192b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar { width: 100%; background: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #0e192b, #1a2332); width: 0%; transition: width 0.5s ease; }
        .progress-text { text-align: center; margin-top: 15px; color: #666; font-size: 0.9rem; }
        
        /* Toast Notifications */
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-warning { background: #ffc107; color: #212529; }
        
        /* NEW REPORT DESIGN */
        .single-page-report { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Business Info Header */
        .business-info-header { background: white; padding: 20px 30px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: flex-start; }
        .business-details { font-size: 0.9rem; color: #495057; line-height: 1.6; }
        .business-details strong { color: #0e192b; }
        .logo-container { flex-shrink: 0; }
        
        /* Consistent logo sizing across all locations - doubled size */
        .logo,
        .header img[src*="logo"],
        .footer-logo img,
        img[src*="locality-logo"] {
            height: 240px;
            width: auto;
            max-width: 800px;
            display: block;
            background-color: transparent;
            border: none;
            outline: none;
            object-fit: contain;
        }
        
        /* Specific size for footer to be slightly smaller */
        .footer-logo img {
            height: 200px;
            max-width: 720px;
            margin: 0 auto;
        }
        
        /* Center dashboard logo */
        .header img {
            margin: 0 auto;
        }
        
        /* Updated Score Display - DONUT CHART - SIMPLIFIED */
        .score-donut-container {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 40px auto 30px;
        }

        .score-donut-container svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .donut-bg {
            fill: none;
            stroke: #f1f3f5;
            stroke-width: 12;
        }

        .donut-fill {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke: #dc3545;
        }

        .score-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: flex;
            align-items: baseline;
            justify-content: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: 800;
            color: #2c3e50;
            line-height: 1;
            font-family: 'Montserrat', sans-serif;
        }

        .score-percentage {
            font-size: 14px;
            color: #7f8c8d;
            font-weight: 600;
            margin-left: 2px;
        }

        .score-message { color: #666; max-width: 600px; margin: 20px auto 0; font-size: 1.1rem; text-align: center; }
        
        /* Content Sections */
        .section { margin: 40px 30px; }
        .section-title { margin-bottom: 25px; color: #0e192b; font-size: 1.5rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        
        /* Factors Grid */
        .factors-compact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .factor-item-compact { background: #f8f9fa; border-radius: 8px; padding: 15px; border-left: 4px solid #e9ecef; position: relative; cursor: pointer; transition: all 0.3s ease; }
        .factor-item-compact:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .factor-item-compact.expanded { grid-column: 1 / -1; max-width: none; cursor: default; transform: none; }
        .factor-item-compact.status-good { border-left-color: #28a745; }
        .factor-item-compact.status-needs-improvement { border-left-color: #ffc107; }
        .factor-item-compact.status-missing { border-left-color: #dc3545; }
        .factor-item-compact.status-uncertain { border-left-color: #6c757d; }
        
        .factor-header-compact { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .factor-name { font-weight: 600; color: #0e192b; font-size: 1rem; font-family: 'Montserrat', sans-serif; }
        .factor-status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-good { background: #d4edda; color: #155724; }
        .status-needs-improvement { background: #fff3cd; color: #856404; }
        .status-missing { background: #f8d7da; color: #721c24; }
        .status-uncertain { background: #e2e3e5; color: #495057; }
        .factor-message { color: #666; margin: 0; font-size: 0.9rem; }
        
        /* Down Arrow */
        .factor-expand-arrow { color: #0e192b; font-size: 0.8rem; transition: transform 0.3s ease; margin-left: 10px; }
        .factor-item-compact.expanded .factor-expand-arrow { transform: rotate(180deg); }
        
        /* Expanded Content */
        .factor-expanded-content { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; }
        .factor-expanded-content.show { display: block; animation: slideDown 0.3s ease; }
        
        .expanded-sections { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .expanded-section { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        .expanded-section h4 { color: #0e192b; margin: 0 0 10px 0; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; font-family: 'Montserrat', sans-serif; }
        .expanded-section p { color: #666; margin: 0; font-size: 0.9rem; line-height: 1.5; }
        .expanded-section a { color: #0e192b; text-decoration: none; font-weight: 600; }
        .expanded-section a:hover { text-decoration: underline; }
        
        .smart-suggestion-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 15px; }
        .smart-suggestion-section h4 { color: #0e192b; margin: 0 0 15px 0; font-size: 1rem; font-weight: 600; font-family: 'Montserrat', sans-serif; }
        .suggestion-textarea { width: 100%; height: 120px; padding: 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 0.9rem; line-height: 1.5; resize: vertical; font-family: inherit; }
        .suggestion-actions { display: flex; gap: 10px; margin-top: 10px; }
        .copy-suggestion-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .copy-suggestion-btn:hover { background: #218838; transform: translateY(-1px); }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Citations Row */
        .citations-row { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .citation-item-simple { text-align: center; padding: 15px 10px; background: white; border-radius: 8px; border: 2px solid #e9ecef; }
        .citation-item-simple.found { border-color: #28a745; background: #f8fff8; }
        .citation-item-simple.missing { border-color: #dc3545; background: #fff8f8; }
        .citation-icon { font-size: 1.2rem; margin-bottom: 8px; }
        .citation-logo { width: 32px; height: 32px; margin: 0 auto 8px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .citation-name-simple { font-size: 0.8rem; font-weight: 600; color: #495057; }
        .order-citations-btn { background: #0e192b; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin: 20px auto; display: block; transition: all 0.3s ease; }
        .order-citations-btn:hover { background: #1a2332; transform: translateY(-2px); }
        
        /* Detailed Citation Analysis */
        .detailed-analysis-section { margin-top: 30px; padding-top: 20px; border-top: 2px solid #e9ecef; }
        .detailed-analysis-btn { background: #17a2b8; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1rem; cursor: pointer; margin: 0 auto 10px; display: block; transition: all 0.3s ease; }
        .detailed-analysis-btn:hover { background: #138496; transform: translateY(-2px); }
        .detailed-analysis-btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .detailed-analysis-subtext { text-align: center; color: #6c757d; font-size: 0.9rem; margin: 0 0 20px 0; }
        
        /* Detailed Results */
        .detailed-results-container { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .detailed-results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .detailed-results-header h4 { margin: 0; color: #0e192b; }
        .detailed-score { font-size: 1.2rem; font-weight: 700; color: #17a2b8; }
        .detailed-results-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; }
        .detailed-result-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; font-size: 0.85rem; }
        .detailed-result-item.found { background: #d4edda; color: #155724; }
        .detailed-result-item.missing { background: #f8d7da; color: #721c24; }
        .detailed-result-item.error { background: #fff3cd; color: #856404; }
        .detailed-result-name { font-weight: 500; }
        .detailed-result-status { font-size: 1rem; }
        
        /* Loading Spinner */
        .detailed-loading { text-align: center; padding: 40px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #e9ecef; border-top: 4px solid #17a2b8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .detailed-loading p { color: #6c757d; margin: 0; }
        
        /* Action Plan */
        .action-item-simple { display: flex; align-items: center; padding: 12px 15px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #e9ecef; }
        .action-item-simple.completed { border-left-color: #28a745; background: #f8fff8; }
        .action-item-simple.incomplete { border-left-color: #dc3545; }
        .action-checkbox { width: 20px; height: 20px; border: 2px solid #dee2e6; border-radius: 4px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #28a745; font-weight: bold; cursor: pointer; transition: all 0.2s ease; }
        .action-checkbox:hover { border-color: #adb5bd; background: #f8f9fa; }
        .action-item-simple.completed .action-checkbox { background: #28a745; border-color: #28a745; color: white; }
        .action-item-simple.incomplete .action-checkbox { background: white; }
        .action-text { flex: 1; font-weight: 500; color: #495057; display: flex; justify-content: space-between; align-items: center; }
        .action-arrow { color: #0e192b; font-size: 0.8rem; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.3s ease; }
        .action-arrow:hover { background: #e9ecef; transform: translateY(-1px); }
        
        /* Upsell Section */
        .upsell-box { background: #0e192b; border-radius: 12px; padding: 30px; text-align: center; border: 2px solid #1a2332; }
        .upsell-title { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; color: white; margin-bottom: 15px; font-weight: 600; }
        .upsell-description { font-size: 1rem; color: white; margin-bottom: 20px; line-height: 1.6; }
        .upsell-cta { font-size: 1.1rem; color: white; font-weight: 600; }
        .upsell-link { color: #ffd700; text-decoration: underline; font-weight: 600; }
        .upsell-link:hover { color: white; text-decoration: none; }
        
        /* Footer Logo - centered */
        .footer-logo { 
            text-align: center; 
            padding: 30px; 
            border-top: 1px solid #e9ecef; 
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Report Actions */
        .report-actions { text-align: center; margin: 40px 0; padding: 30px; border-top: 1px solid #eee; }
        
        /* Print-specific styles for 2-page PDF */
        @media print {
            body { 
                font-size: 12px; 
                line-height: 1.3;
                color: #000 !important;
                background: white !important;
            }
            
            .container { 
                max-width: none; 
                padding: 0; 
                margin: 0;
            }
            
            /* Hide non-essential elements for print */
            .btn, .report-actions, .how-to-fix-btn, .view-details-btn,
            .copy-suggestion-btn, .order-citations-btn,
            .factor-expand-arrow, .action-arrow {
                display: none !important;
            }
            
            /* Page 1: Score and Factors */
            .print-page-1 {
                page-break-after: always;
                min-height: 95vh;
            }
            
            /* Sections - more compact for print */
            .print-page-1 .section {
                margin: 10px 0;
                padding: 8px;
            }
            
            .print-page-1 .section-title {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            /* Simplified business header on page 1 */
            .business-info-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 0;
                margin-bottom: 15px;
                border-bottom: 2px solid #e9ecef;
            }
            
            .business-details {
                font-size: 14px;
                color: #495057;
                line-height: 1.4;
            }
            
            .logo-container {
                flex-shrink: 0;
            }
            
            /* Score section - compact for print with working colors */
            .score-donut-container {
                width: 100px;
                height: 100px;
                margin: 15px auto;
            }
            
            .donut-fill {
                /* Force the colors to show in print by removing animations */
                transition: none !important;
            }
            
            .donut-fill.score-0-59 { 
                stroke: #e74c3c !important; 
                stroke-dashoffset: 264 !important; /* 40% fill for visibility */
            }
            .donut-fill.score-60-69 { 
                stroke: #f39c12 !important; 
                stroke-dashoffset: 176 !important; /* 60% fill */
            }
            .donut-fill.score-70-79 { 
                stroke: #f1c40f !important; 
                stroke-dashoffset: 132 !important; /* 70% fill */
            }
            .donut-fill.score-80-89 { 
                stroke: #2ecc71 !important; 
                stroke-dashoffset: 88 !important; /* 80% fill */
            }
            .donut-fill.score-90-100 { 
                stroke: #27ae60 !important; 
                stroke-dashoffset: 44 !important; /* 90% fill */
            }
            
            .score-number {
                font-size: 24px;
            }
            
            .score-percentage {
                font-size: 10px;
            }
            
            .score-message {
                font-size: 12px;
                margin: 10px auto;
                max-width: 400px;
                text-align: center;
            }
            
            /* Factors grid - 2 columns for print to fit better and save space */
            .factors-compact-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 4px;
                margin-top: 8px;
            }
            
            .factor-item-compact {
                padding: 4px 6px;
                margin-bottom: 0;
                border-radius: 3px;
                background: #f8f9fa !important;
                border-left: 3px solid #e9ecef;
                break-inside: avoid;
                font-size: 8px;
                page-break-inside: avoid;
            }
            
            .factor-item-compact.status-good { border-left-color: #28a745; }
            .factor-item-compact.status-needs-improvement { border-left-color: #ffc107; }
            .factor-item-compact.status-missing { border-left-color: #dc3545; }
            .factor-item-compact.status-uncertain { border-left-color: #6c757d; }
            
            .factor-header-compact {
                margin-bottom: 1px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .factor-name {
                font-size: 9px;
                font-weight: 600;
                color: #0e192b !important;
            }
            
            .factor-status-badge {
                font-size: 6px;
                padding: 1px 3px;
                border-radius: 3px;
            }
            
            .factor-message {
                font-size: 7px;
                color: #666 !important;
                line-height: 1.1;
                margin-top: 2px;
            }
            
            /* Hide expanded content in print */
            .factor-expanded-content {
                display: none !important;
            }
            
            .section-title {
                font-size: 16px;
                margin-bottom: 12px;
                color: #0e192b !important;
                font-weight: 600;
            }
            
            /* Page 2: Action Plan and Upsell */
            .print-page-2 {
                page-break-before: always;
                min-height: 95vh;
                padding-top: 20px;
            }
            
            .print-page-2 .section {
                margin: 15px 0;
                padding: 10px;
            }
            
            /* Citations section - more compact */
            .print-page-1 .citations-row {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 4px;
                padding: 8px;
                background: #f8f9fa !important;
                border-radius: 4px;
                margin-bottom: 10px;
            }
            
            .print-page-1 .citation-item-simple {
                text-align: center;
                padding: 4px 2px;
                background: white !important;
                border-radius: 3px;
                border: 1px solid #e9ecef;
            }
            
            .citation-item-simple.found { 
                border-color: #28a745; 
                background: #f8fff8 !important; 
            }
            
            .citation-item-simple.missing { 
                border-color: #dc3545; 
                background: #fff8f8 !important; 
            }
            
            .print-page-1 .citation-logo {
                width: 16px;
                height: 16px;
                margin: 0 auto 2px;
            }
            
            .print-page-1 .citation-icon {
                font-size: 10px;
                margin-bottom: 2px;
                font-weight: bold;
            }
            
            .print-page-1 .citation-name-simple {
                font-size: 7px;
                font-weight: 600;
                color: #495057 !important;
                line-height: 1;
            }
            
            /* Action plan for print - more compact */
            .action-item-simple {
                padding: 6px 8px;
                margin-bottom: 3px;
                background: #f8f9fa !important;
                border-radius: 4px;
                border-left: 3px solid #e9ecef;
                break-inside: avoid;
            }
            
            .action-item-simple.completed { 
                border-left-color: #28a745; 
                background: #f8fff8 !important; 
            }
            
            .action-item-simple.incomplete { 
                border-left-color: #dc3545; 
            }
            
            .action-checkbox {
                width: 14px;
                height: 14px;
                border: 2px solid #dee2e6;
                border-radius: 2px;
                margin-right: 8px;
                font-size: 10px;
            }
            
            .action-text {
                font-size: 11px;
                color: #495057 !important;
                font-weight: 500;
            }
            
            /* Footer styling - just logo, bottom right */
            .footer-logo {
                position: absolute;
                bottom: 20px;
                right: 20px;
                background: none !important;
                border: none;
                padding: 0;
            }
            
            .footer-logo img {
                height: 160px;
                max-width: 600px;
            }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2rem; }
            .dashboard-header { flex-direction: column; align-items: stretch; }
            .credits-section { text-align: left; margin-top: 20px; }
            .reports-table { font-size: 0.9rem; }
            .reports-table th, .reports-table td { padding: 10px; }
            .factors-compact-grid { grid-template-columns: 1fr; }
            .citations-row { grid-template-columns: repeat(5, 1fr); gap: 10px; }
            .citation-item-simple { padding: 10px 5px; }
            .citation-name-simple { font-size: 0.7rem; }
            .detailed-results-grid { grid-template-columns: repeat(5, 1fr); gap: 6px; }
            .detailed-result-item { padding: 6px 8px; font-size: 0.75rem; }
        }
        /* Upsell Box */
.upsell-box {
    background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    margin: 40px 0;
    box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
}

.upsell-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 15px;
    color: white;
}

.upsell-description {
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 20px;
    opacity: 0.95;
}

.upsell-cta {
    font-size: 1rem;
    margin: 0;
}

.upsell-link {
    color: #ffd700;
    text-decoration: none;
    font-weight: 600;
    border-bottom: 2px solid #ffd700;
    padding-bottom: 2px;
    transition: all 0.3s ease;
}

.upsell-link:hover {
    color: white;
    border-bottom-color: white;
    transform: translateY(-1px);
}

/* Style upsell box for print */
@media print {
    .upsell-box {
        background: #f8f9fa !important;
        border: 2px solid #0e192b !important;
        padding: 15px !important;
        margin: 20px 0 !important;
        page-break-inside: avoid;
    }
    
    .upsell-title {
        font-size: 14px !important;
        color: #0e192b !important;
        margin-bottom: 8px !important;
    }
    
    .upsell-description {
        font-size: 11px !important;
        color: #333 !important;
        margin-bottom: 8px !important;
    }
    
    .upsell-cta {
        font-size: 11px !important;
        color: #333 !important;
    }
    
    .upsell-link {
        color: #0e192b !important;
        text-decoration: underline !important;
    }
}

/* Feedback Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s ease;
}

.modal.show {
    display: block;
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    color: #0e192b;
    font-size: 1.3rem;
    font-weight: 600;
}

.close-modal {
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #999;
    transition: color 0.3s ease;
}

.close-modal:hover {
    color: #666;
}

.modal-content form {
    padding: 30px;
}

.star-rating {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.star {
    font-size: 24px;
    color: #ddd;
    cursor: pointer;
    transition: color 0.2s ease;
}

.star:hover,
.star.active {
    color: #ffc107;
}

.star.active ~ .star {
    color: #ddd;
}

.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    font-family: inherit;
    resize: vertical;
}

.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0e192b;
}

.form-group textarea {
    min-height: 120px;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { 
        opacity: 0;
        transform: translateY(-50px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-content form {
        padding: 20px;
    }
    
    /* Mobile logo adjustments - scaled proportionally */
    .logo,
    .header img[src*="logo"],
    img[src*="locality-logo"] {
        height: 160px;
        max-width: 560px;
    }
    
    .footer-logo img {
        height: 140px;
        max-width: 500px;
    }
    
    .business-info-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .logo-container {
        margin-top: 15px;
    }
}

/* Locked Report Styles */
.report-locked-overlay {
    position: relative;
}

.report-locked-blur {
    filter: blur(4px);
    pointer-events: none;
    user-select: none;
}

.unlock-report-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid #0e192b;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    max-width: 400px;
    width: 90%;
}

.unlock-banner-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0e192b;
    margin-bottom: 15px;
    font-family: 'Montserrat', sans-serif;
}

.unlock-banner-subtitle {
    font-size: 1rem;
    color: #666;
    margin-bottom: 20px;
    padding: 10px 15px;
    background: #e7f3ff;
    border-radius: 8px;
    border-left: 4px solid #0066cc;
}

.unlock-btn {
    background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
}

.unlock-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
}

.factors-locked {
    position: relative;
}

.factors-locked .factors-compact-grid {
    filter: blur(2px);
    pointer-events: none;
    user-select: none;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginSection" class="card hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Login to Your Account</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Your password">
                </div>
                <div style="text-align: right; margin-bottom: 15px;">
                    <a onclick="showForgotPassword()" style="color: #0e192b; font-size: 14px; cursor: pointer; text-decoration: none;">Forgot password?</a>
                </div>
                <button type="submit" class="btn">Login</button>
                <div id="loginError" class="error hidden"></div>
            </form>
            <div class="auth-switch">
                Don't have an account? <a onclick="showSignup()">Sign up here</a>
            </div>
        </div>

        <!-- Forgot Password Form -->
        <div id="forgotPasswordSection" class="card hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Reset Your Password</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Enter your email address and we'll send you a link to reset your password.</p>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email Address</label>
                    <input type="email" id="resetEmail" required placeholder="your@email.com">
                </div>
                <button type="submit" class="btn">Send Reset Link</button>
                <div id="forgotPasswordMessage" class="hidden" style="margin-top: 15px;"></div>
            </form>
            <div class="auth-switch">
                Remember your password? <a onclick="showLogin()">Back to login</a>
            </div>
        </div>

        <!-- Signup Form -->
        <div id="signupSection" class="card hidden">
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Create Your Account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" required placeholder="John">
                </div>
                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" required placeholder="Smith">
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" required placeholder="john@email.com">
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required placeholder="Create a strong password">
                </div>
                <div class="form-group">
                    <label class="checkbox-container" for="termsAgreement">
                        <input type="checkbox" id="termsAgreement" required 
                               aria-describedby="terms-description"
                               aria-label="Agreement to Terms and Conditions and Privacy Policy">
                        <span id="terms-description">
                            I agree to the <a href="https://trylocality.com/terms-of-service/" target="_blank" rel="noopener noreferrer">Terms and Conditions</a> and <a href="https://trylocality.com/privacy-policy/" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
                        </span>
                    </label>
                </div>
                <button type="submit" class="btn">Create Account</button>
                <div id="signupError" class="error hidden"></div>
                <div id="signupSuccess" class="success hidden"></div>
            </form>
            <div class="auth-switch">
                Already have an account? <a onclick="showLogin()">Login here</a>
            </div>
        </div>

        <!-- Enhanced Dashboard -->
        <div id="dashboardSection" class="card hidden" style="max-width: 900px;">
            <div class="header">
                <img src="locality-logo.png" alt="Locality" class="logo">
            </div>
            
            <!-- Email Verification Banner -->
            <div id="emailVerificationBanner" class="hidden" style="
                background: #fff3cd; 
                border: 1px solid #ffeaa7; 
                border-radius: 8px; 
                padding: 15px; 
                margin-bottom: 20px;
                text-align: center;
            ">
                <div style="color: #856404; margin-bottom: 10px;">
                    📧 <strong>Please verify your email address</strong>
                </div>
                <div style="color: #856404; font-size: 14px; margin-bottom: 15px;">
                    We sent a verification link to your email. Please check your inbox and click the link to verify your account.
                </div>
                <button onclick="resendVerificationEmail()" class="btn" style="
                    padding: 8px 20px; 
                    font-size: 14px; 
                    width: auto;
                    background: #ffc107;
                    color: #212529;
                ">
                    Resend Verification Email
                </button>
            </div>
            
            <div class="dashboard-header">
                <div>
                    <h1 style="font-size: 2.5rem; color: #0e192b; margin-bottom: 10px;">Welcome, <span id="userName"></span></h1>
                    <p style="color: #666; font-size: 1.1rem;">Generate comprehensive local SEO audits for your business</p>
                </div>
                <div class="credits-section">
                    <div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Credits Remaining</div>
                        <div class="big-number" id="creditsDisplay">0</div>
                    </div>
                    <button class="btn btn-success" onclick="buyCredits()" style="width: 100%; padding: 8px 16px; font-size: 0.9rem;">
                        Buy Credits
                    </button>
                    <button onclick="logout()" style="background: none; border: none; color: #999; font-size: 0.8rem; margin-top: 10px; cursor: pointer; text-decoration: underline;">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Main Generate Button -->
            <div style="text-align: center; margin-bottom: 50px;">
                <button class="btn" onclick="showReportForm()" style="
                    width: auto; 
                    padding: 20px 40px; 
                    font-size: 1.5rem; 
                    font-weight: bold; 
                    background: linear-gradient(135deg, #0e192b 0%, #1a2332 100%);
                    box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
                    transform: scale(1);
                    transition: all 0.3s ease;
                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                     Generate New Audit
                </button>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    Comprehensive 12-factor analysis with AI-powered suggestions
                </p>
            </div>

            <!-- Previous Reports Table -->
            <div class="reports-table-section">
                <h3 style="margin-bottom: 20px; color: #0e192b; font-size: 1.3rem;">Previous Reports</h3>
                <div id="reportsTableContainer">
                    <div class="no-reports" style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No reports yet</h4>
                        <p>Generate your first SEO audit to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Form -->
        <div id="reportFormSection" class="card hidden">
            <button class="btn btn-secondary" onclick="showDashboard()" style="width: auto; margin-bottom: 20px; padding: 8px 20px;">← Back to Dashboard</button>
            <h2 style="text-align: center; margin-bottom: 30px; color: #0e192b;">Generate SEO Audit Report</h2>
            <form id="reportForm">
                <div class="form-group">
                    <label for="businessName">Business Name <span class="required">*</span></label>
                    <input type="text" id="businessName" required placeholder="Exactly as shown on your Google Business Profile">
                </div>
                <div class="form-group">
                    <label for="location">Location <span class="required">*</span></label>
                    <input type="text" id="location" required placeholder="e.g., Miami, FL or 123 Main St, Miami, FL 33101">
                </div>
                <div class="form-group">
                    <label for="industry">Industry <span class="required">*</span></label>
                    <input type="text" id="industry" required placeholder="e.g., Accountant or House Cleaner">
                </div>
                <div class="form-group">
                    <label for="website">Website (Optional)</label>
                    <input type="url" id="website" placeholder="https://www.example.com">
                </div>
                <button type="submit" class="btn">Generate Report (1 Credit)</button>
                <div id="reportError" class="error hidden"></div>
            </form>
        </div>

        <!-- Enhanced Loading Section -->
        <div id="loadingSection" class="card hidden">
            <div style="text-align: center; padding: 40px;">
                <div class="spinner"></div>
                <h3>Generating Your Professional SEO Audit Report...</h3>
                <p>This may take 60-90 seconds...</p>
                
                <div style="margin-top: 20px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing audit...</div>
                </div>
            </div>
        </div>

        <!-- NEW SINGLE PAGE REPORT -->
        <div id="reportSection" class="single-page-report hidden">
            <!-- Page 1: Business Info, Score, and Factors -->
            <div class="print-page-1">
                <!-- Business Info Header with Logo in Top Right -->
                <div class="business-info-header">
                    <div class="business-details">
                        <div><strong>Business:</strong> <span id="reportBusinessName"></span></div>
                        <div><strong>Location:</strong> <span id="reportLocation"></span></div>
                        <div><strong>Date:</strong> <span id="reportDate"></span></div>
                        <div><strong>Prepared By:</strong> <span id="reportPreparedBy">Locality Marketing</span></div>
                    </div>
                    <div class="logo-container">
                        <img src="locality-logo.png" alt="Locality Marketing" class="logo">
                    </div>
                </div>

                <!-- Score Donut Chart -->
                <div style="text-align: center;">
                    <div class="score-donut-container">
                        <svg viewBox="0 0 180 180">
                            <circle class="donut-bg" cx="90" cy="90" r="70"></circle>
                            <circle class="donut-fill" id="scoreDonut" cx="90" cy="90" r="70"></circle>
                        </svg>
                        <div class="score-display">
                            <div class="score-number" id="scoreNumber">0</div>
                            <div class="score-percentage">%</div>
                        </div>
                    </div>
                    <div class="score-message" id="scoreMessage"></div>
                </div>

                <!-- Factors Analysis -->
                <div class="section">
                    <h3 class="section-title">Ranking Factor Review</h3>
                    <div class="factors-compact-grid" id="factorsGrid"></div>
                </div>

                <!-- Citations Section -->
                <div class="section">
                    <h3 class="section-title">Local Citations Status</h3>
                    <div class="citations-row" id="citationsRow"></div>
                    
                    <!-- Detailed Citation Analysis Section -->
                    <div class="detailed-analysis-section">
                        <button class="detailed-analysis-btn" id="detailedAnalysisBtn" onclick="runDetailedCitationAnalysis()">
                            RUN DETAILED CITATION ANALYSIS
                        </button>
                        <p class="detailed-analysis-subtext">
                            We have a curated list of directories that can add SEO value. Run a report to see if you are listed.
                        </p>
                        
                        <!-- Results container (initially hidden) -->
                        <div class="detailed-results-container" id="detailedResultsContainer" style="display: none;">
                            <div class="detailed-results-header">
                                <h4>Detailed Citation Analysis Results</h4>
                                <div class="detailed-score" id="detailedScore"></div>
                            </div>
                            <div class="detailed-results-grid" id="detailedResultsGrid"></div>
                            <button class="order-citations-btn" onclick="orderCitations()">
                                ORDER CITATIONS
                            </button>
                        </div>
                        
                        <!-- Loading state -->
                        <div class="detailed-loading" id="detailedLoading" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Scanning directories... This may take a moment.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page 2: Action Plan and Upsell -->
            <div class="print-page-2">

                <!-- Action Plan -->
                <div class="section">
                    <h3 class="section-title">Action Plan</h3>
                    <div id="actionPlanList"></div>
                </div>

<!-- Upsell Section -->
<div class="section">
    <div class="upsell-box">
        <h3 class="upsell-title">Let Locality Optimize For You!</h3>
        <p class="upsell-description">
            One of our SEO professionals will optimize your profile for you, ensuring a strong keyword presence, 
            a complete profile and a better chance of more leads, starting as low as $149!
        </p>
        <p class="upsell-cta">
            Interested? <a href="https://calendly.com/trylocality/seo-optimization" target="_blank" class="upsell-link">
                Click here to schedule a call with our team to learn more!
            </a>
        </p>
    </div>
</div>
                <!-- Footer Logo - Bottom Right -->
                <div class="footer-logo">
                    <img src="locality-logo.png" alt="Locality Marketing">
                </div>
            </div>

            <!-- Report Actions -->
            <div class="report-actions">
                <button class="btn" onclick="downloadPDF()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Download PDF Report
                </button>
                <button class="btn" onclick="showReportForm()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Generate Another Report
                </button>
                <button class="btn" onclick="showDashboard()" style="width: auto; padding: 12px 25px; margin-right: 15px;">
                    Back to Dashboard
                </button>
                <button class="btn" onclick="showFeedbackForm()" style="width: auto; padding: 12px 25px;">
                    Share Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Share Your Feedback</h2>
                <span class="close-modal" onclick="closeFeedbackForm()">&times;</span>
            </div>
            <form id="feedbackForm">
                <div class="form-group">
                    <label>How would you rate your experience?</label>
                    <div class="star-rating">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                    <input type="hidden" id="feedbackRating" name="rating" required>
                </div>
                
                <div class="form-group">
                    <label for="feedbackType">Type of Feedback <span class="required">*</span></label>
                    <select id="feedbackType" name="type" required>
                        <option value="">Select feedback type</option>
                        <option value="general">General</option>
                        <option value="bug">Bug Report</option>
                        <option value="feature">Feature Request</option>
                        <option value="performance">Performance Issue</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="feedbackMessage">Your Feedback <span class="required">*</span></label>
                    <textarea id="feedbackMessage" name="message" rows="5" required placeholder="Please share your feedback here..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="feedbackEmail">Email (Optional)</label>
                    <input type="email" id="feedbackEmail" name="email" placeholder="your@email.com">
                    <small style="color: #666; display: block; margin-top: 5px;">Provide your email if you'd like us to follow up with you</small>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Submit Feedback</button>
                <div id="feedbackError" class="error hidden"></div>
                <div id="feedbackSuccess" class="success hidden"></div>
            </form>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div id="pricingModal" class="modal hidden">
        <div class="modal-content pricing-modal-content">
            <div class="modal-header">
                <h2>Choose Your Plan</h2>
                <span class="close-modal" onclick="closePricingModal()">&times;</span>
            </div>
            
            <div class="pricing-modal-body">
                <p class="pricing-subtitle">Get comprehensive citation analysis for your business</p>
                
                <div class="pricing-grid-modal">
                    <!-- Single Report -->
                    <div class="pricing-card-modal">
                        <div class="pricing-header-modal">
                            <h3>Single Report</h3>
                            <div class="price-modal">
                                <span class="currency">$</span>
                                <span class="amount">45</span>
                            </div>
                            <p class="price-description">One-time purchase</p>
                        </div>
                        <div class="pricing-features-modal">
                            <ul>
                                <li><span class="checkmark">✓</span> Complete citation analysis</li>
                                <li><span class="checkmark">✓</span> 50 directory scan</li>
                                <li><span class="checkmark">✓</span> Competitor comparison</li>
                                <li><span class="checkmark">✓</span> Actionable recommendations</li>
                                <li><span class="checkmark">✓</span> PDF export</li>
                            </ul>
                        </div>
                        <button class="btn btn-secondary" onclick="purchaseSingleReportModal()">
                            Buy Now
                        </button>
                    </div>

                    <!-- Starter Plan -->
                    <div class="pricing-card-modal featured-modal">
                        <div class="popular-badge-modal">Most Popular</div>
                        <div class="pricing-header-modal">
                            <h3>Starter</h3>
                            <div class="price-modal">
                                <span class="currency">$</span>
                                <span class="amount">99</span>
                                <span class="period">/month</span>
                            </div>
                            <p class="price-description">50 reports per month</p>
                        </div>
                        <div class="pricing-features-modal">
                            <ul>
                                <li><span class="checkmark">✓</span> Everything in Single Report</li>
                                <li><span class="checkmark">✓</span> 50 reports/month</li>
                                <li><span class="checkmark">✓</span> White-label capabilities</li>
                                <li><span class="checkmark">✓</span> Priority support</li>
                                <li><span class="checkmark">✓</span> Bulk export options</li>
                                <li><span class="checkmark">✓</span> Custom branding</li>
                            </ul>
                        </div>
                        <button class="btn btn-primary" onclick="subscribePlanModal('starter')">
                            Subscribe Now
                        </button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="pricing-card-modal">
                        <div class="pricing-header-modal">
                            <h3>Pro</h3>
                            <div class="price-modal">
                                <span class="currency">$</span>
                                <span class="amount">199</span>
                                <span class="period">/month</span>
                            </div>
                            <p class="price-description">100 reports per month</p>
                        </div>
                        <div class="pricing-features-modal">
                            <ul>
                                <li><span class="checkmark">✓</span> Everything in Starter</li>
                                <li><span class="checkmark">✓</span> 100 reports/month</li>
                                <li><span class="checkmark">✓</span> Advanced analytics</li>
                                <li><span class="checkmark">✓</span> API access</li>
                                <li><span class="checkmark">✓</span> Team collaboration</li>
                                <li><span class="checkmark">✓</span> Dedicated account manager</li>
                            </ul>
                        </div>
                        <button class="btn btn-secondary" onclick="subscribePlanModal('pro')">
                            Subscribe Now
                        </button>
                    </div>
                </div>

                <div class="pricing-footer-modal">
                    <p class="guarantee-modal">
                        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2328a745' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z'%3E%3C/path%3E%3C/svg%3E" alt="Secure" class="icon">
                        30-day money-back guarantee • Cancel anytime
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let authToken = localStorage.getItem('authToken');
        let currentReportData = null;
        let userReports = [];
        
        // Clear report state function
        function clearReportState() {
            console.log('🧹 Clearing report state...');
            currentReportData = null;
            
            // Clear report elements
            document.getElementById('reportBusinessName').textContent = '';
            document.getElementById('reportLocation').textContent = '';
            document.getElementById('reportDate').textContent = '';
            document.getElementById('scoreNumber').textContent = '0';
            document.getElementById('scoreMessage').textContent = '';
            
            // Clear factors grid
            const factorsGrid = document.getElementById('factorsGrid');
            if (factorsGrid) factorsGrid.innerHTML = '';
            
            // Clear citations row
            const citationsRow = document.getElementById('citationsRow');
            if (citationsRow) citationsRow.innerHTML = '';
            
            // Clear action plan
            const actionPlanList = document.getElementById('actionPlanList');
            if (actionPlanList) actionPlanList.innerHTML = '';
            
            // Reset donut chart
            const scoreDonut = document.getElementById('scoreDonut');
            if (scoreDonut) {
                scoreDonut.style.strokeDashoffset = '440';
                scoreDonut.style.stroke = '#e9ecef';
            }
        }

        // Directory logos mapping
        const directoryLogos = {
            'Yelp': 'Directory Logos/Yelp.png',
            'Better Business Bureau': 'Directory Logos/BBB.png',
            'Yellow Pages': 'Directory Logos/YellowPages.png',
            'Apple Maps': 'Directory Logos/Apple-Maps.png',
            'Facebook Business': 'Directory Logos/Facebook.png',
            'Foursquare': 'Directory Logos/Foursquare.png',
            'Bing Maps': 'Directory Logos/Bing-Maps.png'
        };

        // Progress simulation steps
        const progressSteps = [
            { percent: 15, text: 'Getting business data from Google...' },
            { percent: 30, text: 'Taking screenshot of Google Business Profile...' },
            { percent: 45, text: 'Analyzing profile with AI...' },
            { percent: 60, text: 'Checking local citations across directories...' },
            { percent: 75, text: 'Analyzing website integration...' },
            { percent: 85, text: 'Generating smart suggestions...' },
            { percent: 95, text: 'Calculating final score...' },
            { percent: 100, text: 'Finalizing report...' }
        ];

       window.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Locality App starting...');
    
    // Check for payment success
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('payment') === 'success') {
        showToast('Payment successful! Your credits have been added.', 'success');
        // Clean up URL
        window.history.replaceState({}, document.title, window.location.pathname);
        // Refresh user data to show new credits
        if (authToken) {
            checkAuthToken();
        }
    }
    
    // Clear any stale report data on page load
    clearReportState();
    
    // Ensure report section is hidden on page load
    document.getElementById('reportSection').classList.add('hidden');
    
    // Check if user is already logged in
    console.log('🔍 Page load - Auth token exists:', !!authToken);
    if (authToken) {
        console.log('🔍 Checking authentication...');
        checkAuth();
    } else {
        console.log('🔍 No auth token, showing login...');
        showLogin();
    }
});
        // Get dynamic summary based on status
        function getDynamicSummary(factorId, status) {
            const summaries = {
                'description': {
                    'GOOD': 'Way to go! Your business description is strong and keyword relevant',
                    'NEEDS IMPROVEMENT': 'Great start, but a few small tweaks would help you rank higher!',
                    'MISSING': 'Uh oh! This is a key optimization piece you are missing, lets fix it!'
                },
                'claimed': {
                    'GOOD': 'Perfect! Your Google Business Profile is claimed and verified',
                    'NEEDS IMPROVEMENT': 'Your profile needs verification to unlock full control',
                    'MISSING': 'Critical! You need to claim your Google Business Profile immediately'
                },
                'categories': {
                    'GOOD': 'Excellent! You have comprehensive business categories set up',
                    'NEEDS IMPROVEMENT': 'Good foundation, but adding more categories will help you rank for more searches',
                    'MISSING': 'You\'re missing important categories that could bring you more customers'
                },
                'productTiles': {
                    'GOOD': 'Great job! Your product/service tiles showcase your offerings well',
                    'NEEDS IMPROVEMENT': 'You have some tiles, but adding more will give you better keyword coverage',
                    'MISSING': 'Missing opportunity! Product tiles help customers see what you offer'
                },
                'photos': {
                    'GOOD': 'Fantastic! You have plenty of high-quality photos on your profile',
                    'NEEDS IMPROVEMENT': 'You have some photos, but adding more will build more trust with customers',
                    'MISSING': 'Photos are essential for building trust - let\'s get some uploaded!'
                },
                'posts': {
                    'GOOD': 'Awesome! You\'re actively posting and engaging with customers',
                    'NEEDS IMPROVEMENT': 'You have some posts, but regular posting will boost your visibility',
                    'MISSING': 'Regular posts show Google your business is active - time to start posting!'
                },
                'qa': {
                    'GOOD': 'Perfect! Your Q&A section helps customers get answers quickly',
                    'NEEDS IMPROVEMENT': 'Some Q&As are there, but adding more common questions will help customers',
                    'MISSING': 'Q&As help answer customer questions before they call - let\'s add some!',
                    'UNCERTAIN': 'We couldn\'t clearly detect your Q&A section - it may exist but isn\'t visible'
                },
                'social': {
                    'GOOD': 'Excellent! Your social media links help customers connect with you',
                    'NEEDS IMPROVEMENT': 'You have some social links, but adding more platforms increases your reach',
                    'MISSING': 'Social media links build trust and give customers more ways to find you'
                },
                'reviews': {
                    'GOOD': 'Outstanding! Your reviews show customers love working with you',
                    'NEEDS IMPROVEMENT': 'You have reviews, but a few improvements could boost your reputation further',
                    'MISSING': 'Reviews are crucial for trust and rankings - let\'s get your review strategy going!'
                },
                'citations': {
                    'GOOD': 'Great work! You\'re listed in most major directories',
                    'NEEDS IMPROVEMENT': 'You\'re in some directories, but more citations will boost your local authority',
                    'MISSING': 'Citations help Google verify your business - let\'s get you listed in key directories'
                },
                'gbpEmbed': {
                    'GOOD': 'Perfect! Your Google Business Profile is embedded on your website',
                    'NEEDS IMPROVEMENT': 'Close! Your embed needs some optimization to work better',
                    'MISSING': 'Embedding your Google profile on your website strengthens your local SEO'
                },
                'landingPage': {
                    'GOOD': 'Excellent! You have a strong local landing page targeting your area',
                    'NEEDS IMPROVEMENT': 'You have a local page, but some tweaks could make it rank even better',
                    'MISSING': 'A local landing page helps you rank for "[service] in [city]" searches'
                }
            };
            
            return summaries[factorId]?.[status] || `${status.toLowerCase()} status for ${factorId}`;
        }

        // DEPRECATED: This function was causing fake data to persist
        // Use displayReport() with real data instead
        function showReportWithSampleData() {
            console.warn('⚠️ showReportWithSampleData() is deprecated - redirecting to dashboard');
            showDashboard();
        }

        // Navigation functions
        function showLogin() {
            hideAllSections();
            document.getElementById('loginSection').classList.remove('hidden');
        }

        function showSignup() {
            hideAllSections();
            document.getElementById('signupSection').classList.remove('hidden');
        }

        function showForgotPassword() {
            hideAllSections();
            document.getElementById('forgotPasswordSection').classList.remove('hidden');
        }

        function showDashboard() {
            hideAllSections();
            clearReportState(); // Clear any stale report data
            document.getElementById('dashboardSection').classList.remove('hidden');
            if (authToken) {
                checkAuth();
                loadUserReports();
            }
        }

        function showReportForm() {
            hideAllSections();
            clearReportState(); // Clear any stale report data
            document.getElementById('reportFormSection').classList.remove('hidden');
            
            // Clear the form when showing it
            document.getElementById('reportForm').reset();
            document.getElementById('reportError').classList.add('hidden');
            
            // Update button text based on credits
            const submitBtn = document.querySelector('#reportForm button[type="submit"]');
            if (currentUser && currentUser.creditsRemaining <= 0) {
                submitBtn.textContent = 'Generate Preview Report (Free)';
            } else {
                submitBtn.textContent = 'Generate Report (1 Credit)';
            }
        }

        function showLoading() {
            hideAllSections();
            document.getElementById('loadingSection').classList.remove('hidden');
            simulateProgress();
        }

        function showReport() {
            // Only show report if we have valid report data
            if (!currentReportData) {
                console.warn('⚠️ Attempted to show report without valid data, redirecting to dashboard');
                showDashboard();
                return;
            }
            
            hideAllSections();
            document.getElementById('reportSection').classList.remove('hidden');
        }

        function hideAllSections() {
            const sections = ['loginSection', 'signupSection', 'forgotPasswordSection', 'dashboardSection', 'reportFormSection', 'loadingSection', 'reportSection'];
            sections.forEach(id => document.getElementById(id).classList.add('hidden'));
        }

        // Enhanced progress simulation
        function simulateProgress() {
            let currentStep = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            function updateProgress() {
                if (currentStep < progressSteps.length) {
                    const step = progressSteps[currentStep];
                    progressFill.style.width = step.percent + '%';
                    progressText.textContent = step.text;
                    currentStep++;
                    
                    // Varied timing to make it feel more realistic
                    const delay = currentStep < 3 ? 3000 : (currentStep < 6 ? 8000 : 5000);
                    setTimeout(updateProgress, delay);
                }
            }
            
            updateProgress();
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            // Remove any existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide toast after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Check if user is authenticated
        async function checkAuth() {
            try {
                console.log('🔍 Making auth request...');
                const response = await fetch('/api/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateDashboard();
                    console.log('✅ User authenticated:', currentUser.firstName);
                } else {
                    console.log('❌ Token invalid (status:', response.status, '), clearing auth state...');
                    localStorage.removeItem('authToken');
                    authToken = null;
                    showLogin();
                }
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                console.log('🔄 Clearing auth state and showing login...');
                localStorage.removeItem('authToken');
                authToken = null;
                showLogin();
            }
        }

        // Update dashboard with user data
        function updateDashboard() {
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.firstName;
                document.getElementById('creditsDisplay').textContent = currentUser.creditsRemaining;
                
                // Show/hide email verification banner
                const verificationBanner = document.getElementById('emailVerificationBanner');
                if (currentUser.emailVerified) {
                    verificationBanner.classList.add('hidden');
                } else {
                    verificationBanner.classList.remove('hidden');
                }
                
                // Update report form button text if form is visible
                const submitBtn = document.querySelector('#reportForm button[type="submit"]');
                if (submitBtn) {
                    if (currentUser.creditsRemaining <= 0) {
                        submitBtn.textContent = 'Generate Preview Report (Free)';
                    } else {
                        submitBtn.textContent = 'Generate Report (1 Credit)';
                    }
                }
            }
        }

        // Resend verification email
        async function resendVerificationEmail() {
            if (!currentUser) return;
            
            try {
                const response = await fetch('/api/resend-verification', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('Verification email sent! Please check your inbox.', 'success');
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to send verification email', 'error');
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                showToast('Network error. Please try again.', 'error');
            }
        }

        // Load user's reports from the backend
        async function loadUserReports() {
            try {
                const response = await fetch('/api/user-reports', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userReports = data.reports || [];
                    displayReportsTable();
                    console.log(`📋 Loaded ${userReports.length} reports`);
                } else {
                    console.error('Failed to load reports');
                    userReports = [];
                }
            } catch (error) {
                console.error('Error loading reports:', error);
                userReports = [];
            }
        }

        // Display reports as a table
        function displayReportsTable() {
            const container = document.getElementById('reportsTableContainer');
            
            if (!userReports || userReports.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; background: #f8f9fa; border-radius: 10px;">
                        <h4>No reports yet</h4>
                        <p>Generate your first SEO audit to get started!</p>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="reports-table">
                    <thead>
                        <tr>
                            <th>Business</th>
                            <th>Score</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            userReports.forEach(report => {
                const date = new Date(report.created_at).toLocaleDateString();
                
                // Display actual score if available, otherwise show placeholder
                const score = report.score || 'N/A';
                const scoreClass = score === 'N/A' ? 'score-neutral' : 
                                 score >= 80 ? 'score-good' : 
                                 score >= 60 ? 'score-fair' : 'score-poor';
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="business-name">${report.business_name}</div>
                            <div class="business-location">${report.city} • ${report.industry}</div>
                        </td>
                        <td>
                            <div class="table-score-display ${scoreClass}">${score}${score !== 'N/A' ? '/100' : ''}</div>
                        </td>
                        <td>${date}</td>
                        <td>
                            <button class="report-action-btn view-btn" onclick="viewStoredReport(${report.id})">VIEW</button>
                            <button class="report-action-btn run-again-btn" onclick="runReportAgain('${report.business_name}', '${report.city}', '${report.industry}', '${report.website || ''}')">
                                RUN AGAIN
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        // Function to pre-fill form with previous report data
        function runReportAgain(businessName, location, industry, website) {
            showReportForm();
            
            // Pre-fill the form
            document.getElementById('businessName').value = businessName;
            document.getElementById('location').value = location;
            document.getElementById('industry').value = industry;
            document.getElementById('website').value = website;
        }

        // View a stored report - fetch the full report data
        async function viewStoredReport(reportId) {
            try {
                showToast('Loading stored report...', 'warning');
                
                const response = await fetch(`/api/reports/${reportId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to load report: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.report) {
                    // Set the current report data before displaying
                    currentReportData = data.report;
                    // Display the stored report using the existing display function
                    displayReport(data.report);
                    showReport(); // This will now have valid currentReportData
                    showToast('Stored report loaded successfully!', 'success');
                } else {
                    throw new Error('Invalid report data received');
                }
                
            } catch (error) {
                console.error('Error loading report:', error);
                showToast('Failed to load report. Please try again.', 'error');
            }
        }

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.textContent = 'Logging in...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateDashboard();
                    showDashboard();
                    showToast('Logged in successfully!', 'success');
                    console.log('✅ Login successful!');
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed. Please check your connection.';
                errorDiv.classList.remove('hidden');
                console.error('Login error:', error);
            } finally {
                submitBtn.textContent = 'Login';
                submitBtn.disabled = false;
            }
        });

        // Handle signup form submission
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const termsAgreement = document.getElementById('termsAgreement').checked;
            const errorDiv = document.getElementById('signupError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Validate terms agreement
            if (!termsAgreement) {
                errorDiv.textContent = 'You must agree to the Terms and Conditions and Privacy Policy to create an account.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ firstName, lastName, email, password })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateDashboard();
                    showDashboard();
                    showToast('Account created successfully!', 'success');
                    console.log('✅ Signup successful!');
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Signup failed. Please check your connection.';
                errorDiv.classList.remove('hidden');
                console.error('Signup error:', error);
            } finally {
                submitBtn.textContent = 'Create Account';
                submitBtn.disabled = false;
            }
        });

        // Handle forgot password form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('resetEmail').value;
            const messageDiv = document.getElementById('forgotPasswordMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.textContent = 'Sending...';
            submitBtn.disabled = true;
            messageDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = `<div class="success">${data.message}</div>`;
                    messageDiv.classList.remove('hidden');
                    e.target.reset();
                } else {
                    messageDiv.innerHTML = `<div class="error">${data.error || 'Failed to send reset link'}</div>`;
                    messageDiv.classList.remove('hidden');
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">Network error. Please try again.</div>';
                messageDiv.classList.remove('hidden');
                console.error('Forgot password error:', error);
            } finally {
                submitBtn.textContent = 'Send Reset Link';
                submitBtn.disabled = false;
            }
        });

        // Handle report form submission with proper data mapping
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const businessName = document.getElementById('businessName').value;
            const location = document.getElementById('location').value;
            const industry = document.getElementById('industry').value;
            const website = document.getElementById('website').value;
            const errorDiv = document.getElementById('reportError');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // Validate location format - must have at least one comma
            if (!location.includes(',')) {
                errorDiv.textContent = 'Please enter a valid location (e.g., "Miami, FL" or "123 Main St, Miami, FL 33101")';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            submitBtn.textContent = 'Generating Report...';
            submitBtn.disabled = true;
            errorDiv.classList.add('hidden');
            showLoading();
            
            try {
                const response = await fetch('/api/generate-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ 
                        businessName, 
                        location, 
                        industry, 
                        website 
                    })
                });

                console.log('📊 Response status:', response.status, response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('📊 Report data received successfully');
                console.log('🔍 Data keys:', Object.keys(data));
                console.log('🔍 Has auditOverview:', !!data.auditOverview);

                // More flexible validation - just check for key required fields
                if (data && data.auditOverview && data.auditOverview.overallScore && data.auditOverview.factors) {
                    console.log('✅ Report data validation passed');
                    currentReportData = data;
                    displayReport(data);
                    showReport();
                    
                    // Refresh user data and reports after generating new report
                    await checkAuth();
                    await loadUserReports();
                    
                    showToast('Report generated successfully!', 'success');
                    console.log('✅ Report displayed successfully!');
                } else {
                    console.error('❌ Report data validation failed');
                    console.log('🔍 Data structure:', JSON.stringify(data, null, 2).substring(0, 500));
                    throw new Error('Invalid report data structure received');
                }
            } catch (error) {
                console.error('Report generation error:', error);
                errorDiv.textContent = error.message || 'Failed to generate report. Please try again.';
                errorDiv.classList.remove('hidden');
                showReportForm();
                showToast('Failed to generate report. Please try again.', 'error');
            } finally {
                // Reset button text based on credits
                if (currentUser && currentUser.creditsRemaining <= 0) {
                    submitBtn.textContent = 'Generate Preview Report (Free)';
                } else {
                    submitBtn.textContent = 'Generate Report (1 Credit)';
                }
                submitBtn.disabled = false;
            }
        });

        // Simplified function to handle donut chart - NO ANIMATION
        function updateScoreDonut(score) {
            const scoreDonut = document.getElementById('scoreDonut');
            const circumference = 440;
            const offset = circumference - (circumference * score / 100);

            // Set color and offset immediately based on score
            if (score >= 90) {
                scoreDonut.style.stroke = '#27ae60';
            } else if (score >= 80) {
                scoreDonut.style.stroke = '#2ecc71';
            } else if (score >= 70) {
                scoreDonut.style.stroke = '#f1c40f';
            } else if (score >= 60) {
                scoreDonut.style.stroke = '#f39c12';
            } else {
                scoreDonut.style.stroke = '#dc3545';
            }
            
            // Set the fill immediately - no animation
            scoreDonut.style.strokeDashoffset = offset;
        }

        // Display the report with new donut chart
        function displayReport(reportData) {
            console.log('📊 Displaying single-page report:', reportData);
            console.log('📊 Data structure check:', Object.keys(reportData));
            
            // More flexible data access to handle different backend structures
            const businessData = reportData.business || reportData.businessData || {};
            const auditData = reportData.auditOverview || reportData.audit || reportData;
            const scoreData = auditData.overallScore || auditData.score || { score: 0, message: 'Report generated successfully' };
            
            // Update business info header with fallback values
            document.getElementById('reportBusinessName').textContent = 
                businessData.name || reportData.businessName || 'Business Report';
            document.getElementById('reportLocation').textContent = 
                businessData.location || reportData.location || 'Location';
            document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Update prepared by field with dynamic brand info
            const brandInfo = reportData.brandInfo || {};
            document.getElementById('reportPreparedBy').textContent = 
                brandInfo.preparedBy || 'Locality Marketing';
            
            // Update logo sources with dynamic brand logo
            if (brandInfo.logo) {
                const logoElements = document.querySelectorAll('img[alt*="Locality"]');
                logoElements.forEach(img => {
                    img.src = brandInfo.logo;
                });
            }

            // Update score with fallback
            const score = scoreData.score || reportData.finalScore || 0;
            
            document.getElementById('scoreNumber').textContent = score;
            document.getElementById('scoreMessage').textContent = 
                scoreData.message || getScoreMessage(score);

            // Animate the donut chart with the new function
            updateScoreDonut(score);

            // Display factors with fallback data
            const factors = auditData.factors || reportData.factors || generateDefaultFactors(score);
            
            // Handle locked report display
            if (reportData.isLocked) {
                displayLockedReport(factors, reportData.optimizationOpportunities || 0);
            } else {
                displayFactorsCompact(factors, reportData.smartSuggestions || {});
                
                // Display citations with fallback
                const citations = reportData.citationsAnalysis || reportData.citations || { data: { checked: [] } };
                displayCitationsRow(citations);
                
                // Display action plan with fallback
                const actionPlan = reportData.actionPlan || generateDefaultActionPlan(factors);
                displayActionPlanSimple(actionPlan);
            }
        }

        // Display locked report with blur effect and unlock overlay
        function displayLockedReport(factors, optimizationOpportunities) {
            const factorsGrid = document.getElementById('factorsGrid');
            
            // First display the factors normally (but they'll be blurred via CSS)
            displayFactorsCompact(factors, {});
            
            // Add locked class to enable blur
            factorsGrid.classList.add('factors-locked');
            
            // Create unlock overlay
            const unlockOverlay = document.createElement('div');
            unlockOverlay.className = 'unlock-report-banner';
            unlockOverlay.innerHTML = `
                <div class="unlock-banner-title">ANALYSIS COMPLETE</div>
                <div class="unlock-banner-subtitle">
                    ${optimizationOpportunities} Optimization Opportunities Found
                </div>
                <button class="unlock-btn" onclick="redirectToPricing()">
                    UNLOCK FULL REPORT
                </button>
            `;
            
            // Insert overlay into the factors container
            const factorsContainer = factorsGrid.parentElement;
            factorsContainer.style.position = 'relative';
            factorsContainer.appendChild(unlockOverlay);
            
            // Hide citations and action plan sections for locked reports
            const citationsSection = document.getElementById('citationsSection');
            const actionPlanSection = document.getElementById('actionPlanSection');
            
            if (citationsSection) {
                citationsSection.style.display = 'none';
            }
            if (actionPlanSection) {
                actionPlanSection.style.display = 'none';
            }
        }

        // Redirect to pricing page
        function redirectToPricing() {
            showPricingModal(true); // true = highlight single report option
            showToast('Please purchase credits to unlock the full report!', 'info');
        }

        // Helper function to generate score message
        function getScoreMessage(score) {
            if (score >= 90) return 'Outstanding! Your local SEO strategy is working beautifully with just minor fine-tuning needed';
            if (score >= 80) return 'Great work! You have a strong foundation with exciting opportunities to reach even more customers';
            if (score >= 70) return 'You\'re on the right track! A few focused improvements will significantly boost your visibility';
            if (score >= 60) return 'Good start! There are several valuable opportunities to enhance your local presence';
            if (score >= 40) return 'You have potential! With some focused effort, you can build a strong local presence';
            return 'Every business starts somewhere! Let\'s work together to build your local SEO success step by step';
        }

        // Helper function to generate default factors if missing
        function generateDefaultFactors(score) {
            return [
                { id: 'claimed', name: 'Claimed Profile', status: 'GOOD', message: 'Profile is claimed and verified' },
                { id: 'description', name: 'Business Description', status: score > 50 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('description', score > 50 ? 'GOOD' : 'NEEDS IMPROVEMENT') },
                { id: 'categories', name: 'Categories', status: 'GOOD', message: getDynamicSummary('categories', 'GOOD') },
                { id: 'photos', name: 'Photos', status: score > 60 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('photos', score > 60 ? 'GOOD' : 'NEEDS IMPROVEMENT') },
                { id: 'reviews', name: 'Customer Reviews', status: score > 70 ? 'GOOD' : 'NEEDS IMPROVEMENT', message: getDynamicSummary('reviews', score > 70 ? 'GOOD' : 'NEEDS IMPROVEMENT') }
            ];
        }

        // Helper function to generate default action plan
        function generateDefaultActionPlan(factors) {
            return {
                actions: [
                    { id: 'description', task: 'Optimize Business Description', completed: false },
                    { id: 'photos', task: 'Upload High-Quality Photos', completed: false },
                    { id: 'reviews', task: 'Improve Review Strategy', completed: false },
                    { id: 'citations', task: 'Build Local Citations', completed: false },
                    { id: 'posts', task: 'Start Regular Google Posts', completed: false }
                ]
            };
        }

        // Display factors in compact format with expandable details
        function displayFactorsCompact(factors, smartSuggestions) {
            const factorsGrid = document.getElementById('factorsGrid');
            
            // Clean up any previous locked state
            factorsGrid.classList.remove('factors-locked');
            const existingOverlay = factorsGrid.parentElement.querySelector('.unlock-report-banner');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Show citations and action plan sections for unlocked reports
            const citationsSection = document.getElementById('citationsSection');
            const actionPlanSection = document.getElementById('actionPlanSection');
            if (citationsSection) citationsSection.style.display = 'block';
            if (actionPlanSection) actionPlanSection.style.display = 'block';
            
            let factorsHTML = '';
            
            factors.forEach(factor => {
                const statusClass = factor.status.toLowerCase().replace(/\s+/g, '-');
                
                factorsHTML += `
                    <div class="factor-item-compact status-${statusClass}" onclick="toggleFactorExpanded('${factor.id}')">
                        <div class="factor-header-compact">
                            <div style="display: flex; align-items: center;">
                                <div class="factor-name">${factor.name}</div>
                                <span class="factor-expand-arrow">▼</span>
                            </div>
                            <span class="factor-status-badge status-${statusClass}">${factor.status}</span>
                        </div>
                        <p class="factor-message">${factor.message}</p>
                        
                        <div class="factor-expanded-content" id="expanded-${factor.id}">
                            <div class="expanded-sections">
                                <div class="expanded-section">
                                    <h4>What Is This?</h4>
                                    <p>${getFactorDescription(factor.id)}</p>
                                </div>
                                <div class="expanded-section">
                                    <h4>Why It Matters?</h4>
                                    <p>${getFactorImportance(factor.id)}</p>
                                </div>
                                <div class="expanded-section">
                                    <h4>How to fix it</h4>
                                    <p>${getFactorHowToFix(factor.id)}</p>
                                </div>
                            </div>
                            
                            ${(() => {
                                const suggestion = getSmartSuggestion(factor, smartSuggestions);
                                if (suggestion === null) return '';
                                return `
                                    <div class="smart-suggestion-section">
                                        <h4>🤖 Smart Suggestion</h4>
                                        <textarea class="suggestion-textarea" id="suggestion-${factor.id}" readonly>${suggestion}</textarea>
                                        <div class="suggestion-actions">
                                            <button class="copy-suggestion-btn" onclick="copySuggestionToClipboard('${factor.id}'); event.stopPropagation();">
                                                📋 Copy to Clipboard
                                            </button>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                `;
            });
            
            factorsGrid.innerHTML = factorsHTML;
        }

        // Toggle factor expanded view
        function toggleFactorExpanded(factorId) {
            const factorItem = document.querySelector(`#expanded-${factorId}`).closest('.factor-item-compact');
            const expandedContent = document.getElementById(`expanded-${factorId}`);
            
            // Close all other expanded factors
            document.querySelectorAll('.factor-item-compact.expanded').forEach(item => {
                if (item !== factorItem) {
                    item.classList.remove('expanded');
                    item.querySelector('.factor-expanded-content').classList.remove('show');
                }
            });
            
            // Toggle this factor
            factorItem.classList.toggle('expanded');
            expandedContent.classList.toggle('show');
        }

        // Get factor descriptions (you can expand this with all 12 factors)
        function getFactorDescription(factorId) {
            const descriptions = {
                'description': 'A short (up to 750 characters) summary that tells customers what your business does and why they should choose you.',
                'claimed': 'Verifying and claiming ownership of your Google Business Profile.',
                'categories': 'Your business\'s primary and secondary categories listed on your Google Business Profile. These are preset options provided by Google, not an open field.',
                'productTiles': 'The product/service section of your GBP where you list specific offerings with names, descriptions, and optional prices. You can include links to those offerings specific landing page.',
                'photos': 'Images displayed on your Google Business Profile, uploaded by you or your customers.',
                'posts': 'Updates you can publish on your GBP to share promotions, tips, or business news. Think of it like a mini social media feed but on your Google Profile.',
                'qa': 'A space on your profile where customers can ask questions about your business, and you (or others) can answer them.',
                'social': 'Links to your Facebook, Instagram, LinkedIn, or other social profiles listed on your GBP.',
                'reviews': 'Ratings and feedback left by customers on your Google Business Profile.',
                'citations': 'Mentions of your business name, address, and phone number (NAP) across online directories like Yelp, BBB, and YP.com. There are thousands of these sites, but getting listed in local directories, or industry specific ones, are most valuable.',
                'gbpEmbed': 'A map or widget that shows your Google listing embedded directly on your website.',
                'landingPage': 'A dedicated page on your site targeting your specific service area (e.g., Plumbing in Nashville).'
            };
            return descriptions[factorId] || 'Important aspect of your local SEO presence';
        }

        function getFactorImportance(factorId) {
            const importance = {
                'description': 'Google uses this field to understand what you offer. Including the right keywords here helps you show up in more relevant searches.',
                'claimed': 'Until it\'s claimed, you can\'t update info, respond to reviews, or optimize your listing.',
                'categories': 'Categories help Google decide which searches your business should appear in. The more accurate and complete, the better.',
                'productTiles': 'It\'s a chance to highlight all your key services and inject keyword-rich content into your profile. Most businesses skip this piece and miss out on those keyword opportunities.',
                'photos': 'Photos show Google (and customers) that you\'re active and real. They improve click-through rates and build trust.',
                'posts': 'Posts signal activity to Google and give potential customers reasons to engage. You can share discounts, new offerings or just help build your brand.',
                'qa': 'This builds trust, answers common questions up front, and adds valuable keywords to your listing.',
                'social': 'Social profiles build trust, help customers connect, and boost your visibility beyond search.',
                'reviews': 'Strong reviews don\'t just boost reputation—they impact how high you rank in local search results. Plus, customers are more likely to pick businesses with strong reviews.',
                'citations': 'Google uses consistent citations to verify your business\'s credibility and location authority. While most people don\'t go to these sites to find your business, Google does. The more directories you show up in, the more likely you are to rank higher.',
                'gbpEmbed': 'It links your site and profile together in Google\'s eyes—and helps customers easily find your business.',
                'landingPage': 'Google likes to match local intent with local content. A strong landing page improves both GBP and organic rankings. It helps local customers too!'
            };
            return importance[factorId] || 'This factor impacts your local search visibility and customer trust';
        }

        function getFactorHowToFix(factorId) {
            const howToFix = {
                'description': 'Use a strong local keyword (e.g., best cleaning service in Austin), clearly explain your core offerings, and end with a simple call to action (like "Call today for a free quote!"). <a href="https://trylocality.com/2025/07/how-to-add-or-update-your-business-description-on-google/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to update your description →</a>',
                'claimed': 'Visit google.com/business, search for your business, and follow the steps to verify it (usually by mail or phone). Once claimed, you\'ll unlock full control. <a href="https://trylocality.com/2025/07/how-to-claim-verify-ownership-of-the-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to claim your profile →</a>',
                'categories': 'Make sure your primary category is your main service (e.g., Plumber, CPA), and add at least 5-6 relevant secondary categories based on services you actually offer. <a href="https://trylocality.com/2025/07/how-to-add-or-update-your-google-business-categories/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to update your categories →</a>',
                'productTiles': 'Add 3-6 services you offer. Use names people might search (e.g., Drain Cleaning - Emergency Services), and include short, clear descriptions with benefits and keywords. <a href="https://trylocality.com/2025/07/how-to-add-product-tiles-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add product tiles →</a>',
                'photos': 'Upload at least 10 quality photos. Include: logo, interior, exterior, staff/team, and your product/service in action. Add new photos monthly to stay fresh. <a href="https://trylocality.com/2025/07/how-to-add-photos-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add photos →</a>',
                'posts': 'Post once per week. Share a tip, a testimonial, a photo of your work, or a promo. Each post should include an image, a short caption, and a clear CTA. <a href="https://trylocality.com/2025/07/how-to-add-updates-to-a-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add posts →</a>',
                'qa': 'Add 3-5 common questions yourself and answer them. Think of what people typically ask: Do you offer emergency services? What areas do you serve? <a href="https://trylocality.com/2025/07/how-to-add-qa-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add Q&A →</a>',
                'social': 'Add links to all your active profiles via your GBP dashboard. If missing, add them to your website and request a crawl or wait for them to show on Google. <a href="https://trylocality.com/2025/07/how-to-add-social-media-links-to-your-google-business-profile/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to add social links →</a>',
                'reviews': 'Aim for steady, ongoing reviews (not a sudden spike). Respond to all reviews, especially new ones, and use your review link in texts, emails, and follow-ups. <a href="https://trylocality.com/2025/07/how-to-get-more-google-reviews-and-manage-them-well/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to get more reviews →</a>',
                'citations': 'List your business on the top 8-10 directories, and ensure your NAP info is identical across all. Consider ordering citations to speed this up. <a href="https://trylocality.com/2025/07/how-to-build-local-citations-that-boost-your-google-rankings/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to build citations →</a>',
                'gbpEmbed': 'Search your business on Google Maps, click "Share," then "Embed a map." Copy the HTML code and paste it into your website\'s footer or contact page. <a href="https://trylocality.com/2025/07/how-to-embed-your-google-business-profile-on-your-website/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to embed your GBP →</a>',
                'landingPage': 'Create a page with your city name in the title and content. Include services, reviews, a map, and local references. Use your city name in headings and alt text. <a href="https://trylocality.com/2025/07/creating-a-local-landing-page-that-boosts-your-gbp-rankings/" target="_blank" style="color: #0e192b; text-decoration: none; font-weight: 600;">Learn how to create a landing page →</a>'
            };
            return howToFix[factorId] || 'Follow Google Business Profile best practices to improve this factor';
        }

        function getSmartSuggestion(factor, smartSuggestions) {
            // If the factor has GOOD status or achieved full score, hide the suggestion box
            if (factor.status === 'GOOD' || factor.score === factor.maxScore) {
                return null; // This will hide the suggestion section
            }
            
            // Factors that should NOT show smart suggestions regardless of score
            const noSuggestionFactors = ['claimed', 'photos', 'gbpEmbed', 'social'];
            if (noSuggestionFactors.includes(factor.id)) {
                return null; // This will hide the suggestion section
            }
            
            // Try to get from AI suggestions
            const suggestionKey = getSuggestionKey(factor.id);
            if (smartSuggestions && smartSuggestions.suggestions && smartSuggestions.suggestions[suggestionKey]) {
                return smartSuggestions.suggestions[suggestionKey].content;
            }
            
            // If no AI suggestion was generated (likely because score was GOOD/full points),
            // return null to hide the suggestion box entirely
            return null;
        }

        // Copy suggestion to clipboard
        function copySuggestionToClipboard(factorId) {
            // Prevent event bubbling to parent elements
            if (event) {
                event.stopPropagation();
            }
            
            const textarea = document.getElementById(`suggestion-${factorId}`);
            textarea.select();
            document.execCommand('copy');
            
            // Show feedback
            const button = event.target || event.srcElement;
            const originalText = button.textContent;
            button.textContent = '✅ Copied!';
            button.style.background = '#28a745';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 2000);
            
            showToast('Suggestion copied to clipboard!', 'success');
        }

        // Display citations in single row format
        function displayCitationsRow(citationsData) {
            const citationsRow = document.getElementById('citationsRow');
            let citationsHTML = '';
            
            citationsData.data.checked.forEach(citation => {
                const status = citation.found ? 'found' : 'missing';
                const icon = citation.found ? '✓' : '✗';
                const logoUrl = directoryLogos[citation.directory] || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiNmOGY5ZmEiLz4KPHN2ZyB4PSI2IiB5PSI2IiB3aWR0aD0iMTIiIGhlaWdodD0iMTIiPgo8cGF0aCBkPSJNNCA0TDggOE00IDhMOCA0IiBzdHJva2U9IiM2Yzc1N2QiIHN0cm9rZS13aWR0aD0iMiIvPgo8L3N2Zz4KPC9zdmc+';
                
                citationsHTML += `
                    <div class="citation-item-simple ${status}">
                        <div class="citation-logo" style="background-image: url('${logoUrl}');"></div>
                        <div class="citation-icon">${icon}</div>
                        <div class="citation-name-simple">${citation.directory}</div>
                    </div>
                `;
            });
            
            citationsRow.innerHTML = citationsHTML;
        }

        // Get suggestion key helper function
        function getSuggestionKey(factorId) {
            // Map factor IDs to suggestion keys from your backend
            const keyMapping = {
                'description': 'businessDescription',
                'categories': 'categories',
                'productTiles': 'productTiles',
                'posts': 'posts',
                'qa': 'qa',
                'reviews': 'reviews',
                'citations': 'citations',
                'landingPage': 'landingPage'
            };
            return keyMapping[factorId] || factorId;
        }

        // Toggle fix content function
        function toggleFixContent(factorId) {
            const fixContent = document.getElementById(`fix-${factorId}`);
            if (fixContent) {
                fixContent.classList.toggle('show');
            }
        }

        // Get training URL for action items
        function getActionItemTrainingUrl(actionId) {
            const trainingUrls = {
                'description': 'https://trylocality.com/2025/07/how-to-add-or-update-your-business-description-on-google/',
                'claimed': 'https://trylocality.com/2025/07/how-to-claim-verify-ownership-of-the-google-business-profile/',
                'categories': 'https://trylocality.com/2025/07/how-to-add-or-update-your-google-business-categories/',
                'productTiles': 'https://trylocality.com/2025/07/how-to-add-product-tiles-to-your-google-business-profile/',
                'photos': 'https://trylocality.com/2025/07/how-to-add-photos-to-your-google-business-profile/',
                'posts': 'https://trylocality.com/2025/07/how-to-add-updates-to-a-google-business-profile/',
                'qa': 'https://trylocality.com/2025/07/how-to-add-qa-to-your-google-business-profile/',
                'social': 'https://trylocality.com/2025/07/how-to-add-social-media-links-to-your-google-business-profile/',
                'reviews': 'https://trylocality.com/2025/07/how-to-get-more-google-reviews-and-manage-them-well/',
                'citations': 'https://trylocality.com/2025/07/how-to-build-local-citations-that-boost-your-google-rankings/',
                'gbpEmbed': 'https://trylocality.com/2025/07/how-to-embed-your-google-business-profile-on-your-website/',
                'landingPage': 'https://trylocality.com/2025/07/creating-a-local-landing-page-that-boosts-your-gbp-rankings/'
            };
            return trainingUrls[actionId] || `https://trylocality.com/blog/${actionId}`;
        }

        // Display simple action plan
        function displayActionPlanSimple(actionData) {
            const actionPlanList = document.getElementById('actionPlanList');
            let actionHTML = '';
            
            // Store action data globally for checkbox handling
            window.currentActionPlan = actionData.actions;
            
            // Load saved checkbox states from localStorage if available
            if (currentReportData && currentReportData.reportId) {
                const storageKey = `actionPlan_${currentReportData.reportId}`;
                const savedStates = localStorage.getItem(storageKey);
                if (savedStates) {
                    try {
                        const parsedStates = JSON.parse(savedStates);
                        // Merge saved states with current action plan
                        parsedStates.forEach((savedAction, index) => {
                            if (window.currentActionPlan[index]) {
                                window.currentActionPlan[index].completed = savedAction.completed;
                            }
                        });
                    } catch (e) {
                        console.error('Error loading saved action plan states:', e);
                    }
                }
            }
            
            window.currentActionPlan.forEach((action, index) => {
                const statusClass = action.completed ? 'completed' : 'incomplete';
                const checkmark = action.completed ? '✓' : '';
                const trainingUrl = getActionItemTrainingUrl(action.id);
                
                actionHTML += `
                    <div class="action-item-simple ${statusClass}" id="action-item-${index}">
                        <div class="action-checkbox" onclick="toggleActionCheckbox(${index})">${checkmark}</div>
                        <div class="action-text">
                            <span>${action.task}</span>
                            <a href="${trainingUrl}" target="_blank" class="action-arrow" title="Learn how to complete this task">↗</a>
                        </div>
                    </div>
                `;
            });
            
            actionPlanList.innerHTML = actionHTML;
        }

        // Toggle action checkbox
        function toggleActionCheckbox(index) {
            if (!window.currentActionPlan) return;
            
            // Toggle the completed status
            window.currentActionPlan[index].completed = !window.currentActionPlan[index].completed;
            
            // Update the UI
            const actionItem = document.getElementById(`action-item-${index}`);
            const checkbox = actionItem.querySelector('.action-checkbox');
            
            if (window.currentActionPlan[index].completed) {
                actionItem.classList.remove('incomplete');
                actionItem.classList.add('completed');
                checkbox.textContent = '✓';
            } else {
                actionItem.classList.remove('completed');
                actionItem.classList.add('incomplete');
                checkbox.textContent = '';
            }
            
            // Save to localStorage if we have a report ID
            if (currentReportData && currentReportData.reportId) {
                const storageKey = `actionPlan_${currentReportData.reportId}`;
                localStorage.setItem(storageKey, JSON.stringify(window.currentActionPlan));
            }
        }
        
        // Order citations function
        function orderCitations() {
            window.open('https://trylocality.com/citations', '_blank');
        }

        // Detailed Citation Analysis function
        async function runDetailedCitationAnalysis() {
            const button = document.getElementById('detailedAnalysisBtn');
            const loading = document.getElementById('detailedLoading');
            const resultsContainer = document.getElementById('detailedResultsContainer');
            
            // Show loading state
            button.disabled = true;
            button.textContent = 'ANALYZING...';
            loading.style.display = 'block';
            resultsContainer.style.display = 'none';
            
            try {
                // Get business data from current report
                const businessName = currentReportData?.businessName || '';
                const location = currentReportData?.location || '';
                
                if (!businessName || !location) {
                    throw new Error('Business information not available');
                }
                
                // Make API call
                const response = await fetch('/api/detailed-citation-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        businessName,
                        location
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Analysis failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                displayDetailedResults(data);
                
            } catch (error) {
                console.error('Detailed analysis error:', error);
                alert('Failed to run detailed citation analysis. Please try again.');
            } finally {
                // Reset button state
                button.disabled = false;
                button.textContent = 'RUN DETAILED CITATION ANALYSIS';
                loading.style.display = 'none';
            }
        }
        
        // Display detailed citation results
        function displayDetailedResults(data) {
            const resultsContainer = document.getElementById('detailedResultsContainer');
            const scoreElement = document.getElementById('detailedScore');
            const gridElement = document.getElementById('detailedResultsGrid');
            
            // Update score display - combine with essential citations score
            const essentialScore = currentReportData?.citations?.stats?.found || 0;
            const totalFound = essentialScore + data.summary.found;
            scoreElement.textContent = `${totalFound} out of 50`;
            
            // Clear and populate grid
            gridElement.innerHTML = '';
            
            // Create rows of 10 items each
            for (let i = 0; i < data.results.length; i += 10) {
                const row = document.createElement('div');
                row.className = 'detailed-results-row';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = 'repeat(10, 1fr)';
                row.style.gap = '8px';
                row.style.marginBottom = '8px';
                
                for (let j = i; j < Math.min(i + 10, data.results.length); j++) {
                    const result = data.results[j];
                    const item = document.createElement('div');
                    item.className = `detailed-result-item ${result.status.toLowerCase()}`;
                    
                    const statusIcon = result.found ? '✅' : result.status === 'ERROR' ? '⚠️' : '❌';
                    
                    item.innerHTML = `
                        <span class="detailed-result-name">${result.name}</span>
                        <span class="detailed-result-status">${statusIcon}</span>
                    `;
                    
                    row.appendChild(item);
                }
                
                gridElement.appendChild(row);
            }
            
            // Show results
            resultsContainer.style.display = 'block';
        }

        // Buy credits function
        function buyCredits() {
            showPricingModal();
        }

        // Download PDF function
        function downloadPDF() {
            // Hide non-printable elements
            const elementsToHide = document.querySelectorAll('.btn, .report-actions, .how-to-fix-btn');
            elementsToHide.forEach(el => el.style.display = 'none');
            
            // Trigger print
            window.print();
            
            // Restore elements after print
            setTimeout(() => {
                elementsToHide.forEach(el => el.style.display = '');
            }, 1000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            userReports = [];
            showLogin();
            showToast('Logged out successfully', 'success');
            console.log('👋 User logged out');
        }

        // Feedback Form Functions
        function showFeedbackForm() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            document.getElementById('feedbackModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeFeedbackForm() {
            document.getElementById('feedbackModal').classList.remove('show');
            document.getElementById('feedbackModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset form
            document.getElementById('feedbackForm').reset();
            document.getElementById('feedbackRating').value = '';
            document.querySelectorAll('.star').forEach(star => star.classList.remove('active'));
            document.getElementById('feedbackError').classList.add('hidden');
            document.getElementById('feedbackSuccess').classList.add('hidden');
        }

        // Star rating functionality
        document.addEventListener('DOMContentLoaded', function() {
            const stars = document.querySelectorAll('.star');
            const ratingInput = document.getElementById('feedbackRating');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    ratingInput.value = rating;
                    
                    // Update star display
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
                
                star.addEventListener('mouseleave', function() {
                    const currentRating = parseInt(ratingInput.value) || 0;
                    stars.forEach((s, i) => {
                        if (i < currentRating) {
                            s.style.color = '#ffc107';
                        } else {
                            s.style.color = '#ddd';
                        }
                    });
                });
            });
            
            // Handle feedback form submission
            document.getElementById('feedbackForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const rating = document.getElementById('feedbackRating').value;
                const type = document.getElementById('feedbackType').value;
                const message = document.getElementById('feedbackMessage').value;
                const email = document.getElementById('feedbackEmail').value;
                const errorDiv = document.getElementById('feedbackError');
                const successDiv = document.getElementById('feedbackSuccess');
                const submitBtn = e.target.querySelector('button[type="submit"]');
                
                // Validate required fields
                if (!rating) {
                    errorDiv.textContent = 'Please select a star rating';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!type) {
                    errorDiv.textContent = 'Please select a feedback type';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                if (!message.trim()) {
                    errorDiv.textContent = 'Please enter your feedback';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                // Clear previous messages
                errorDiv.classList.add('hidden');
                successDiv.classList.add('hidden');
                
                // Disable submit button
                submitBtn.textContent = 'Submitting...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            rating: parseInt(rating),
                            type,
                            message: message.trim(),
                            email: email.trim() || null,
                            reportData: currentReportData ? {
                                businessName: currentReportData.businessName,
                                location: currentReportData.location,
                                industry: currentReportData.industry
                            } : null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        successDiv.textContent = 'Thank you for your feedback! We appreciate your input.';
                        successDiv.classList.remove('hidden');
                        
                        // Reset form after successful submission
                        setTimeout(() => {
                            closeFeedbackForm();
                        }, 2000);
                    } else {
                        errorDiv.textContent = result.error || 'Failed to submit feedback. Please try again.';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Feedback submission error:', error);
                    errorDiv.textContent = 'Network error. Please check your connection and try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    // Re-enable submit button
                    submitBtn.textContent = 'Submit Feedback';
                    submitBtn.disabled = false;
                }
            });
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('feedbackModal');
            if (event.target === modal) {
                closeFeedbackForm();
            }
            
            const pricingModal = document.getElementById('pricingModal');
            if (event.target === pricingModal) {
                closePricingModal();
            }
        });

        // Pricing Modal Functions
        function showPricingModal(highlightSingle = false) {
            document.getElementById('pricingModal').classList.remove('hidden');
            document.getElementById('pricingModal').classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Highlight single report if coming from preview
            if (highlightSingle) {
                const singleCard = document.querySelector('.pricing-card-modal:first-child');
                singleCard.classList.add('highlight-animation');
                setTimeout(() => {
                    singleCard.classList.remove('highlight-animation');
                }, 1000);
            }
        }

        function closePricingModal() {
            document.getElementById('pricingModal').classList.remove('show');
            document.getElementById('pricingModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Check if user is logged in
        function checkAuthForPricing() {
            const token = getAuthToken();
            if (!token) {
                showToast('Please log in to purchase credits', 'warning');
                showLogin();
                return false;
            }
            return true;
        }

        // Pricing modal specific functions
        async function purchaseSingleReportModal() {
            if (!checkAuthForPricing()) return;
            
            try {
                showToast('Redirecting to checkout...', 'info');
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ priceType: 'oneTime' })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.location.href = data.url;
                } else {
                    showToast(data.error || 'Failed to create checkout session', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to process checkout. Please try again.', 'error');
            }
        }

        async function subscribePlanModal(plan) {
            if (!checkAuthForPricing()) return;
            
            try {
                showToast('Redirecting to checkout...', 'info');
                
                const response = await fetch('/api/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ priceType: plan })
                });
                
                const data = await response.json();
                
                if (response.ok && data.url) {
                    window.location.href = data.url;
                } else {
                    showToast(data.error || 'Failed to create checkout session', 'error');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                showToast('Failed to process checkout. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>